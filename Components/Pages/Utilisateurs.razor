@page "/utilisateurs"
@using PNC.Models
@using PNC.Services
@inject IUtilisateurService UtilisateurService
@inject IRoleService RoleService
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime

<PageTitle>Gestion des Utilisateurs - PNC</PageTitle>

<div class="utilisateurs-page">
    <!-- Header -->
    <div class="page-header">
        <div class="header-content">
            <h1 class="page-title">
                <i class="bi bi-people-fill me-3"></i>
                Gestion des Utilisateurs
            </h1>
            <p class="page-subtitle">
                Administration des comptes utilisateurs et des rôles
            </p>
        </div>
        <div class="header-actions">
            <button class="btn-modern btn-primary" @onclick="RedictToAjout">
                <i class="bi bi-person-plus"></i>
                Nouvel Utilisateur
            </button>
            <button class="btn-modern btn-outline" @onclick="OuvrirModalRole">
                <i class="bi bi-shield-plus"></i>
                Nouveau Rôle
            </button>
        </div>
    </div>

    <!-- Filtres et Recherche -->
    <div class="filters-section">
        <div class="search-box">
            <div class="search-input-group">
                <i class="bi bi-search search-icon"></i>
                <input type="text" 
                       @bind="searchTerm" 
                       @bind:event="oninput"
                       @onkeyup="RechercherUtilisateurs"
                       placeholder="Rechercher par nom, prénom, nom d'utilisateur ou email..."
                       class="search-input" />
                <button class="btn-search" @onclick="RechercherUtilisateurs">
                    <i class="bi bi-search"></i>
                </button>
            </div>
        </div>
        
        <div class="filter-controls">
            <select @bind="selectedRole" @bind:after="FiltrerParRole" class="filter-select">
                <option value="">Tous les rôles</option>
                @if (roles?.Any() == true)
                {
                    @foreach (var role in roles)
                    {
                        <option value="@role.Id">@role.Nom</option>
                    }
                }
            </select>
            
            <select @bind="selectedStatus" @bind:after="FiltrerParStatus" class="filter-select">
                <option value="">Tous les statuts</option>
                <option value="true">Actifs</option>
                <option value="false">Inactifs</option>
            </select>
            
            <button class="btn-modern btn-outline" @onclick="ReinitialiserFiltres">
                <i class="bi bi-arrow-clockwise"></i>
                Réinitialiser
            </button>
        </div>
    </div>

    

    <!-- Tableau des Utilisateurs -->
    <div class="table-container">
        <div class="table-header">
            <h3>Liste des Utilisateurs</h3>
            <div class="table-actions">
                <span class="results-count">@utilisateursFiltres.Count() résultat(s)</span>
            </div>
        </div>
        
        @if (utilisateursFiltres?.Any() == true)
        {
            <div class="table-responsive">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Utilisateur</th>
                            <th>Nom d'utilisateur</th>
                            <th>Email</th>
                            <th>Téléphone</th>
                            <th>Rôle</th>
                            <th>Statut</th>
                            <th>Dernière connexion</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var utilisateur in utilisateursFiltres.Skip((currentPage - 1) * pageSize).Take(pageSize))
                        {
                            <tr class="@(utilisateur.EstActif ? "" : "inactive-row")">
                                <td>
                                    <div class="user-info">
                                        <div class="user-avatar">
                                            <i class="bi bi-person-circle"></i>
                                        </div>
                                        <div class="user-details">
                                            <div class="user-name">@utilisateur.Nom @utilisateur.Prenom</div>
                                            <div class="user-id">ID: @utilisateur.Id</div>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <span class="username">@utilisateur.NomUtilisateur</span>
                                </td>
                                <td>
                                    @if (!string.IsNullOrEmpty(utilisateur.Email))
                                    {
                                        <span class="email">@utilisateur.Email</span>
                                    }
                                    else
                                    {
                                        <span class="no-email">Non renseigné</span>
                                    }
                                </td>
                                <td>
                                    @if (!string.IsNullOrEmpty(utilisateur.Telephone))
                                    {
                                        <span class="phone">@utilisateur.Telephone</span>
                                    }
                                    else
                                    {
                                        <span class="no-phone">Non renseigné</span>
                                    }
                                </td>
                                <td>
                                    @if (utilisateur.IdRoleNavigation != null)
                                    {
                                        <span class="role-badge">@utilisateur.IdRoleNavigation.Nom</span>
                                    }
                                    else
                                    {
                                        <span class="no-role">Aucun rôle</span>
                                    }
                                </td>
                                <td>
                                    <span class="status-badge @(utilisateur.EstActif ? "active" : "inactive")">
                                        @(utilisateur.EstActif ? "Actif" : "Inactif")
                                    </span>
                                </td>
                                <td>
                                    @if (utilisateur.DerniereConnexion.HasValue)
                                    {
                                        <span class="last-login">@utilisateur.DerniereConnexion.Value.ToString("dd/MM/yyyy HH:mm")</span>
                                    }
                                    else
                                    {
                                        <span class="never-login">Jamais connecté</span>
                                    }
                                </td>
                                <td>
                                    <div class="action-buttons">
                                        <button class="btn-action btn-edit" @onclick="() => ModifierUtilisateur(utilisateur)" title="Modifier">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button class="btn-action btn-view" @onclick="() => VoirUtilisateur(utilisateur)" title="Voir">
                                            <i class="bi bi-eye"></i>
                                        </button>
                                        @if (utilisateur.EstActif)
                                        {
                                            <button class="btn-action btn-deactivate" @onclick="() => DesactiverUtilisateur(utilisateur.Id)" title="Désactiver">
                                                <i class="bi bi-person-x"></i>
                                            </button>
                                        }
                                        else
                                        {
                                            <button class="btn-action btn-activate" @onclick="() => ActiverUtilisateur(utilisateur.Id)" title="Activer">
                                                <i class="bi bi-person-check"></i>
                                            </button>
                                        }
                                        <button class="btn-action btn-password" @onclick="() => ResetMotDePasse(utilisateur.Id)" title="Reset mot de passe">
                                            <i class="bi bi-key"></i>
                                        </button>
                                        <button class="btn-action btn-delete" @onclick="() => SupprimerUtilisateur(utilisateur.Id)" title="Supprimer">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
            
            <!-- Pagination -->
            @if (totalPages > 1)
            {
                <div class="pagination">
                    <button class="btn-page @(currentPage == 1 ? "disabled" : "")" 
                            @onclick="() => ChangerPage(currentPage - 1)" 
                            disabled="@(currentPage == 1)">
                        <i class="bi bi-chevron-left"></i>
                    </button>
                    
                    @for (int i = Math.Max(1, currentPage - 2); i <= Math.Min(totalPages, currentPage + 2); i++)
                    {
                        <button class="btn-page @(i == currentPage ? "active" : "")" @onclick="() => ChangerPage(i)">
                            @i
                        </button>
                    }
                    
                    <button class="btn-page @(currentPage == totalPages ? "disabled" : "")" 
                            @onclick="() => ChangerPage(currentPage + 1)" 
                            disabled="@(currentPage == totalPages)">
                        <i class="bi bi-chevron-right"></i>
                    </button>
                </div>
            }
        }
        else
        {
            <div class="no-data">
                <i class="bi bi-people"></i>
                <h3>Aucun utilisateur trouvé</h3>
                <p>@(string.IsNullOrEmpty(searchTerm) ? "Aucun utilisateur dans le système." : $"Aucun utilisateur ne correspond à la recherche '{searchTerm}'.")</p>
                @if (!string.IsNullOrEmpty(searchTerm))
                {
                    <button class="btn-modern btn-outline" @onclick="ReinitialiserFiltres">
                        Réinitialiser la recherche
                    </button>
                }
            </div>
        }
    </div>
</div>

<!-- Modal de confirmation de suppression -->
@if (showDeleteModal)
{
    <div class="modal-overlay" @onclick="FermerModal">
        <div class="modal-content" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="bi bi-person-exclamation text-warning"></i>
                    Confirmer la suppression
                </h3>
                <button class="modal-close" @onclick="FermerModal">
                    <i class="bi bi-x"></i>
                </button>
            </div>
            
            <div class="modal-body">
                <p>Êtes-vous sûr de vouloir supprimer l'utilisateur <strong>@utilisateurToDelete?.Nom @utilisateurToDelete?.Prenom</strong> ?</p>
                <div class="warning-message">
                    <i class="bi bi-exclamation-triangle"></i>
                    <span>Cette action est irréversible et supprimera définitivement l'utilisateur et toutes ses données associées.</span>
                </div>
            </div>
            
            <div class="modal-footer">
                <button class="btn-modern btn-outline" @onclick="FermerModal">
                    <i class="bi bi-x-circle"></i>
                    Annuler
                </button>
                <button class="btn-modern btn-danger" @onclick="ConfirmerSuppression" disabled="@isDeleting">
                    <i class="bi bi-trash"></i>
                    @if (isDeleting)
                    {
                        <span>Suppression en cours...</span>
                    }
                    else
                    {
                        <span>Supprimer définitivement</span>
                    }
                </button>
            </div>
        </div>
    </div>
}

@code {
    // Données
    private List<Utilisateur> utilisateurs = new();
    private IEnumerable<Utilisateur> utilisateursFiltres = new List<Utilisateur>();
    private List<Role> roles = new();
    
    // Variables pour le modal de suppression
    private bool showDeleteModal = false;
    private Utilisateur? utilisateurToDelete = null;
    private bool isDeleting = false;
    
    // Filtres
    private string searchTerm = "";
    private string selectedRole = "";
    private string selectedStatus = "";
    
    // Pagination
    private int currentPage = 1;
    private int pageSize = 20;
    private int totalPages => (int)Math.Ceiling((double)utilisateursFiltres.Count() / pageSize);
    
    // Statistiques
    private int totalUtilisateurs = 0;
    private int utilisateursActifs = 0;
    private int utilisateursInactifs = 0;
    private int totalRoles = 0;
    
    protected override async Task OnInitializedAsync()
    {
        await ChargerDonnees();
    }
    
    private async Task ChargerDonnees()
    {
        try
        {
            // Charger les utilisateurs et rôles en parallèle
            var taskUtilisateurs = UtilisateurService.GetAllUtilisateursAsync();
            var taskRoles = RoleService.GetAllRolesAsync();
            
            await Task.WhenAll(taskUtilisateurs, taskRoles);
            
            utilisateurs = await taskUtilisateurs;
            roles = await taskRoles;
            
            // Appliquer les filtres
            AppliquerFiltres();
            
            // Calculer les statistiques
            CalculerStatistiques();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Erreur lors du chargement des données: {ex.Message}");
        }
    }
    
    private void AppliquerFiltres()
    {
        utilisateursFiltres = utilisateurs.AsEnumerable();
        
        // Filtre par recherche
        if (!string.IsNullOrWhiteSpace(searchTerm))
        {
            utilisateursFiltres = utilisateursFiltres.Where(u =>
                u.Nom.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
                u.Prenom.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
                u.NomUtilisateur.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
                (u.Email?.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ?? false)
            );
        }
        
        // Filtre par rôle
        if (!string.IsNullOrEmpty(selectedRole))
        {
            utilisateursFiltres = utilisateursFiltres.Where(u => u.IdRole == selectedRole);
        }
        
        // Filtre par statut
        if (!string.IsNullOrEmpty(selectedStatus))
        {
            var status = bool.Parse(selectedStatus);
            utilisateursFiltres = utilisateursFiltres.Where(u => u.EstActif == status);
        }
        
        // Réinitialiser la page courante
        currentPage = 1;
    }
    
    private void CalculerStatistiques()
    {
        totalUtilisateurs = utilisateurs.Count;
        utilisateursActifs = utilisateurs.Count(u => u.EstActif);
        utilisateursInactifs = utilisateurs.Count(u => !u.EstActif);
        totalRoles = roles.Count;
    }
    
    private async Task RechercherUtilisateurs()
    {
        AppliquerFiltres();
        await Task.CompletedTask;
    }
    
    private async Task FiltrerParRole()
    {
        AppliquerFiltres();
        await Task.CompletedTask;
    }
    
    private async Task FiltrerParStatus()
    {
        AppliquerFiltres();
        await Task.CompletedTask;
    }
    
    private void ReinitialiserFiltres()
    {
        searchTerm = "";
        selectedRole = "";
        selectedStatus = "";
        AppliquerFiltres();
    }
    
    private void ChangerPage(int page)
    {
        if (page >= 1 && page <= totalPages)
        {
            currentPage = page;
        }
    }
    
    // Méthodes à implémenter
    private void RedictToAjout() 
    {
        Navigation.NavigateTo("/utilisateurs/ajouter");
    }
    
    private void OuvrirModalRole() 
    {
        // TODO: Implémenter l'ouverture du modal de rôle
        Console.WriteLine("Modal de rôle à implémenter");
    }
    
    private void ModifierUtilisateur(Utilisateur utilisateur) 
    {
        Navigation.NavigateTo($"/utilisateurs/modifier/{utilisateur.Id}");
    }
    
    private void VoirUtilisateur(Utilisateur utilisateur) 
    {
        // Pour l'instant, rediriger vers la modification (on peut créer une page de vue plus tard)
        Navigation.NavigateTo($"/utilisateurs/modifier/{utilisateur.Id}");
    }
    
    private async Task ActiverUtilisateur(string id) 
    {
        try
        {
            await UtilisateurService.ActiverUtilisateurAsync(id);
            await ChargerDonnees();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Erreur lors de l'activation: {ex.Message}");
        }
    }
    
    private async Task DesactiverUtilisateur(string id) 
    {
        try
        {
            await UtilisateurService.DesactiverUtilisateurAsync(id);
            await ChargerDonnees();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Erreur lors de la désactivation: {ex.Message}");
        }
    }
    
    private void ResetMotDePasse(string id) 
    {
        // TODO: Implémenter le reset du mot de passe
        Console.WriteLine($"Reset mot de passe pour l'utilisateur {id}");
    }
    
    private async Task SupprimerUtilisateur(string id) 
    {
        try
        {
            // Trouver l'utilisateur à supprimer pour afficher son nom dans le modal
            var utilisateur = utilisateurs?.FirstOrDefault(u => u.Id == id);
            if (utilisateur != null)
            {
                utilisateurToDelete = utilisateur;
                showDeleteModal = true;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Erreur lors de l'ouverture du modal de suppression: {ex.Message}");
        }
    }
    
    private async Task ConfirmerSuppression()
    {
        if (utilisateurToDelete == null) return;

        isDeleting = true;
        
        try
        {
            // TODO: Implémenter la suppression réelle de l'utilisateur
            // var success = await UtilisateurService.DeleteUtilisateurAsync(utilisateurToDelete.Id);
            // if (success)
            // {
            //     await ChargerDonnees();
            //     FermerModal();
            // }
           var success = await UtilisateurService.DeleteUtilisateurAsync(utilisateurToDelete.Id);
           
            if (success)
            {
                await ChargerDonnees();
                FermerModal();
            }
            else
            {
                Console.WriteLine("Erreur lors de la suppression de l'utilisateur");
            }
            // Pour l'instant, simuler la suppression
            
            Console.WriteLine($"Suppression de l'utilisateur {utilisateurToDelete.Id}");
            await Task.Delay(1000); // Simulation d'un délai
            FermerModal();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Erreur lors de la suppression de l'utilisateur: {ex.Message}");
        }
        finally
        {
            isDeleting = false;
        }
    }
    
    private void FermerModal()
    {
        showDeleteModal = false;
        utilisateurToDelete = null;
        isDeleting = false;
    }
}

