@page "/policiers/capture-photo/{PolicierId}"
@using Microsoft.EntityFrameworkCore
@using PNC.Data
@using PNC.Models
@using PNC.Services
@inject IDbContextFactory<BdPolicePncContext> DbFactory
@inject IJSRuntime JSRuntime
@inject NavigationManager Navigation
@inject IPhotoService PhotoService
@implements IAsyncDisposable

<PageTitle>Capture Photo - Policier @PolicierId - PNC</PageTitle>

<!-- Cropper.js CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">

<!-- Cropper.js JavaScript -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

<div class="capture-photo-page">
    <!-- Header -->
    <div class="page-header">
        <div class="header-content">
            <h1 class="page-title">
                <i class="bi bi-camera-video-fill me-3"></i>
                Capture Photo
            </h1>
            @if (policier != null)
            {
                <p class="page-subtitle">
                    @policier.Nom @policier.PostNom @policier.Prenom - Matricule: @policier.Matricule
                </p>
            }
        </div>
        <div class="header-actions">
            <button class="btn-modern btn-outline" @onclick="GoBack">
                <i class="bi bi-arrow-left"></i>
                Retour
            </button>
        </div>
    </div>

    <!-- Messages d'√©tat -->
    @if (!string.IsNullOrEmpty(successMessage))
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="bi bi-check-circle me-2"></i>
            @successMessage
            <button type="button" class="btn-close" @onclick="() => successMessage = null"></button>
        </div>
    }
    
    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-triangle me-2"></i>
            @errorMessage
            <button type="button" class="btn-close" @onclick="() => errorMessage = null"></button>
        </div>
    }

    @if (isLoading)
    {
        <div class="loading-container">
            <div class="loading-card">
                <div class="spinner"></div>
                <p>Chargement de la cam√©ra...</p>
            </div>
        </div>
    }
    else if (policier == null)
    {
        <div class="error-container">
            <div class="error-card">
                <i class="bi bi-exclamation-triangle"></i>
                <h3>Policier non trouv√©</h3>
                <p>Le policier demand√© n'existe pas ou a √©t√© supprim√©.</p>
                <button class="btn-modern btn-primary" @onclick="GoBack">
                    <i class="bi bi-arrow-left"></i>
                    Retour √† la liste
                </button>
            </div>
        </div>
    }
    else
    {
        <!-- Main Content Grid -->
        <div class="main-content-grid">
            <!-- Section cam√©ra -->
            <div class="camera-card" id="cameraSection">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="bi bi-camera-video"></i>
                        Cam√©ra
                    </h3>
                    @if (isCameraActive)
                    {
                        <span class="status-badge status-active">
                            <i class="bi bi-circle-fill"></i> 
                            Cam√©ra @(currentCameraIndex + 1) active
                        </span>
                    }
                </div>
                <div class="camera-video-container @(isCameraActive ? "active" : "")">
                    <video id="video" autoplay playsinline></video>
                </div>
                <div class="card-actions">
                    <button class="btn-modern btn-primary" @onclick="StartCamera" disabled="@isCameraActive">
                        <i class="bi bi-camera-video"></i> 
                        @if (isCameraActive)
                        {
                            <span>Cam√©ra activ√©e</span>
                        }
                        else
                        {
                            <span>Activer la cam√©ra</span>
                        }
                    </button>
                    <button class="btn-modern btn-info" @onclick="ToggleCameraSelection" disabled="@isCameraActive">
                        <i class="bi bi-gear"></i> 
                        @if (showCameraSelection)
                        {
                            <span>Masquer les options</span>
                        }
                        else
                        {
                            <span>Choisir la cam√©ra</span>
                        }
                    </button>
                    <button class="btn-modern btn-success" @onclick="TakePhoto" disabled="@(!isCameraActive)">
                        <i class="bi bi-camera-fill"></i> Prendre une photo
                    </button>
                    <button class="btn-modern btn-secondary" @onclick="StopCamera" disabled="@(!isCameraActive)">
                        <i class="bi bi-stop-circle"></i> Arr√™ter la cam√©ra
                    </button>
                </div>
                
                @if (showCameraSelection)
                {
                    <div class="camera-selection">
                        <h5><i class="bi bi-camera-video"></i> S√©lection de la cam√©ra</h5>
                        @if (availableCameras.Any())
                        {
                            <div class="camera-select-container">
                                <label for="cameraSelect" class="camera-select-label">
                                    <i class="bi bi-camera-video"></i>
                                    Choisir une cam√©ra :
                                </label>
                                <select id="cameraSelect" 
                                        class="camera-select" 
                                        @bind="selectedCameraId">
                                    @foreach (var camera in availableCameras)
                                    {
                                        <option value="@camera.DeviceId">
                                            @if (string.IsNullOrEmpty(camera.Label))
                                            {
                                                <text>Cam√©ra @(availableCameras.IndexOf(camera) + 1)</text>
                                            }
                                            else
                                            {
                                                <text>@camera.Label</text>
                                            }
                                        </option>
                                    }
                                </select>
                            </div>
                            <div class="camera-actions">
                                <button class="btn-modern btn-primary btn-sm" @onclick="SwitchCamera" disabled="@(!isCameraActive)">
                            <i class="bi bi-arrow-repeat"></i> Changer de cam√©ra
                        </button>
                                <button class="btn-modern btn-secondary btn-sm" @onclick="LoadAvailableCameras">
                                    <i class="bi bi-arrow-clockwise"></i> Actualiser
                                </button>
                            </div>
                        }
                        else
                        {
                            <div class="no-cameras">
                                <i class="bi bi-exclamation-triangle"></i>
                                <p>Aucune cam√©ra d√©tect√©e. V√©rifiez que votre cam√©ra est connect√©e et autoris√©e.</p>
                                <button class="btn-modern btn-primary btn-sm" @onclick="LoadAvailableCameras">
                                    <i class="bi bi-arrow-clockwise"></i> R√©essayer
                                </button>
                </div>
                        }
                    </div>
                }
            </div>
            
            <!-- Section photo prise avec recadrage -->
            <div class="photo-card" id="photoSection" style="display:none;">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="bi bi-image-fill"></i>
                        Photo et Recadrage
                    </h3>
                </div>
                
                <div class="photo-layout">
                    <!-- Colonne gauche : Photo originale avec contr√¥les -->
                    <div class="photo-original-column">
                        <h4 class="section-title">
                            <i class="bi bi-image-fill"></i> Photo captur√©e
                        </h4>
                        <div class="photo-container">
                            @if (!string.IsNullOrEmpty(currentPhotoData))
                            {
                                <img id="photo" src="@currentPhotoData" alt="Photo captur√©e" />
                            }
                            else
                            {
                                <div class="photo-placeholder">
                                    <i class="bi bi-image"></i>
                                    <p>Aucune photo captur√©e</p>
                                </div>
                            }
                        </div>
                        <div class="card-actions">
                            <button class="btn-modern btn-secondary" @onclick="ApplyCrop">
                                <i class="bi bi-scissors"></i> Rogner
                            </button>
                            <button class="btn-modern btn-warning" @onclick="ApplyCropFinal" disabled="@(!showCropper)">
                                <i class="bi bi-check-circle"></i> Appliquer le recadrage
                            </button>
                            <button class="btn-modern btn-success" @onclick="SavePhoto">
                                <i class="bi bi-check-circle-fill"></i> Sauvegarder
                            </button>
                            <button class="btn-modern btn-outline" @onclick="RetakePhoto">
                                <i class="bi bi-arrow-clockwise"></i> Reprendre
                            </button>
                            <button class="btn-modern btn-info" @onclick="DownloadPhoto" style="display:none;" id="downloadBtn">
                                <i class="bi bi-download"></i> T√©l√©charger
                            </button>
                        </div>
                    </div>
                    
                    <!-- Colonne droite : R√©sultat du recadrage -->
                    <div class="photo-result-column">
                        <h4 class="section-title">
                            <i class="bi bi-crop"></i> R√©sultat du recadrage
                        </h4>
                        <div class="result-container" id="resultSection" style="display:none;">
                            <div class="cropped-image-container">
                                @if (!string.IsNullOrEmpty(currentPhotoData))
                                {
                                    <img id="croppedResult" src="@currentPhotoData" alt="Image rogn√©e" />
                                }
                                else
                                {
                                    <div class="photo-placeholder">
                                        <i class="bi bi-crop"></i>
                                        <p>R√©sultat du recadrage</p>
                                    </div>
                                }
                            </div>
                            <div class="crop-info">
                                <i class="bi bi-info-circle-fill"></i> 
                                <span id="cropDimensions">Dimensions: -- x -- px</span>
                            </div>
                            <div class="card-actions">
                                <button class="btn-modern btn-success" @onclick="SaveCroppedPhoto">
                                    <i class="bi bi-save"></i> Sauvegarder cette partie
                                </button>
                                <button class="btn-modern btn-secondary" @onclick="ReturnToOriginalPhoto">
                                    <i class="bi bi-arrow-left-circle"></i> Revenir √† la cam√©ra
                                </button>
                                <button class="btn-modern btn-outline" @onclick="CancelCrop">
                                    <i class="bi bi-x-circle"></i> Annuler
                                </button>
                            </div>
                        </div>
                        <div class="crop-instructions" id="cropInstructions">
                            <i class="bi bi-lightbulb-fill"></i>
                            <p>S√©lectionnez la zone √† rogner sur la photo de gauche</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }

    <!-- Modal de s√©lection de cam√©ra -->
    @if (showCameraModal)
    {
        <div class="modal-backdrop show" style="display: block;"></div>
        <div class="modal show" style="display: block;" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="bi bi-camera-video"></i>
                            S√©lection de la cam√©ra
                        </h5>
                    </div>
                    <div class="modal-body">
                        <p class="mb-3">Choisissez la cam√©ra que vous souhaitez utiliser :</p>
                        
                        @if (availableCameras.Any())
                        {
                            <div class="camera-modal-list">
                                @foreach (var camera in availableCameras)
                                {
                                    <div class="camera-modal-option @(camera.DeviceId == selectedCameraId ? "selected" : "")"
                                         @onclick="@(() => selectedCameraId = camera.DeviceId)">
                                        <div class="camera-info">
                                            <i class="bi bi-camera-video"></i>
                                            <div class="camera-details">
                                                @if (string.IsNullOrEmpty(camera.Label))
                                                {
                                                    <span class="camera-name">Cam√©ra @(availableCameras.IndexOf(camera) + 1)</span>
                                                }
                                                else
                                                {
                                                    <span class="camera-name">@camera.Label</span>
                                                }
                                                <small class="camera-id">ID: @camera.DeviceId.Substring(0, 8)...</small>
                                            </div>
                                        </div>
                                        @if (camera.DeviceId == selectedCameraId)
                                        {
                                            <i class="bi bi-check-circle-fill text-primary"></i>
                                        }
                                    </div>
                                }
                            </div>
                        }
                        else
                        {
                            <div class="text-center text-muted">
                                <i class="bi bi-exclamation-triangle fs-1"></i>
                                <p class="mt-2">Aucune cam√©ra d√©tect√©e</p>
                            </div>
                        }
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" @onclick="CancelCameraSelection">
                            <i class="bi bi-x-circle"></i> Annuler
                        </button>
                        <button type="button" class="btn btn-primary" @onclick="ConfirmCameraSelection" disabled="@(!availableCameras.Any())">
                            <i class="bi bi-check-circle"></i> Confirmer
                        </button>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {
    [Parameter] public string PolicierId { get; set; } = "";
    
    // Data properties
    private Policier? policier;
    private bool isLoading = true;
    
    // Camera state
    private bool isCameraActive = false;
    private string? currentPhotoData = null;
    private bool showCropper = false;
    private int currentCameraIndex = 0;
    private int totalCameras = 0;
    private string? errorMessage;
    private string? successMessage;
    private List<MediaDeviceInfo> availableCameras = new();
    private string selectedCameraId = string.Empty;
    private bool showCameraSelection = false;
    private bool showCameraModal = false;

    // Classe pour repr√©senter les informations de la cam√©ra
    public class MediaDeviceInfo
    {
        public string DeviceId { get; set; } = string.Empty;
        public string Label { get; set; } = string.Empty;
        public string Kind { get; set; } = string.Empty;
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadPolicierData();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Pas besoin de charger de script externe, le JavaScript est int√©gr√©
            Console.WriteLine("‚úÖ Page de capture de photo initialis√©e");
            
            // Charger les cam√©ras disponibles et afficher le modal de s√©lection
            await LoadAvailableCameras();
            
            if (availableCameras.Any())
            {
                showCameraModal = true;
                StateHasChanged();
            }
            else
            {
                // Si aucune cam√©ra, essayer de d√©marrer directement
                await Task.Delay(500);
                await StartCamera();
            }
        }
    }

    private async Task LoadPolicierData()
    {
        try
        {
            using var context = DbFactory.CreateDbContext();
            policier = await context.Policiers
                .FirstOrDefaultAsync(p => p.Id == PolicierId);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Erreur lors du chargement du policier: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }







    private async Task StartCamera()
    {
        try
        {
            Console.WriteLine("üé• D√©marrage de la cam√©ra pour les photos...");
            errorMessage = null;
            successMessage = null;
            
            // Utiliser la cam√©ra s√©lectionn√©e (pas besoin de recharger les cam√©ras)
            Console.WriteLine($"üìπ Utilisation de la cam√©ra s√©lectionn√©e: {selectedCameraId}");
            var success = await JSRuntime.InvokeAsync<bool>("startPhotoCamera", selectedCameraId);
            
            if (success)
            {
                isCameraActive = true;
                StateHasChanged();
                Console.WriteLine("‚úÖ Cam√©ra d√©marr√©e avec succ√®s");
                successMessage = "‚úÖ Cam√©ra activ√©e avec succ√®s ! Vous pouvez maintenant capturer des photos.";
            }
            else
            {
                errorMessage = "‚ùå Impossible de d√©marrer la cam√©ra. V√©rifiez les autorisations et que votre cam√©ra est disponible.";
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"‚ùå Erreur lors du d√©marrage de la cam√©ra: {ex.Message}");
            errorMessage = $"Erreur lors du d√©marrage de la cam√©ra: {ex.Message}";
        }
    }

    private async Task LoadAvailableCameras()
    {
        try
        {
            var cameras = await JSRuntime.InvokeAsync<List<MediaDeviceInfo>>("getAvailableCameras");
            availableCameras = cameras ?? new List<MediaDeviceInfo>();
            
            if (availableCameras.Any())
            {
                selectedCameraId = availableCameras.First().DeviceId;
                Console.WriteLine($"üìπ {availableCameras.Count} cam√©ra(s) trouv√©e(s)");
            }
            else
            {
                Console.WriteLine("‚ö†Ô∏è Aucune cam√©ra trouv√©e");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"‚ùå Erreur lors du chargement des cam√©ras: {ex.Message}");
            availableCameras = new List<MediaDeviceInfo>();
        }
    }

    private async Task SwitchCamera()
    {
        try
        {
            if (!isCameraActive)
            {
                errorMessage = "‚ùå Veuillez d'abord d√©marrer la cam√©ra";
                return;
            }
            
            Console.WriteLine("üîÑ Changement de cam√©ra...");
            
            // Arr√™ter la cam√©ra actuelle
            await JSRuntime.InvokeVoidAsync("stopPhotoCamera");
            isCameraActive = false;
            
            // D√©marrer avec la nouvelle cam√©ra
            await Task.Delay(500);
            var success = await JSRuntime.InvokeAsync<bool>("startPhotoCamera", selectedCameraId);
            
            if (success)
            {
                isCameraActive = true;
                successMessage = "‚úÖ Cam√©ra chang√©e avec succ√®s";
                Console.WriteLine("‚úÖ Cam√©ra chang√©e avec succ√®s");
            }
            else
            {
                errorMessage = "‚ùå Impossible de changer de cam√©ra";
                Console.WriteLine("‚ùå √âchec du changement de cam√©ra");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"‚ùå Erreur lors du changement de cam√©ra: {ex.Message}");
            errorMessage = $"Erreur lors du changement de cam√©ra: {ex.Message}";
        }
    }

    private void ToggleCameraSelection()
    {
        showCameraSelection = !showCameraSelection;
    }

    private async Task ConfirmCameraSelection()
    {
        try
        {
            showCameraModal = false;
            StateHasChanged();
            
            // D√©marrer la cam√©ra avec la s√©lection
            await Task.Delay(100);
            await StartCamera();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"‚ùå Erreur lors de la confirmation de s√©lection: {ex.Message}");
            errorMessage = $"Erreur lors de la s√©lection de cam√©ra: {ex.Message}";
        }
    }

    private void CancelCameraSelection()
    {
        showCameraModal = false;
                    StateHasChanged();
    }

    private async Task StopCamera()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("stopPhotoCamera");
            isCameraActive = false;
            StateHasChanged();
            Console.WriteLine("‚úÖ Cam√©ra arr√™t√©e");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"‚ùå Erreur lors de l'arr√™t de la cam√©ra: {ex.Message}");
        }
    }

    private async Task TakePhoto()
    {
        try
        {
            Console.WriteLine("üì∏ Capture de la photo...");
            errorMessage = null; // Effacer les erreurs pr√©c√©dentes
            successMessage = null; // Effacer les messages de succ√®s pr√©c√©dents
            
            // Utiliser directement JSRuntime au lieu du module
            currentPhotoData = await JSRuntime.InvokeAsync<string>("capturePhoto");
            
            if (!string.IsNullOrEmpty(currentPhotoData))
            {
                // Masquer la section cam√©ra et afficher la section photo
                await JSRuntime.InvokeVoidAsync("eval", "document.getElementById('cameraSection').style.display = 'none'");
                await JSRuntime.InvokeVoidAsync("eval", "document.getElementById('photoSection').style.display = 'block'");
                
                // Activer automatiquement l'interface de recadrage
                showCropper = true;
                StateHasChanged();
                
                Console.WriteLine("‚úÖ Photo captur√©e avec succ√®s");
                successMessage = "Photo captur√©e ! S√©lectionnez la zone √† rogner, puis cliquez sur 'Appliquer le recadrage'";
            }
            else
            {
                Console.WriteLine("‚ùå Erreur lors de la capture de la photo");
                errorMessage = "Erreur lors de la capture de la photo";
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"‚ùå Erreur lors de la capture: {ex.Message}");
            errorMessage = $"Erreur lors de la capture: {ex.Message}";
        }
    }

    private async Task ApplyCrop()
    {
        try
        {
            Console.WriteLine("‚úÇÔ∏è Activation du recadrage...");
            
            // Activer l'interface de recadrage
            showCropper = true;
            StateHasChanged();
            
            // Attendre que l'image soit rendue et que l'√©l√©ment soit disponible
            await Task.Delay(500);
            
            // V√©rifier que l'√©l√©ment existe avant d'initialiser
            var elementExists = await JSRuntime.InvokeAsync<bool>("eval", "document.getElementById('photo') !== null");
            
            if (!elementExists)
            {
                errorMessage = "‚ùå L'image n'est pas encore charg√©e. Veuillez r√©essayer.";
                Console.WriteLine("‚ùå √âl√©ment image non trouv√©");
                return;
            }
            
            // Initialiser le cropper sur l'image
            var success = await JSRuntime.InvokeAsync<bool>("initCropper", "photo");
            
            if (success)
            {
                successMessage = "‚úÇÔ∏è S√©lectionnez la zone √† rogner avec la souris, puis cliquez sur 'Appliquer le recadrage'";
                Console.WriteLine("‚úÖ Recadrage activ√© avec succ√®s");
            }
            else
            {
                errorMessage = "‚ùå Erreur lors de l'initialisation du recadrage";
                Console.WriteLine("‚ùå √âchec de l'initialisation du recadrage");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"‚ùå Erreur lors de l'activation du recadrage: {ex.Message}");
            errorMessage = $"Erreur lors de l'activation du recadrage: {ex.Message}";
        }
    }

    private async Task ApplyCropFinal()
    {
        try
        {
            Console.WriteLine("‚úÇÔ∏è Application du recadrage final...");
            
            // Utiliser la nouvelle fonction JavaScript
            var success = await JSRuntime.InvokeAsync<bool>("applyCrop");
            
            if (success)
            {
                showCropper = false;
                StateHasChanged();
                
                Console.WriteLine("‚úÖ Recadrage appliqu√© avec succ√®s");
                successMessage = "‚úÖ Recadrage appliqu√© ! Le r√©sultat est affich√© √† droite";
            }
            else
            {
                Console.WriteLine("‚ùå √âchec de l'application du recadrage");
                errorMessage = "‚ùå Erreur lors de l'application du recadrage";
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"‚ùå Erreur lors de l'application du recadrage: {ex.Message}");
            errorMessage = $"‚ùå Erreur: {ex.Message}";
        }
    }

    private async Task SavePhoto()
    {
        try
        {
            if (currentPhotoData != null)
            {
                var filePath = await PhotoService.SavePhotoAsync(currentPhotoData, PolicierId, "original");
                Console.WriteLine($"‚úÖ Photo sauvegard√©e: {filePath}");
                
                successMessage = "‚úÖ Photo sauvegard√©e avec succ√®s !";
                
                // Rediriger vers la page des policiers
                Navigation.NavigateTo("/policiers");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Erreur lors de la sauvegarde: {ex.Message}");
            errorMessage = $"‚ùå Erreur: {ex.Message}";
        }
    }

    private async Task SaveCroppedPhoto()
    {
        try
        {
            // Utiliser directement JSRuntime au lieu du module
            var croppedPhotoData = await JSRuntime.InvokeAsync<string>("getCurrentCroppedPhotoData");
            if (!string.IsNullOrEmpty(croppedPhotoData))
            {
                var filePath = await PhotoService.SavePhotoAsync(croppedPhotoData, PolicierId, "cropped");
                Console.WriteLine($"‚úÖ Photo recadr√©e sauvegard√©e: {filePath}");
                
                successMessage = "‚úÖ Photo recadr√©e sauvegard√©e !";
                
                // Rediriger vers la page des policiers
                Navigation.NavigateTo("/policiers");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Erreur lors de la sauvegarde: {ex.Message}");
            errorMessage = $"‚ùå Erreur: {ex.Message}";
        }
    }

    private async Task RetakePhoto()
    {
        try
        {
            // R√©initialiser les donn√©es
            currentPhotoData = null;
            showCropper = false;
            
            // Masquer la section photo et r√©afficher la section cam√©ra
            await JSRuntime.InvokeVoidAsync("eval", "document.getElementById('photoSection').style.display = 'none'");
            await JSRuntime.InvokeVoidAsync("eval", "document.getElementById('cameraSection').style.display = 'block'");
            
            StateHasChanged();
            
            successMessage = "üì∏ Pr√™t pour une nouvelle photo";
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Erreur lors de la reprise: {ex.Message}");
        }
    }

    private void CancelCrop()
    {
        showCropper = false;
        StateHasChanged();
    }

    private async Task DownloadPhoto()
    {
        try
        {
            // Utiliser directement JSRuntime au lieu du module
            await JSRuntime.InvokeVoidAsync("downloadCurrentPhoto", $"photo_policier_{PolicierId}.png");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Erreur lors du t√©l√©chargement: {ex.Message}");
        }
    }



    private async Task ReturnToOriginalPhoto()
    {
        try
        {
            // Utiliser directement JSRuntime au lieu du module
            await JSRuntime.InvokeVoidAsync("returnToOriginalPhoto");
            Console.WriteLine("‚úÖ Retour √† la photo originale");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Erreur lors du retour √† la photo originale: {ex.Message}");
        }
    }

    private void GoBack()
    {
        Navigation.NavigateTo("/policiers");
    }

    public async ValueTask DisposeAsync()
    {
        // Nettoyage des ressources JavaScript si n√©cessaire
        await Task.CompletedTask;
    }
}

<script>
    // Variables globales pour la cam√©ra
    let video;
    let stream;

    // Obtenir la liste des cam√©ras disponibles
    window.getAvailableCameras = async function() {
        try {
            console.log('üìπ Recherche des cam√©ras disponibles...');
            
            // V√©rifier si getUserMedia est support√©
            if (!navigator.mediaDevices || !navigator.mediaDevices.enumerateDevices) {
                console.warn('‚ö†Ô∏è enumerateDevices non support√©');
                return [];
            }
            
            // Obtenir la liste des p√©riph√©riques
            const devices = await navigator.mediaDevices.enumerateDevices();
            const cameras = devices
                .filter(device => device.kind === 'videoinput')
                .map(device => ({
                    deviceId: device.deviceId,
                    label: device.label || `Cam√©ra ${device.deviceId.substring(0, 8)}...`,
                    kind: device.kind
                }));
            
            console.log(`üìπ ${cameras.length} cam√©ra(s) trouv√©e(s):`, cameras);
            return cameras;
        } catch (error) {
            console.error('‚ùå Erreur lors de la recherche des cam√©ras:', error);
            return [];
        }
    };

    // D√©marrer la cam√©ra pour les photos
    window.startPhotoCamera = async function(cameraId = null) {
        try {
            console.log('üé• Initialisation de la cam√©ra pour les photos...');
            
            // R√©cup√©rer l'√©l√©ment vid√©o
            video = document.getElementById("video");
            if (!video) {
                console.error('‚ùå √âl√©ment vid√©o non trouv√©');
                return false;
            }

            console.log('üìπ √âl√©ment vid√©o trouv√©, demande d\'acc√®s √† la cam√©ra...');
            console.log('üìπ ID de cam√©ra s√©lectionn√©e:', cameraId);

            // Configuration de la cam√©ra
            const constraints = {
                video: cameraId ? { deviceId: { exact: cameraId } } : true
            };

            // Demander l'acc√®s √† la cam√©ra
            stream = await navigator.mediaDevices.getUserMedia(constraints);
            console.log('‚úÖ Acc√®s √† la cam√©ra accord√©');
            
            video.srcObject = stream;
            console.log('‚úÖ Cam√©ra photo activ√©e');
            return true;
        } catch (err) {
            console.error("‚ùå Erreur d'acc√®s √† la cam√©ra:", err);
            
            // Messages d'erreur clairs
            let errorMessage = '';
            switch (err.name) {
                case 'NotAllowedError':
                    errorMessage = 'üîê Acc√®s √† la cam√©ra refus√©\n\nVeuillez cliquer sur "Autoriser" dans la popup de votre navigateur.';
                    break;
                case 'NotFoundError':
                    errorMessage = 'üì∑ Aucune cam√©ra trouv√©e\n\nV√©rifiez que votre cam√©ra est connect√©e.';
                    break;
                case 'NotReadableError':
                    errorMessage = '‚ö†Ô∏è Cam√©ra d√©j√† utilis√©e\n\nFermez les autres applications qui utilisent la cam√©ra.';
                    break;
                case 'OverconstrainedError':
                    errorMessage = '‚ö†Ô∏è Cam√©ra non compatible\n\nEssayez une autre cam√©ra.';
                    break;
                default:
                    errorMessage = '‚ùå Erreur: ' + err.message;
            }
            
            alert(errorMessage);
            return false;
        }
    };

    // Arr√™ter la cam√©ra pour les photos
    window.stopPhotoCamera = function() {
        try {
            console.log('üõë Arr√™t de la cam√©ra photo...');
            
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            
            if (video) {
                video.srcObject = null;
            }
            
            console.log('‚úÖ Cam√©ra photo arr√™t√©e');
        } catch (error) {
            console.error('‚ùå Erreur lors de l\'arr√™t de la cam√©ra:', error);
        }
    };

    // Capturer une photo (inspir√© de votre exemple)
    window.capturePhoto = function() {
        return new Promise((resolve, reject) => {
            try {
                console.log('üì∏ Capture de la photo...');
                
                if (!video || !video.srcObject) {
                    reject('Aucune cam√©ra active');
                    return;
                }

                // Cr√©er un canvas temporaire
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                
                // D√©finir les dimensions du canvas
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                
                // Dessiner l'image de la vid√©o sur le canvas
                context.drawImage(video, 0, 0, canvas.width, canvas.height);
                
                // R√©cup√©rer l'image en Base64
                const imageData = canvas.toDataURL("image/png");
                console.log('üì∏ Image captur√©e, taille:', imageData.length);
                
                resolve(imageData);
            } catch (error) {
                console.error('‚ùå Erreur capture photo:', error);
                reject(error);
            }
        });
    };

    // Variables pour le recadrage
    let cropper = null;
    let croppedImageData = null;

    // Attendre qu'un √©l√©ment soit disponible
    window.waitForElement = function(elementId, maxWaitTime = 5000) {
        return new Promise((resolve, reject) => {
            const startTime = Date.now();
            
            const checkElement = () => {
                const element = document.getElementById(elementId);
                if (element) {
                    console.log('‚úÖ √âl√©ment trouv√©:', elementId);
                    resolve(element);
                } else if (Date.now() - startTime > maxWaitTime) {
                    console.error('‚ùå Timeout: √âl√©ment non trouv√© apr√®s', maxWaitTime, 'ms');
                    reject(new Error('Element not found'));
                } else {
                    setTimeout(checkElement, 100);
                }
            };
            
            checkElement();
        });
    };

    // Initialiser le recadrage
    window.initCropper = async function(imageElementId) {
        try {
            console.log('‚úÇÔ∏è Initialisation du recadrage...');
            
            // Attendre que l'√©l√©ment soit disponible
            const imageElement = await window.waitForElement(imageElementId);
            
            console.log('‚úÖ √âl√©ment image trouv√©:', imageElement);
            
            if (cropper) {
                cropper.destroy();
            }
            
            // Cr√©er un nouveau cropper
            cropper = new Cropper(imageElement, {
                aspectRatio: 1, // Ratio carr√©
                viewMode: 1,
                dragMode: 'move',
                autoCropArea: 0.8,
                restore: false,
                guides: true,
                center: true,
                highlight: true,
                cropBoxMovable: true,
                cropBoxResizable: true,
                toggleDragModeOnDblclick: false,
                background: false,
                zoomable: true,
                zoomOnTouch: true,
                zoomOnWheel: true,
                wheelZoomRatio: 0.1,
                cropstart: function(event) {
                    console.log('‚úÇÔ∏è D√©but du recadrage');
                },
                cropmove: function(event) {
                    console.log('‚úÇÔ∏è Recadrage en cours');
                },
                cropend: function(event) {
                    console.log('‚úÇÔ∏è Fin du recadrage');
                }
            });
            
            console.log('‚úÖ Recadrage initialis√©');
            return true;
        } catch (error) {
            console.error('‚ùå Erreur initialisation recadrage:', error);
            return false;
        }
    };

    // Appliquer le recadrage
    window.applyCrop = function() {
        try {
            console.log('‚úÇÔ∏è Application du recadrage...');
            
            if (!cropper) {
                console.error('‚ùå Cropper non initialis√©');
                return false;
            }
            
            // Obtenir l'image recadr√©e
            const canvas = cropper.getCroppedCanvas({
                width: 300,
                height: 300,
                minWidth: 100,
                minHeight: 100,
                maxWidth: 800,
                maxHeight: 800,
                fillColor: '#fff',
                imageSmoothingEnabled: true,
                imageSmoothingQuality: 'high'
            });
            
            if (canvas) {
                // Convertir en base64
                croppedImageData = canvas.toDataURL('image/png');
                console.log('‚úÖ Recadrage appliqu√©, taille:', croppedImageData.length);
                
                // Afficher le r√©sultat
                const resultImg = document.getElementById('croppedResult');
                if (resultImg) {
                    resultImg.src = croppedImageData;
                }
                
                // Afficher la section r√©sultat
                const resultSection = document.getElementById('resultSection');
                if (resultSection) {
                    resultSection.style.display = 'block';
                }
                
                return true;
            } else {
                console.error('‚ùå Impossible de cr√©er l\'image recadr√©e');
                return false;
            }
        } catch (error) {
            console.error('‚ùå Erreur application recadrage:', error);
            return false;
        }
    };

    // Obtenir les donn√©es de l'image recadr√©e
    window.getCurrentCroppedPhotoData = function() {
        return croppedImageData;
    };

    // D√©truire le cropper
    window.destroyCropper = function() {
        if (cropper) {
            cropper.destroy();
            cropper = null;
            console.log('‚úÖ Cropper d√©truit');
        }
    };
</script>
