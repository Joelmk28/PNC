@page "/test-camera-simple"
@using Microsoft.JSInterop
@inject IJSRuntime JSRuntime

<PageTitle>Test Cam√©ra Simple - PNC</PageTitle>

<div class="camera-test-page">
    <div class="container">
        <h1>üì∏ Test de la Cam√©ra Simple</h1>
        <p class="description">Test du syst√®me de capture et recadrage de photos</p>
        
        <div class="test-container">
            <!-- Bloc cam√©ra -->
            <div class="camera-section" id="cameraSection">
                <h3>üé• Cam√©ra</h3>
                <video id="video" autoplay playsinline style="width: 100%; max-width: 500px; border-radius: 12px; border: 2px solid #ddd;"></video>
                <br>
                <button class="btn-modern btn-primary" @onclick="CapturePhoto">
                    <i class="bi bi-camera"></i> Prendre une photo
                </button>
            </div>

            <!-- Bloc photo prise -->
            <div class="photo-section" id="photoSection" style="display:none;">
                <h3>üì∑ Photo Captur√©e</h3>
                <img id="photo" alt="Photo captur√©e" style="width: 100%; max-width: 500px; border-radius: 12px; border: 2px solid #ddd;" />
                <br>
                <button class="btn-modern btn-secondary" @onclick="StartCropping">
                    <i class="bi bi-scissors"></i> Rogner
                </button>
                <button class="btn-modern btn-success" @onclick="SavePhoto">
                    <i class="bi bi-check"></i> Utiliser cette photo
                </button>
                <button class="btn-modern btn-outline" @onclick="RetakePhoto">
                    <i class="bi bi-arrow-repeat"></i> Reprendre
                </button>
            </div>

            <!-- R√©sultat du rognage -->
            <div class="result-section" id="resultSection" style="display:none;">
                <h3>‚úÖ R√©sultat du Rognage</h3>
                <img id="croppedResult" style="width: 100%; max-width: 500px; border-radius: 12px; border: 2px solid #ddd; margin-top: 15px;" />
                <br>
                <button class="btn-modern btn-success" @onclick="SaveCroppedPhoto">
                    <i class="bi bi-check"></i> Utiliser cette photo
                </button>
                <button class="btn-modern btn-outline" @onclick="CancelCrop">
                    <i class="bi bi-x"></i> Annuler
                </button>
            </div>
        </div>

        <div class="debug-info">
            <h4>üîç Informations de D√©bogage</h4>
            <p><strong>Photo captur√©e :</strong> <span id="photoStatus">Non</span></p>
            <p><strong>Photo recadr√©e :</strong> <span id="cropStatus">Non</span></p>
            <p><strong>Donn√©es photo :</strong> <span id="dataStatus">Aucune</span></p>
        </div>
    </div>
</div>

@code {
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await InitializeCamera();
        }
    }

    private async Task InitializeCamera()
    {
        try
        {
            var success = await JSRuntime.InvokeAsync<bool>("initSimpleCamera");
            if (success)
            {
                Console.WriteLine("‚úÖ Cam√©ra initialis√©e avec succ√®s");
            }
            else
            {
                Console.WriteLine("‚ùå √âchec de l'initialisation de la cam√©ra");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"‚ùå Erreur lors de l'initialisation: {ex.Message}");
        }
    }

    private async Task CapturePhoto()
    {
        try
        {
            var photoData = await JSRuntime.InvokeAsync<string>("capturePhoto");
            if (!string.IsNullOrEmpty(photoData))
            {
                Console.WriteLine("üì∏ Photo captur√©e avec succ√®s");
                await UpdateDebugInfo("Photo captur√©e", "Oui", photoData.Substring(0, 50) + "...");
            }
            else
            {
                Console.WriteLine("‚ùå √âchec de la capture de la photo");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"‚ùå Erreur capture photo: {ex.Message}");
        }
    }

    private async Task StartCropping()
    {
        try
        {
            var success = await JSRuntime.InvokeAsync<bool>("startCropping");
            if (success)
            {
                Console.WriteLine("‚úÇÔ∏è Recadrage d√©marr√©");
            }
            else
            {
                Console.WriteLine("‚ùå √âchec du d√©marrage du recadrage");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"‚ùå Erreur d√©marrage recadrage: {ex.Message}");
        }
    }

    private async Task ApplyCrop()
    {
        try
        {
            var croppedData = await JSRuntime.InvokeAsync<string>("applyCrop");
            if (!string.IsNullOrEmpty(croppedData))
            {
                Console.WriteLine("‚úÖ Recadrage appliqu√© avec succ√®s");
                await UpdateDebugInfo("Photo recadr√©e", "Oui", croppedData.Substring(0, 50) + "...");
            }
            else
            {
                Console.WriteLine("‚ùå √âchec de l'application du recadrage");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"‚ùå Erreur application recadrage: {ex.Message}");
        }
    }

    private async Task RetakePhoto()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("retakePhoto");
            Console.WriteLine("üîÑ Retour √† la capture");
            await UpdateDebugInfo("Photo captur√©e", "Non", "Aucune");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"‚ùå Erreur reprise photo: {ex.Message}");
        }
    }

    private async Task CancelCrop()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("cancelCrop");
            Console.WriteLine("‚ùå Recadrage annul√©");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"‚ùå Erreur annulation recadrage: {ex.Message}");
        }
    }

    private async Task SavePhoto()
    {
        try
        {
            var photoData = await JSRuntime.InvokeAsync<string>("getFinalPhoto");
            if (!string.IsNullOrEmpty(photoData))
            {
                Console.WriteLine("üíæ Photo sauvegard√©e (originale)");
                await UpdateDebugInfo("Photo sauvegard√©e", "Oui", "Photo originale utilis√©e");
            }
            else
            {
                Console.WriteLine("‚ùå Aucune photo √† sauvegarder");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"‚ùå Erreur sauvegarde photo: {ex.Message}");
        }
    }

    private async Task SaveCroppedPhoto()
    {
        try
        {
            var photoData = await JSRuntime.InvokeAsync<string>("getFinalPhoto");
            if (!string.IsNullOrEmpty(photoData))
            {
                Console.WriteLine("üíæ Photo recadr√©e sauvegard√©e");
                await UpdateDebugInfo("Photo sauvegard√©e", "Oui", "Photo recadr√©e utilis√©e");
            }
            else
            {
                Console.WriteLine("‚ùå Aucune photo √† sauvegarder");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"‚ùå Erreur sauvegarde photo recadr√©e: {ex.Message}");
        }
    }

    private async Task UpdateDebugInfo(string field, string value, string data)
    {
        await JSRuntime.InvokeVoidAsync("eval", 
            $"document.getElementById('photoStatus').textContent = '{value}';" +
            $"document.getElementById('cropStatus').textContent = '{value}';" +
            $"document.getElementById('dataStatus').textContent = '{data}';"
        );
    }

    public async ValueTask DisposeAsync()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("cleanupCamera");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Erreur lors du nettoyage: {ex.Message}");
        }
    }
}
