@page "/policier/ajouter"
@page "/policier/modifier/{Id}"
@using PNC.Data
@using PNC.Models
@using PNC.Services
@using Microsoft.EntityFrameworkCore
@inject IDbContextFactory<BdPolicePncContext> ContextFactory
@inject NavigationManager Navigation
@inject GeographieRdcService GeographieService
@inject IPolicierService PolicierService
@inject IJSRuntime JSRuntime
@inject IImageStorageService ImageStorageService
@inject INutpService NutpService
@inject IWebHostEnvironment _environment

<PageTitle>@(IsEdit ? "Modifier le policier" : "Nouveau policier")</PageTitle>

<div class="policier-form-page">
    <div class="form-container">
        <!-- Header -->
        <div class="page-header">
            <div class="header-content">
                <h1 class="page-title">
                    <i class="bi bi-person-plus me-3"></i>
                    @(IsEdit ? "Modifier le Policier" : "Nouveau Policier")
                </h1>
                <p class="page-subtitle">
                    @(IsEdit ? "Modifiez les informations du policier" : "Remplissez le formulaire pour ajouter un nouveau policier")
                </p>
            </div>
            <div class="header-actions">
                <button class="btn-modern btn-outline" @onclick="GoBack">
                    <i class="bi bi-arrow-left"></i>
                    Retour
                </button>
            </div>
        </div>

        <!-- Progress Bar -->
        <div class="form-progress">
            <div class="progress-bar">
                <div class="progress-fill" style="width: @((currentStep * 100) / totalSteps)%"></div>
            </div>
            <div class="progress-steps">
                @for (int i = 1; i <= totalSteps; i++)
                {
                    <div class="step @(i == currentStep ? "active" : "") @(i < currentStep ? "completed" : "") @(stepValidated.ContainsKey(i) && stepValidated[i] ? "validated" : "")">
                        <div class="step-number">@i</div>
                        <div class="step-label">@GetStepLabel(i)</div>
                    </div>
                }
            </div>
        </div>


        <!-- Form Steps -->
        <div class="form-steps">
            <!-- Étape 1: Informations Personnelles -->
            @if (currentStep == 1)
            {
                <div class="form-step active">
                    <div class="step-header">
                        <i class="bi bi-card-text"></i>
                        <h3>Étape 1: Identification de base</h3>
                        <p>Informations d'identification et de naissance du policier</p>
                    </div>

                    <!-- Message de vérification NUTP -->
                    @if (!string.IsNullOrEmpty(nutpVerificationMessage))
                    {
                        <div class="nutp-verification-message @(nutpVerificationError ? "error" : "success")">
                            <i class="bi @(nutpVerificationError ? "bi-exclamation-triangle" : "bi-check-circle")"></i>
                            @nutpVerificationMessage
                        </div>
                    }
                    else if (!isNutpVerified && !IsEdit)
                    {
                        <div class="nutp-verification-message info">
                            <i class="bi bi-info-circle"></i>
                            Veuillez d'abord saisir et vérifier le numéro NUTP pour continuer
                        </div>
                    }
                    <div class="form-grid compact">
                        <div class="form-group">
                            <label for="numeroNutp">NUMERO NUTP *</label>
                            <input type="text" id="numeroNutp" @bind="Policier.NumeroNutp" @bind:after="OnNutpChanged" required 
                                   class="form-input" placeholder="Entrez le NUTP" />
                            @if (HasValidationError("NumeroNutp"))
                            {
                                <div class="validation-error">@GetValidationError("NumeroNutp")</div>
                            }
                        </div>
                        <div class="form-group">
                            <label for="commissariat">Commissariat *</label>
                            <select id="commissariat" @bind="Policier.IdCommissariat" @bind:after="UpdateCommissariatInfo" required 
                                    class="form-select" disabled="@(!isNutpVerified)">
                                <option value="">Sélectionnez un commissariat</option>
                                @if (commissariats?.Any() == true)
                                {
                                    @foreach (var commissariat in commissariats)
                                    {
                                        <option value="@commissariat.Id">@commissariat.Nom - @commissariat.Province</option>
                                    }
                                }
                            </select>
                            @if (HasValidationError("IdCommissariat"))
                            {
                                <div class="validation-error">@GetValidationError("IdCommissariat")</div>
                            }
                        </div>
                        <div class="form-group">
                            <label for="province">Province</label>
                            <input type="text" id="province" @bind="SelectedProvince" 
                                   class="form-input" placeholder="Province du commissariat" readonly 
                                   disabled="@(!isNutpVerified)" />
                        </div>
                        <div class="form-group">
                            <label for="district">District *</label>
                            <input type="text" id="district" @bind="DistrictCommissariat" required
                                   class="form-input" placeholder="Entrez le district" disabled="@(!isNutpVerified)" />
                            @if (HasValidationError("District"))
                            {
                                <div class="validation-error">@GetValidationError("District")</div>
                            }
                        </div>
                        <div class="form-group">
                            <label for="territoire">Territoire/Commune *</label>
                            <select id="territoire" @bind="TerritoireCommissariat" required class="form-select"
                                    disabled="@(!isNutpVerified || string.IsNullOrEmpty(SelectedProvince))">
                                <option value="">@(!isNutpVerified ? "Vérifiez d'abord le NUTP" : string.IsNullOrEmpty(SelectedProvince) ? "Sélectionnez d'abord une province" : "Sélectionnez un territoire/commune")</option>
                                @if (territoiresCommunesCommissariat?.Any() == true)
                                {
                                    @foreach (var territoire in territoiresCommunesCommissariat)
                                    {
                                        <option value="@territoire">@territoire</option>
                                    }
                                }
                            </select>
                            @if (HasValidationError("Territoire"))
                            {
                                <div class="validation-error">@GetValidationError("Territoire")</div>
                            }
                        </div>
                    
                    
                        <div class="form-group">
                            <label for="nom">Nom *</label>
                            <input type="text" id="nom" @bind="Policier.Nom" required 
                                   class="form-input" placeholder="Entrez le nom" disabled="@(!isNutpVerified)" />
                            @if (HasValidationError("Nom"))
                            {
                                <div class="validation-error">@GetValidationError("Nom")</div>
                            }
                        </div>
                        <div class="form-group">
                            <label for="prenom">Prénom *</label>
                            <input type="text" id="prenom" @bind="Policier.Prenom" required 
                                   class="form-input" placeholder="Entrez le prénom" disabled="@(!isNutpVerified)" />
                            @if (HasValidationError("Prenom"))
                            {
                                <div class="validation-error">@GetValidationError("Prenom")</div>
                            }
                        </div>
                        <div class="form-group">
                            <label for="postNom">Post-nom</label>
                            <input type="text" id="postNom" @bind="Policier.PostNom" 
                                   class="form-input" placeholder="Entrez le post-nom" disabled="@(!isNutpVerified)" />
                        </div>
                        <div class="form-group">
                            <label for="matricule">Matricule *</label>
                            <input type="text" id="matricule" @bind="Policier.Matricule" required
                                   class="form-input" placeholder="Entrez le matricule" disabled="@(!isNutpVerified)" />
                            @if (HasValidationError("Matricule"))
                            {
                                <div class="validation-error">@GetValidationError("Matricule")</div>
                            }
                        </div>
                        <div class="form-group">
                            <label for="dateNaissance">Date de naissance *</label>
                            <input type="date" id="dateNaissance" @bind="Policier.DateNaissance" 
                                   @bind:after="() => UpdateDateComponents(Policier.DateNaissance)"
                                   class="form-input" disabled="@(!isNutpVerified)" />
                            @if (HasValidationError("DateNaissance"))
                            {
                                <div class="validation-error">@GetValidationError("DateNaissance")</div>
                            }
                        </div>
                        <div class="form-group">
                            <label for="villageNaissance">Village de naissance</label>
                            <input type="text" id="villageNaissance" @bind="Policier.VillageNaissance" 
                                   class="form-input" placeholder="Entrez le village de naissance" disabled="@(!isNutpVerified)" />
                        </div>
                        <div class="form-group">
                            <label for="villeNaissance">Ville de naissance</label>
                            <input type="text" id="villeNaissance" @bind="Policier.VilleNaissance" 
                                   class="form-input" placeholder="Entrez la ville de naissance" disabled="@(!isNutpVerified)" />
                        </div>
                        <div class="form-group">
                            <label for="paysNaissance">Pays de naissance</label>
                            <input type="text" id="paysNaissance" @bind="Policier.PaysNaissance" 
                                   class="form-input" placeholder="Entrez le pays de naissance" disabled="@(!isNutpVerified)" />
                        </div>
                    </div>
                </div>
            }

            <!-- Étape 2: Informations Professionnelles -->
            @if (currentStep == 2)
            {
                <div class="form-step active">
                    <div class="step-header">
                        <i class="bi bi-briefcase"></i>
                        <h3>Étape 2: Informations Professionnelles</h3>
                        <p>Sexe, Grade, Formation et Unité du policier</p>
                    </div>
                    <div class="form-grid compact">
                        <div class="form-group">
                            <label for="sexe">Sexe *</label>
                            <select id="sexe" @bind="Policier.Sexe" required class="form-select">
                                <option value="">Sélectionnez le sexe</option>
                                <option value="M">Masculin</option>
                                <option value="F">Féminin</option>
                            </select>
                            @if (HasValidationError("Sexe"))
                            {
                                <div class="validation-error">@GetValidationError("Sexe")</div>
                            }
                        </div>
                        <div class="form-group">
                            <label for="natureGrade">Grade *</label>
                            <select id="natureGrade" @bind="Policier.NatureGrade" required class="form-select">
                                <option value="">Sélectionnez un grade</option>
                                <option value="Commissaire">Commissaire</option>
                                <option value="Officier">Officier</option>
                                <option value="Sous-officier">Sous-officier</option>
                      
                                <option value="Agent">Agent</option>
                                            <option value="Agent de 1ère classe">Agent de 1ère classe</option>
                                            <option value="Brigadier">Brigadier</option>
                                            <option value="Brigadier-chef">Brigadier-chef</option>
                                            <option value="Sergent">Sergent</option>
                                            <option value="Sergent-major">Sergent-major</option>
                                            <option value="Adjudant">Adjudant</option>
                                            <option value="Adjudant-chef">Adjudant-chef</option>
                                            <option value="Sous-lieutenant">Sous-lieutenant</option>
                                            <option value="Lieutenant">Lieutenant</option>
                                            <option value="Capitaine">Capitaine</option>
                                            <option value="Commandant">Commandant</option>
                                            <option value="Lieutenant-colonel">Lieutenant-colonel</option>
                                            <option value="Colonel">Colonel</option>
                                            <option value="Commissaire divisionnaire">Commissaire divisionnaire</option>
                                            <option value="Commissaire général">Commissaire général</option>

                            </select>
                            @if (HasValidationError("NatureGrade"))
                            {
                                <div class="validation-error">@GetValidationError("NatureGrade")</div>
                            }
                        </div>
                        <div class="form-group">
                            <label for="acteNominationGrade">Acte de nomination *</label>
                            <input type="text" id="acteNominationGrade" @bind="Policier.ActeNominationGrade" required
                                   class="form-input" placeholder="Entrez l'acte de nomination" />
                            @if (HasValidationError("ActeNominationGrade"))
                            {
                                <div class="validation-error">@GetValidationError("ActeNominationGrade")</div>
                            }
                        </div>
                        <div class="form-group">
                            <label for="dateNomination">Date de nomination *</label>
                            <input type="date" id="dateNomination" @bind="Policier.DateNomination" required
                                   class="form-input" />
                            @if (HasValidationError("DateNomination"))
                            {
                                <div class="validation-error">@GetValidationError("DateNomination")</div>
                            }
                        </div>
                        <div class="form-group">
                            <label for="dateEntreePolice">Date d'entrée à la police *</label>
                            <input type="date" id="dateEntreePolice" @bind="Policier.DateEntreePolice" required
                                   class="form-input" />
                            @if (HasValidationError("DateEntreePolice"))
                            {
                                <div class="validation-error">@GetValidationError("DateEntreePolice")</div>
                            }
                        </div>
                        <div class="form-group">
                            <label for="lieuEntreePolice">Lieu de formation</label>
                            <input type="text" id="lieuEntreePolice" @bind="Policier.LieuEntreePolice" 
                                   class="form-input" placeholder="Entrez le lieu de formation" />
                        </div>
                        <div class="form-group">
                            <label for="fonctionActuelle">Fonction actuelle *</label>
                            <input type="text" id="fonctionActuelle" @bind="Policier.FonctionActuelle" required
                                   class="form-input" placeholder="Entrez la fonction actuelle" />
                            @if (HasValidationError("FonctionActuelle"))
                            {
                                <div class="validation-error">@GetValidationError("FonctionActuelle")</div>
                            }
                        </div>

                        <div class="form-group">
                            <label for="datePriseFonction">Date de prise de fonction *</label>
                            <input type="date" id="datePriseFonction" @bind="Policier.DatePriseFonction" required
                                   class="form-input" />
                            @if (HasValidationError("DatePriseFonction"))
                            {
                                <div class="validation-error">@GetValidationError("DatePriseFonction")</div>
                            }
                        </div>
                    </div>
                </div>
            }

            <!-- Étape 3: État Civil et Conjoints -->
            @if (currentStep == 3)
            {
                <div class="form-step active">
                    <div class="step-header">
                        <i class="bi bi-heart"></i>
                        <h3>Étape 3: État Civil</h3>
                        <p>État civil et informations sur les conjoints</p>
                    </div>
                    <div class="form-grid compact">
                        <div class="form-group">
                            <label for="etatCivil">État civil *</label>
                            <select id="etatCivil" @bind="Policier.EtatCivil" @bind:after="OnEtatCivilChanged" required class="form-select">
                                <option value="">Sélectionnez l'état civil</option>
                                <option value="Célibataire">Célibataire</option>
                                <option value="Marié">Marié</option>
                                <option value="Divorcé">Divorcé</option>
                                <option value="Veuf">Veuf</option>
                            </select>
                            @if (HasValidationError("EtatCivil"))
                            {
                                <div class="validation-error">@GetValidationError("EtatCivil")</div>
                            }
                        </div>
                        

                    </div>
                    
                    @if (!string.IsNullOrEmpty(Policier.EtatCivil) && Policier.EtatCivil != "Célibataire")
                    {
                        <div class="collection-section">
                            <h4><i class="bi bi-people"></i> Conjoints</h4>
                            
                            @if (Conjoints.Any())
                            {
                                <div class="collection-items">
                                    @for (int i = 0; i < Conjoints.Count; i++)
                                    {
                                        var index = i;
                                        var conjoint = Conjoints[index];
                                        <div class="collection-item">
                                            <div class="item-header">
                                                <strong>@conjoint.Nom @conjoint.PostNom @conjoint.Prenom</strong>
                                                <button type="button" class="btn-remove" @onclick="() => RemoveConjoint(index)">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </div>
                                            <div class="item-details">
                                                <span>Date mariage: @conjoint.DateMariage?.ToString("dd/MM/yyyy")</span>
                                                <span>Profession: @conjoint.Profession</span>
                                            </div>
                                        </div>
                                    }
                                </div>
                            }
                            
                            <button type="button" class="btn-add-item" @onclick="AddConjointForm" 
                                    disabled="@(CanAddConjoint() == false)">
                                <i class="bi bi-plus"></i> Ajouter un conjoint
                            </button>
                            
                            @if (showAddConjointForm)
                            {
                                <div class="add-item-form">
                                    <div class="form-grid compact">
                        <div class="form-group">
                                            <label>Nom *</label>
                                            <input @bind="newConjoint.Nom" type="text" class="form-input" required />
                        </div>
                        <div class="form-group">
                                            <label>Post-nom</label>
                                            <input @bind="newConjoint.PostNom" type="text" class="form-input" />
                        </div>
                        <div class="form-group">
                                            <label>Prénom</label>
                                            <input @bind="newConjoint.Prenom" type="text" class="form-input" />
                        </div>
                        <div class="form-group">
                                            <label>Nationalité *</label>
                                            <input @bind="newConjoint.Nationalite" type="text" class="form-input" required />
                        </div>
                        <div class="form-group">
                                            <label>Profession *</label>
                                            <input @bind="newConjoint.Profession" type="text" class="form-input" required />
                        </div>
                        <div class="form-group">
                                            <label>Matricule</label>
                                            <input @bind="newConjoint.Matricule" type="text" class="form-input" />
                        </div>
                                        <div class="form-group">
                                            <label>Date de mariage</label>
                                            <input @bind="newConjoint.DateMariage" type="date" class="form-input" />
                                        </div>
                                    </div>
                                    @if (!string.IsNullOrEmpty(errorMessageConjoint))
                                    {
                                        <div class="validation-error">@errorMessageConjoint</div>
                                    }
                                    <div class="form-actions">
                                        <button type="button" class="btn-modern btn-outline" @onclick="CancelAddConjoint">Annuler</button>
                                        <button type="button" class="btn-modern btn-success" @onclick="SaveConjoint">Ajouter</button>
                    </div>
                                </div>
                            }
                        </div>
                    }
                </div>
            }

            <!-- Étape 4: Enfants -->
            @if (currentStep == 4)
            {
                <div class="form-step active">
                    <div class="step-header">
                        <i class="bi bi-people"></i>
                        <h3>Étape 4: Enfants</h3>
                        <p>Enfants de moins de 18 ans</p>
                    </div>
                    
                    <div class="collection-section">
                        <h4><i class="bi bi-people-fill"></i> Enfants (de moins de 18 ans)</h4>
                        
                        @if (Enfants.Any())
                        {
                            <div class="collection-items">
                                @for (int i = 0; i < Enfants.Count; i++)
                                {
                                    var index = i;
                                    var enfant = Enfants[index];
                                    <div class="collection-item">
                                        <div class="item-header">
                                            <strong>@enfant.Nom @enfant.PostNom @enfant.Prenom</strong>
                                            <button type="button" class="btn-remove" @onclick="() => RemoveEnfant(index)">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                        <div class="item-details">
                                            <span>Né le: @enfant.DateNaissance.ToString("dd/MM/yyyy")</span>
                                            <span>Lieu: @enfant.VilleNaissance, @enfant.PaysNaissance</span>
                                        </div>
                                    </div>
                                }
                            </div>
                        }
                        
                        <button type="button" class="btn-add-item" @onclick="AddEnfantForm">
                            <i class="bi bi-plus"></i> Ajouter un enfant
                        </button>
                        
                        @if (showAddEnfantForm)
                        {
                            <div class="add-item-form">
                    <div class="form-grid compact">
                        <div class="form-group">
                                        <label>Nom *</label>
                                        <input @bind="newEnfant.Nom" type="text" class="form-input" required />
                                    </div>
                                    <div class="form-group">
                                        <label>Post-nom</label>
                                        <input @bind="newEnfant.PostNom" type="text" class="form-input" />
                                    </div>
                                    <div class="form-group">
                                        <label>Prénom</label>
                                        <input @bind="newEnfant.Prenom" type="text" class="form-input" />
                                    </div>
                                    <div class="form-group">
                                        <label>Date de naissance *</label>
                                        <input @bind="newEnfant.DateNaissance" type="date" class="form-input" required />
                                    </div>
                                    <div class="form-group">
                                        <label>Pays de naissance *</label>
                                        <input @bind="newEnfant.PaysNaissance" type="text" class="form-input" required />
                                    </div>
                                    <div class="form-group">
                                        <label>Ville de naissance *</label>
                                        <input @bind="newEnfant.VilleNaissance" type="text" class="form-input" required />
                                    </div>
                                </div>
                                @if (!string.IsNullOrEmpty(errorMessageEnfant))
                                {
                                    <div class="validation-error" style="margin-top: 10px;">
                                        <i class="bi bi-exclamation-triangle"></i> @errorMessageEnfant
                                    </div>
                                }
                                <div class="form-actions">
                                    <button type="button" class="btn-modern btn-outline" @onclick="CancelAddEnfant">Annuler</button>
                                    <button type="button" class="btn-modern btn-success" @onclick="SaveEnfant">Ajouter</button>
                        </div>
                            </div>
                        }
                    </div>
                </div>
            }
            
            <!-- Étape 5: Origine et Formations -->
            @if (currentStep == 5)
            {
                <div class="form-step active">
                    <div class="step-header">
                        <i class="bi bi-geo-alt"></i>
                        <h3>Étape 5: Origine et Études</h3>
                        <p>Province d'origine et formations académiques</p>
                    </div>
                    <div class="form-grid compact">
                        <div class="form-group">
                            <label for="provinceOrigine">Province d'origine *</label>
                            <select id="provinceOrigine" @bind="selectedProvinceOrigine" @bind:after="OnProvinceOrigineChanged" required class="form-select">
                                <option value="">Sélectionnez une province</option>
                                @if (provinces?.Any() == true)
                                {
                                    @foreach (var province in provinces)
                                    {
                                        <option value="@province.Nom">@province.Nom</option>
                                    }
                                }
                            </select>
                            @if (HasValidationError("ProvinceOrigine"))
                            {
                                <div class="validation-error">@GetValidationError("ProvinceOrigine")</div>
                            }
                        </div>
                        <div class="form-group">
                            <label for="territoireOrigine">Territoire/Commune d'origine *</label>
                            <select id="territoireOrigine" @bind="Policier.TerritoireOrigine" required class="form-select" disabled="@(string.IsNullOrEmpty(selectedProvinceOrigine))">
                                <option value="">@(string.IsNullOrEmpty(selectedProvinceOrigine) ? "Sélectionnez d'abord une province" : "Sélectionnez un territoire/commune")</option>
                                @if (territoiresCommunes?.Any() == true)
                                {
                                    @foreach (var territoire in territoiresCommunes)
                                    {
                                        <option value="@territoire">@territoire</option>
                                    }
                                }
                            </select>
                            @if (HasValidationError("TerritoireOrigine"))
                            {
                                <div class="validation-error">@GetValidationError("TerritoireOrigine")</div>
                            }
                        </div>
                        <div class="form-group">
                            <label for="districtOrigine">District d'origine</label>
                            <input type="text" id="districtOrigine" @bind="Policier.DistrictOrigine"
                                   class="form-input" placeholder="Entrez le district d'origine" />
                            @if (HasValidationError("DistrictOrigine"))
                            {
                                <div class="validation-error">@GetValidationError("DistrictOrigine")</div>
                            }
                        </div>
                        <div class="form-group">
                            <label for="secteurOrigine">Secteur d'origine</label>
                            <input type="text" id="secteurOrigine" @bind="Policier.SecteurOrigine"
                                   class="form-input" placeholder="Entrez le secteur d'origine" />
                            @if (HasValidationError("SecteurOrigine"))
                            {
                                <div class="validation-error">@GetValidationError("SecteurOrigine")</div>
                            }
                        </div>
                        <div class="form-group">
                            <label for="villageOrigine">Village d'origine</label>
                            <input type="text" id="villageOrigine" @bind="Policier.VillageOrigine"
                                   class="form-input" placeholder="Entrez le village d'origine" />
                            @if (HasValidationError("VillageOrigine"))
                            {
                                <div class="validation-error">@GetValidationError("VillageOrigine")</div>
                            }
                        </div>
                    </div>
                    
                    <div class="collection-section">
                        <h4><i class="bi bi-mortarboard"></i> Études faites (Formations)</h4>
                        
                        @if (Formations.Any())
                        {
                            <div class="collection-items">
                                @for (int i = 0; i < Formations.Count; i++)
                                {
                                    var index = i;
                                    var formation = Formations[index];
                                    <div class="collection-item">
                                        <div class="item-header">
                                            <strong>@formation.TypeFormation - @formation.NomDiplome</strong>
                                            <button type="button" class="btn-remove" @onclick="() => RemoveFormation(index)">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                        <div class="item-details">
                                            <span>École: @formation.Ecole</span>
                                            <span>Année: @formation.Annee</span>
                                            <span>Lieu: @formation.Ville, @formation.Pays</span>
                                        </div>
                                    </div>
                            }
                        </div>
                        }
                        
                        <button type="button" class="btn-add-item" @onclick="AddFormationForm">
                            <i class="bi bi-plus"></i> Ajouter une formation
                        </button>
                        
                        @if (showAddFormationForm)
                        {
                            <div class="add-item-form">
                                <div class="form-grid compact">
                        <div class="form-group">
                                        <label>Type de formation *</label>
                                        <select @bind="newFormation.TypeFormation" class="form-select" required>
                                            <option value="">Sélectionnez le type de formation</option>
                                            <option value="Initiale">Primaire</option>
                                            <option value="Secondaire">Secondaire</option>
                                            <option value="Humanitaires">Humanitaires</option>
                                            <option value="Universitaire">Universitaire</option>
                                            <option value="Formation">Formation</option>
                                            <option value="Perfectionnement">Perfectionnement</option>
                                            <option value="Spécialisée">Spécialisée</option>
                                            <option value="Internationale">Internationale</option>
                                            <option value="Police">Police</option>
                                            <option value="Technique">Technique</option>
                                            <option value="Linguistique">Linguistique</option>
                                            <option value="Sécuritaire">Sécuritaire</option>
                                            <option value="Judiciaire">Judiciaire</option>
                                            <option value="Management">Management</option>
                                            <option value="Autre">Autres</option>
                                        </select>
                        </div>
                        <div class="form-group">
                                        <label>École *</label>
                                        <input @bind="newFormation.Ecole" type="text" class="form-input" required />
                        </div>
                        <div class="form-group">
                                        <label>Pays *</label>
                                        <input @bind="newFormation.Pays" type="text" class="form-input" required />
                        </div>
                        <div class="form-group">
                                        <label>Ville *</label>
                                        <input @bind="newFormation.Ville" type="text" class="form-input" required />
                                    </div>
                                    <div class="form-group">
                                        <label>Année *</label>
                                        <input @bind="newFormation.Annee" @bind:after="ValidateFormationYear" type="number" class="form-input" required />
                                        @if (HasValidationError("FormationYear"))
                                        {
                                            <div class="validation-error">@GetValidationError("FormationYear")</div>
                                        }
                                    </div>
                                    <div class="form-group">
                                        <label>Diplôme *</label>
                                        <input @bind="newFormation.Diplome" type="text" class="form-input" required />
                                    </div>
                                    <div class="form-group">
                                        <label>Nom du diplôme *</label>
                                        <input @bind="newFormation.NomDiplome" type="text" class="form-input" required />
                                    </div>
                                    <div class="form-group">
                                        <label>Durée * (max 20 caractères)</label>
                                        <input @bind="newFormation.Duree" type="text" class="form-input" maxlength="20" required placeholder="Ex: 6 mois, 2 ans" />
                                    </div>
                                    <div class="form-group">
                                        <label>Nature * (max 20 caractères)</label>
                                        <input @bind="newFormation.Nature" type="text" class="form-input" maxlength="20" required placeholder="Ex: Théorique, Pratique" />
                                    </div>
                                </div>
                                @if (!string.IsNullOrEmpty(errorMessageFormation))
                                {
                                    <div class="validation-error" style="margin-top: 10px;">
                                        <i class="bi bi-exclamation-triangle"></i> @errorMessageFormation
                                    </div>
                                }
                                <div class="form-actions">
                                    <button type="button" class="btn-modern btn-outline" @onclick="CancelAddFormation">Annuler</button>
                                    <button type="button" class="btn-modern btn-success" @onclick="SaveFormation">Ajouter</button>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            }
            
            <!-- Étape 6: Contact -->
            @if (currentStep == 6)
            {
                <div class="form-step active">
                    <div class="step-header">
                        <i class="bi bi-house"></i>
                        <h3>Étape 6: Adresse et Contact</h3>
                        <p>Informations de contact et d'adresse</p>
                        </div>
                    <div class="form-grid compact">
                        <div class="form-group">
                            <label for="numeroRue">Numéro de rue *</label>
                            <input type="text" id="numeroRue" @bind="Policier.NumeroRue" required
                                   class="form-input" placeholder="Entrez le numéro de rue" />
                            @if (HasValidationError("NumeroRue"))
                            {
                                <div class="validation-error">@GetValidationError("NumeroRue")</div>
                            }
                        </div>
                        <div class="form-group">
                            <label for="rue">Rue *</label>
                            <input type="text" id="rue" @bind="Policier.Rue" required
                                   class="form-input" placeholder="Entrez le nom de la rue" />
                            @if (HasValidationError("Rue"))
                            {
                                <div class="validation-error">@GetValidationError("Rue")</div>
                            }
                        </div>
                        <div class="form-group">
                            <label for="commune">Commune *</label>
                            <input type="text" id="commune" @bind="Policier.Commune" required
                                   class="form-input" placeholder="Entrez la commune" />
                            @if (HasValidationError("Commune"))
                            {
                                <div class="validation-error">@GetValidationError("Commune")</div>
                            }
                        </div>
                        <div class="form-group">
                            <label for="telephone">Téléphone *</label>
                            <input type="tel" id="telephone" @bind="Policier.Telephone" required
                                   class="form-input" placeholder="Entrez le numéro de téléphone" />
                            @if (HasValidationError("Telephone"))
                            {
                                <div class="validation-error">@GetValidationError("Telephone")</div>
                            }
                        </div>
                        </div>
                </div>
            }
            
            <!-- Étape 7: Langues -->
            @if (currentStep == 7)
            {
                <div class="form-step active">
                    <div class="step-header">
                        <i class="bi bi-translate"></i>
                        <h3>Étape 7: Langues</h3>
                        <p>Langues parlées par le policier</p>
                    </div>
                    
                    <div class="collection-section">
                        <h4><i class="bi bi-chat-text"></i> Langues parlées</h4>
                        
                        @if (Langues.Any())
                        {
                            <div class="collection-items">
                                @for (int i = 0; i < Langues.Count; i++)
                                {
                                    var index = i;
                                    var langue = Langues[index];
                                    <div class="collection-item">
                                        <div class="item-header">
                                            <strong>@langue.Libelle (É:@langue.NiveauEcriture/L:@langue.NiveauLecture)</strong>
                                            <button type="button" class="btn-remove" @onclick="() => RemoveLangue(index)">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                }
                            </div>
                        }
                        
                        <button type="button" class="btn-add-item" @onclick="AddLangueForm">
                            <i class="bi bi-plus"></i> Ajouter une langue
                        </button>
                        
                        @if (showAddLangueForm)
                        {
                            <div class="add-item-form">
                                <div class="form-grid compact">
                        <div class="form-group">
                                        <label>Langue *</label>
                                        <select @bind="newLangue.Libelle" class="form-select" required>
                                            <option value="">Sélectionnez une langue</option>
                                            <option value="Français">Français</option>
                                            <option value="Lingala">Lingala</option>
                                            <option value="Swahili">Swahili</option>
                                            <option value="Kikongo">Kikongo</option>
                                            <option value="Tshiluba">Tshiluba</option>
                                            <option value="Anglais">Anglais</option>
                                            <option value="Autres">Autres</option>
                                        </select>
                        </div>
                        <div class="form-group">
                                        <label>Niveau écriture (1-5) *</label>
                                        <select @bind="newLangue.NiveauEcriture" class="form-select" required>
                                            <option value="0">Sélectionnez le niveau</option>
                                            <option value="1">1 - Débutant</option>
                                            <option value="2">2 - Élémentaire</option>
                                            <option value="3">3 - Intermédiaire</option>
                                            <option value="4">4 - Avancé</option>
                                            <option value="5">5 - Natif</option>
                                        </select>
                        </div>
                        <div class="form-group">
                                        <label>Niveau lecture (1-5) *</label>
                                        <select @bind="newLangue.NiveauLecture" class="form-select" required>
                                            <option value="0">Sélectionnez le niveau</option>
                                            <option value="1">1 - Débutant</option>
                                            <option value="2">2 - Élémentaire</option>
                                            <option value="3">3 - Intermédiaire</option>
                                            <option value="4">4 - Avancé</option>
                                            <option value="5">5 - Natif</option>
                                        </select>
                        </div>
                                </div>
                                @if (!string.IsNullOrEmpty(errorMessageLangue))
                                {
                                    <div class="validation-error" style="margin-top: 10px;">
                                        <i class="bi bi-exclamation-triangle"></i> @errorMessageLangue
                                    </div>
                                }
                                <div class="form-actions">
                                    <button type="button" class="btn-modern btn-outline" @onclick="CancelAddLangue">Annuler</button>
                                    <button type="button" class="btn-modern btn-success" @onclick="SaveLangue">Ajouter</button>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            }

            <!-- Étape 8: Sports -->
            @if (currentStep == 8)
            {
                <div class="form-step active">
                    <div class="step-header">
                        <i class="bi bi-trophy"></i>
                        <h3>Étape 8: Sports pratiqués</h3>
                        <p>Sports et activités physiques du policier</p>
                    </div>
                    
                    <div class="collection-section">
                        <h4><i class="bi bi-bicycle"></i> Sports pratiqués</h4>
                        
                        @if (Sports.Any())
                        {
                            <div class="collection-items">
                                @for (int i = 0; i < Sports.Count; i++)
                                {
                                    var index = i;
                                    var sport = Sports[index];
                                    <div class="collection-item">
                                        <div class="item-header">
                                            <strong>@sport.Libelle</strong>
                                            <button type="button" class="btn-remove" @onclick="() => RemoveSport(index)">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                }
                            </div>
                        }
                        
                        <button type="button" class="btn-add-item" @onclick="AddSportForm">
                            <i class="bi bi-plus"></i> Ajouter un sport
                        </button>
                        
                        @if (showAddSportForm)
                        {
                            <div class="add-item-form">
                    <div class="form-grid compact">
                        <div class="form-group">
                                        <label>Sport *</label>
                                        <input @bind="newSport.Libelle" type="text" class="form-input" required placeholder="Ex: Football, Basketball, Natation" />
                        </div>
                                </div>
                                <div class="form-actions">
                                    <button type="button" class="btn-modern btn-outline" @onclick="CancelAddSport">Annuler</button>
                                    <button type="button" class="btn-modern btn-success" @onclick="SaveSport">Ajouter</button>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            }

            <!-- Étape 9: Distinctions -->
            @if (currentStep == 9)
            {
                <div class="form-step active">
                    <div class="step-header">
                        <i class="bi bi-award"></i>
                        <h3>Étape 9: Distinctions et Historiques</h3>
                        <p>Médailles, décorations, historiques des affectations, fonctions et grades</p>
                    </div>
                    
                    <div class="collection-section">
                        <h4><i class="bi bi-gem"></i> Distinctions honorifiques</h4>
                        
                        @if (Distinctions.Any())
                        {
                            <div class="collection-items">
                                @for (int i = 0; i < Distinctions.Count; i++)
                                {
                                    var index = i;
                                    var distinction = Distinctions[index];
                                    <div class="collection-item">
                                        <div class="item-header">
                                            <strong>@distinction.Motif</strong>
                                            <button type="button" class="btn-remove" @onclick="() => RemoveDistinction(index)">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                        <div class="item-details">
                                            <span><i class="bi bi-calendar"></i> @distinction.DateDecision.ToString("dd/MM/yyyy")</span>
                                            @if (!string.IsNullOrEmpty(distinction.NumeroDecision))
                                            {
                                                <span><i class="bi bi-file-text"></i> N° @distinction.NumeroDecision</span>
                            }
                        </div>
                                    </div>
                                }
                            </div>
                        }
                        
                        <button type="button" class="btn-add-item" @onclick="AddDistinctionForm">
                            <i class="bi bi-plus"></i> Ajouter une distinction
                        </button>
                        
                        @if (showAddDistinctionForm)
                        {
                            <div class="add-item-form">
                    <div class="form-grid compact">
                        <div class="form-group">
                                        <label>Motif de la distinction *</label>
                                        <input @bind="newDistinction.Motif" type="text" class="form-input" required placeholder="Ex: Mérite professionnel, Acte de bravoure" />
                        </div>
                        <div class="form-group">
                                        <label>Date de décision *</label>
                                        <input @bind="newDistinction.DateDecision" type="date" class="form-input" required />
                        </div>
                        <div class="form-group">
                                        <label>Numéro de décision *</label>
                                        <input @bind="newDistinction.NumeroDecision" type="text" class="form-input" required placeholder="Numéro de l'arrêté ou décision" />
                        </div>
                                </div>
                                <div class="form-actions">
                                    <button type="button" class="btn-modern btn-outline" @onclick="CancelAddDistinction">Annuler</button>
                                    <button type="button" class="btn-modern btn-success" @onclick="SaveDistinction">Ajouter</button>
                                </div>
                                @if (!string.IsNullOrEmpty(errorMessageDistinction))
                                {
                                    <div class="alert alert-danger">
                                        <i class="bi bi-exclamation-triangle"></i> @errorMessageDistinction
                                    </div>
                                }
                            </div>
                        }
                    </div>
                    
                    <!-- Historique des affectations -->
                    <div class="collection-section">
                        <h4><i class="bi bi-building"></i> Historique des affectations</h4>
                        
                        @if (HistAffectations.Any())
                        {
                            <div class="collection-items">
                                @for (int i = 0; i < HistAffectations.Count; i++)
                                {
                                    var affectation = HistAffectations[i];
                                    <div class="collection-item">
                                        <div class="item-content">
                                            <div class="item-header">
                                                <strong>@affectation.Denomination</strong>
                                                <span class="item-date">@affectation.DateActe.ToShortDateString()</span>
                                            </div>
                                            <div class="item-details">
                                                <span><i class="bi bi-geo-alt"></i> @affectation.Lieu</span>
                                                <span><i class="bi bi-file-text"></i> @affectation.ActeDenomination</span>
                                            </div>
                                        </div>
                                        <button type="button" class="btn-remove" @onclick="() => RemoveHistAffectation(i)">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                            }
                        </div>
                        }
                        else
                        {
                            <p class="no-items">Aucune affectation dans l'historique</p>
                        }
                        
                        <button type="button" class="btn-add-item" @onclick="AddHistAffectationForm">
                            <i class="bi bi-plus"></i> Ajouter une affectation
                        </button>
                        
                        @if (showAddHistAffectationForm)
                        {
                            <div class="add-item-form">
                                <div class="form-grid compact">
                        <div class="form-group">
                                        <label>Lieu *</label>
                                        <input @bind="newHistAffectation.Lieu" type="text" class="form-input" required placeholder="Lieu d'affectation" />
                        </div>
                        <div class="form-group">
                                        <label>Dénomination *</label>
                                        <input @bind="newHistAffectation.Denomination" type="text" class="form-input" required placeholder="Dénomination du poste" />
                        </div>
                        <div class="form-group">
                                        <label>Acte de nomination *</label>
                                        <input @bind="newHistAffectation.ActeDenomination" type="text" class="form-input" required placeholder="Référence de l'acte" />
                        </div>
                                    <div class="form-group">
                                        <label>Date de l'acte *</label>
                                        <input @bind="newHistAffectation.DateActe" type="date" class="form-input" required />
                                    </div>
                                </div>
                                @if (!string.IsNullOrEmpty(errorMessageHistAffectation))
                                {
                                    <div class="validation-error" style="margin-top: 10px;">
                                        <i class="bi bi-exclamation-triangle"></i> @errorMessageHistAffectation
                                    </div>
                                }
                                <div class="form-actions">
                                    <button type="button" class="btn-modern btn-outline" @onclick="CancelAddHistAffectation">Annuler</button>
                                    <button type="button" class="btn-modern btn-success" @onclick="SaveHistAffectation">Ajouter</button>
                                </div>
                            </div>
                        }
                    </div>
                    
                    <!-- Historique des fonctions -->
                    <div class="collection-section">
                        <h4><i class="bi bi-person-badge"></i> Historique des fonctions</h4>
                        
                        @if (HistFonctions.Any())
                        {
                            <div class="collection-items">
                                @for (int i = 0; i < HistFonctions.Count; i++)
                                {
                                    var fonction = HistFonctions[i];
                                    <div class="collection-item">
                                        <div class="item-content">
                                            <div class="item-header">
                                                <strong>@fonction.IntituleFonction</strong>
                                                <span class="item-date">@fonction.DatePriseFonction.ToShortDateString() - @fonction.DateFin.ToShortDateString()</span>
                                            </div>
                                        </div>
                                        <button type="button" class="btn-remove" @onclick="() => RemoveHistFonction(i)">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                }
                            </div>
                        }
                        else
                        {
                            <p class="no-items">Aucune fonction dans l'historique</p>
                        }
                        
                        <button type="button" class="btn-add-item" @onclick="AddHistFonctionForm">
                            <i class="bi bi-plus"></i> Ajouter une fonction
                        </button>
                        
                        @if (showAddHistFonctionForm)
                        {
                            <div class="add-item-form">
                                <div class="form-grid compact">
                                    <div class="form-group">
                                        <label>Intitulé de la fonction *</label>
                                        <input @bind="newHistFonction.IntituleFonction" type="text" class="form-input" required placeholder="Ex: Chef de poste, Enquêteur..." />
                                    </div>
                                    <div class="form-group">
                                        <label>Date de prise de fonction *</label>
                                        <input @bind="newHistFonction.DatePriseFonction" type="date" class="form-input" required />
                                    </div>
                                    <div class="form-group">
                                        <label>Date de fin *</label>
                                        <input @bind="newHistFonction.DateFin" type="date" class="form-input" required />
                                    </div>
                                </div>
                                @if (!string.IsNullOrEmpty(errorMessageHistFonction))
                                {
                                    <div class="validation-error" style="margin-top: 10px;">
                                        <i class="bi bi-exclamation-triangle"></i> @errorMessageHistFonction
                                    </div>
                                }
                                <div class="form-actions">
                                    <button type="button" class="btn-modern btn-outline" @onclick="CancelAddHistFonction">Annuler</button>
                                    <button type="button" class="btn-modern btn-success" @onclick="SaveHistFonction">Ajouter</button>
                                </div>
                            </div>
                        }
                    </div>
                    
                    <!-- Historique des grades -->
                    <div class="collection-section">
                        <h4><i class="bi bi-star"></i> Historique des grades</h4>
                        
                        @if (HistGrades.Any())
                        {
                            <div class="collection-items">
                                @for (int i = 0; i < HistGrades.Count; i++)
                                {
                                    var grade = HistGrades[i];
                                    <div class="collection-item">
                                        <div class="item-content">
                                            <div class="item-header">
                                                <strong>@grade.Intitule</strong>
                                                <span class="item-date">@grade.DateNomination.ToShortDateString()</span>
                                            </div>
                                            <div class="item-details">
                                                <span><i class="bi bi-file-text"></i> @grade.ActeNomination</span>
                                                <span><i class="bi bi-calendar-check"></i> Acte: @grade.DateActe.ToShortDateString()</span>
                                            </div>
                                        </div>
                                        <button type="button" class="btn-remove" @onclick="() => RemoveHistGrade(i)">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                }
                            </div>
                        }
                        else
                        {
                            <p class="no-items">Aucun grade dans l'historique</p>
                        }
                        
                        <button type="button" class="btn-add-item" @onclick="AddHistGradeForm">
                            <i class="bi bi-plus"></i> Ajouter un grade
                        </button>
                        
                        @if (showAddHistGradeForm)
                        {
                            <div class="add-item-form">
                                <div class="form-grid compact">
                                    <div class="form-group">
                                        <label>Intitulé du grade *</label>
                                        <select @bind="newHistGrade.Intitule" class="form-select" required>
                                            <option value="">Sélectionnez un grade</option>
                                            <option value="Agent">Agent</option>
                                            <option value="Agent de 1ère classe">Agent de 1ère classe</option>
                                            <option value="Brigadier">Brigadier</option>
                                            <option value="Brigadier-chef">Brigadier-chef</option>
                                            <option value="Sergent">Sergent</option>
                                            <option value="Sergent-major">Sergent-major</option>
                                            <option value="Adjudant">Adjudant</option>
                                            <option value="Adjudant-chef">Adjudant-chef</option>
                                            <option value="Sous-lieutenant">Sous-lieutenant</option>
                                            <option value="Lieutenant">Lieutenant</option>
                                            <option value="Capitaine">Capitaine</option>
                                            <option value="Commandant">Commandant</option>
                                            <option value="Lieutenant-colonel">Lieutenant-colonel</option>
                                            <option value="Colonel">Colonel</option>
                                            <option value="Commissaire divisionnaire">Commissaire divisionnaire</option>
                                            <option value="Commissaire général">Commissaire général</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>Acte de nomination *</label>
                                        <input @bind="newHistGrade.ActeNomination" type="text" class="form-input" required placeholder="Référence de l'acte de nomination" />
                                    </div>
                                    <div class="form-group">
                                        <label>Date de nomination *</label>
                                        <input @bind="newHistGrade.DateNomination" type="date" class="form-input" required />
                                    </div>
                                    <div class="form-group">
                                        <label>Date de l'acte *</label>
                                        <input @bind="newHistGrade.DateActe" type="date" class="form-input" required />
                                    </div>
                                </div>
                                @if (!string.IsNullOrEmpty(errorMessageHistGrade))
                                {
                                    <div class="validation-error" style="margin-top: 10px;">
                                        <i class="bi bi-exclamation-triangle"></i> @errorMessageHistGrade
                                    </div>
                                }
                                <div class="form-actions">
                                    <button type="button" class="btn-modern btn-outline" @onclick="CancelAddHistGrade">Annuler</button>
                                    <button type="button" class="btn-modern btn-success" @onclick="SaveHistGrade">Ajouter</button>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            }

            <!-- Étape 10: Permis de conduire -->
            @if (currentStep == 10)
            {
                <div class="form-step active">
                    <div class="step-header">
                        <i class="bi bi-car-front"></i>
                        <h3>Étape 10: Permis de conduire</h3>
                        <p>Informations sur le permis de conduire</p>
                    </div>
                    <div class="form-grid compact">
                        <div class="form-group">
                            <label for="categoriePermis">Catégorie de permis</label>
                            <select id="categoriePermis" @bind="Policier.CategoriePermis" class="form-select">
                                <option value="">Aucun permis</option>
                                <option value="A">A - Motocyclette</option>
                                <option value="B">B - Véhicule léger</option>
                                <option value="C">C - Poids lourd</option>
                                <option value="D">D - Transport en commun</option>
                                <option value="E">E - Remorque</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="numeroPermis">Numéro de permis</label>
                            <input type="text" id="numeroPermis" @bind="Policier.NumeroPermis" 
                                   class="form-input" placeholder="Numéro du permis de conduire" />
                        </div>
                        <div class="form-group">
                            <label for="dateDelivrancePermis">Date de délivrance</label>
                            <input type="date" id="dateDelivrancePermis" @bind="Policier.DateDelivrancePermis" 
                                   class="form-input" />
                            @if (HasValidationError("DateDelivrancePermis"))
                            {
                                <div class="validation-error">@GetValidationError("DateDelivrancePermis")</div>
                            }
                        </div>
                    </div>
                </div>
            }

            <!-- Étape 11: Informations médicales -->
            @if (currentStep == 11)
            {
                <div class="form-step active">
                    <div class="step-header">
                        <i class="bi bi-heart-pulse"></i>
                        <h3>Étape 11: Informations médicales</h3>
                        <p>Groupe sanguin et informations médicales</p>
                    </div>
                    <div class="form-grid compact">
                        <div class="form-group">
                            <label for="groupeSanguin">Groupe sanguin *</label>
                            <select id="groupeSanguin" @bind="Policier.GroupeSanguin" required class="form-select">
                                <option value="">Sélectionnez le groupe sanguin</option>
                                <option value="A">A</option>
                                <option value="B">B</option>
                                <option value="AB">AB</option>
                                <option value="O">O</option>
                            </select>
                            @if (HasValidationError("GroupeSanguin"))
                            {
                                <div class="validation-error">@GetValidationError("GroupeSanguin")</div>
                            }
                        </div>
                        <div class="form-group">
                            <label for="rhesus">Rhésus *</label>
                            <select id="rhesus" @bind="Policier.Rhesus" required class="form-select">
                                <option value="">Sélectionnez le rhésus</option>
                                <option value="Positif">Positif (+)</option>
                                <option value="Négatif">Négatif (-)</option>
                            </select>
                            @if (HasValidationError("Rhesus"))
                            {
                                <div class="validation-error">@GetValidationError("Rhesus")</div>
                            }
                        </div>
                    </div>
                </div>
            }

            <!-- Étape 12: Unités et affectations -->
            @if (currentStep == 12)
            {
                <div class="form-step active">
                    <div class="step-header">
                        <i class="bi bi-building"></i>
                        <h3>Étape 12: Unités et affectations</h3>
                        <p>Informations sur les unités et affectations</p>
                    </div>
                    <div class="form-grid compact">
                        <div class="form-group">
                            <label for="uniteMere">Unité mère *</label>
                            <input type="text" id="uniteMere" @bind="Policier.UniteMere" required
                                   class="form-input" placeholder="Unité mère d'affectation" />
                            @if (HasValidationError("UniteMere"))
                            {
                                <div class="validation-error">@GetValidationError("UniteMere")</div>
                            }
                        </div>
                        <div class="form-group">
                            <label for="uniteAffectation">Unité d'affectation *</label>
                            <input type="text" id="uniteAffectation" @bind="Policier.UniteAffectation" required
                                   class="form-input" placeholder="Unité d'affectation actuelle" />
                            @if (HasValidationError("UniteAffectation"))
                            {
                                <div class="validation-error">@GetValidationError("UniteAffectation")</div>
                            }
                        </div>
                        <div class="form-group">
                            <label for="nomUnite">Nom de l'unité *</label>
                            <input type="text" id="nomUnite" @bind="Policier.NomUnite" required
                                   class="form-input" placeholder="Nom complet de l'unité" />
                            @if (HasValidationError("NomUnite"))
                            {
                                <div class="validation-error">@GetValidationError("NomUnite")</div>
                            }
                        </div>
                        <div class="form-group">
                            <label for="lieuAffectation">Lieu d'affectation *</label>
                            <input type="text" id="lieuAffectation" @bind="Policier.LieuAffectation" required
                                   class="form-input" placeholder="Lieu géographique d'affectation" />
                            @if (HasValidationError("LieuAffectation"))
                            {
                                <div class="validation-error">@GetValidationError("LieuAffectation")</div>
                            }
                        </div>
                        <div class="form-group">
                            <label for="deptBnDistGpt">Dept/Bn/Dist/Gpt</label>
                            <input type="text" id="deptBnDistGpt" @bind="Policier.DeptBnDistGpt"
                                   class="form-input" placeholder="Département/Bataillon/District/Groupement" />
                        </div>
                        <div class="form-group">
                            <label for="buCielCiatEscDet">Bu/Ciel/Ciat/Esc/Det</label>
                            <input type="text" id="buCielCiatEscDet" @bind="Policier.BuCielCiatEscDet"
                                   class="form-input" placeholder="Bureau/Commissariat/Escadron/Détachement" />
                        </div>
                        <div class="form-group">
                            <label for="secPiSciatSousDet">Sec/Pi/Sciat/SousDet</label>
                            <input type="text" id="secPiSciatSousDet" @bind="Policier.SecPiSciatSousDet"
                                   class="form-input" placeholder="Section/Peloton/Sous-commissariat/Sous-détachement" />
                        </div>
                    </div>
                </div>
            }

            <!-- Étape 13: Documents et signatures -->
            @if (currentStep == 13)
            {
                <div class="form-step active">
                    <div class="step-header">
                        <i class="bi bi-file-earmark-text"></i>
                        <h3>Étape 13: Acte de nomination</h3>
                        <p>Actes de nomination</p>
                    </div>
                    <div class="form-grid compact">
                        <div class="form-group">
                            <label for="acteNominationFonction">Acte de nomination *</label>
                            <input type="text" id="acteNominationFonction" @bind="Policier.ActeNominationFonction" required
                                   class="form-input" placeholder="Référence de l'acte de nomination à la fonction" />
                            @if (HasValidationError("ActeNominationFonction"))
                            {
                                <div class="validation-error">@GetValidationError("ActeNominationFonction")</div>
                            }
                        </div>
                        <div class="form-group">
                            <label for="dateActe">Date de l'acte</label>
                            <input type="date" id="dateActe" @bind="Policier.DateActe"
                                   class="form-input" />
                            @if (HasValidationError("DateActe"))
                            {
                                <div class="validation-error">@GetValidationError("DateActe")</div>
                            }
                        </div>
                       
                        
                    
                    </div>
                </div>
            }

            <!-- Étape 14: Personnes à prévenir et observations -->
            @if (currentStep == 14)
            {
                <div class="form-step active">
                    <div class="step-header">
                        <i class="bi bi-telephone"></i>
                        <h3>Étape 14: Personnes à prévenir</h3>
                        <p>Contacts d'urgence et observations</p>
                    </div>
                    
                    <div class="collection-section">
                        <h4><i class="bi bi-person-check"></i> Personnes à prévenir en cas d'urgence</h4>
                        
                        @if (PersonnesAPrevenir.Any())
                        {
                            <div class="collection-items">
                                @for (int i = 0; i < PersonnesAPrevenir.Count; i++)
                                {
                                    var index = i;
                                    var personne = PersonnesAPrevenir[index];
                                    <div class="collection-item">
                                        <div class="item-header">
                                            <strong>@personne.Nom @personne.PostNom @personne.Prenom</strong>
                                            <button type="button" class="btn-remove" @onclick="() => RemovePersonneAPrevenir(index)">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                        <div class="item-details">
                                            <span><i class="bi bi-telephone"></i> @personne.Telephone</span>
                                            <span><i class="bi bi-geo-alt"></i> @personne.NumeroRue @personne.Rue, @personne.Commune</span>
                                        </div>
                                    </div>
                                }
                            </div>
                        }
                        
                        <button type="button" class="btn-add-item" @onclick="AddPersonneAPrevenirForm">
                            <i class="bi bi-plus"></i> Ajouter une personne à prévenir
                        </button>
                        
                        @if (showAddPersonneAPrevenirForm)
                        {
                            <div class="add-item-form">
                                <div class="form-grid compact">
                        <div class="form-group">
                                        <label>Nom *</label>
                                        <input @bind="newPersonneAPrevenir.Nom" type="text" class="form-input" required />
                        </div>
                        <div class="form-group">
                                        <label>Post-nom</label>
                                        <input @bind="newPersonneAPrevenir.PostNom" type="text" class="form-input" />
                        </div>
                        <div class="form-group">
                                        <label>Prénom</label>
                                        <input @bind="newPersonneAPrevenir.Prenom" type="text" class="form-input" />
                        </div>
                        <div class="form-group">
                                        <label>Téléphone *</label>
                                        <input @bind="newPersonneAPrevenir.Telephone" type="tel" class="form-input" required />
                        </div>
                        <div class="form-group">
                                        <label>Numéro rue *</label>
                                        <input @bind="newPersonneAPrevenir.NumeroRue" type="text" class="form-input" required />
                        </div>
                                    <div class="form-group">
                                        <label>Rue *</label>
                                        <input @bind="newPersonneAPrevenir.Rue" type="text" class="form-input" required />
                                    </div>
                                    <div class="form-group">
                                        <label>Commune *</label>
                                        <input @bind="newPersonneAPrevenir.Commune" type="text" class="form-input" required />
                                    </div>
                                </div>
                                <div class="form-actions">
                                    <button type="button" class="btn-modern btn-outline" @onclick="CancelAddPersonneAPrevenir">Annuler</button>
                                    <button type="button" class="btn-modern btn-success" @onclick="SavePersonneAPrevenir">Ajouter</button>
                    </div>
                </div>
            }
                    </div>
                    
                    <div class="form-group">
                        <label for="observation">Observations</label>
                        <textarea id="observation" @bind="Policier.Observation" rows="4"
                                  class="form-textarea" placeholder="Observations particulières concernant ce policier"></textarea>
                    </div>
                </div>
            }

            
        </div>

        <!-- Navigation des étapes -->
        <div class="step-navigation">
            @if (currentStep > 1)
            {
                <button type="button" class="btn-modern btn-outline" @onclick="PreviousStep">
                    <i class="bi bi-arrow-left"></i>
                    Précédent
                </button>
            }
            else
            {
                <button type="button" class="btn-modern btn-outline" @onclick="GoBack">
                    <i class="bi bi-arrow-left"></i>
                    Retour
                </button>
            }

            @if (currentStep < totalSteps)
            {
                @if (currentStep == 1)
                {
                    <div class="step-actions">
                        <button type="button" class="btn-modern btn-secondary" @onclick="VerifyNutp" disabled="@(isNutpVerifying || string.IsNullOrEmpty(Policier.NumeroNutp))">
                            @if (isNutpVerifying)
                            {
                                <i class="bi bi-hourglass-split"></i>
                                <span>Vérification...</span>
                            }
                            else
                            {
                                <i class="bi bi-search"></i>
                                <span>Vérifier NUTP</span>
                            }
                        </button>
                        <button type="button" class="btn-modern btn-primary" @onclick="NextStep" disabled="@(!isNutpVerified)">
                            Suivant
                            <i class="bi bi-arrow-right"></i>
                        </button>
                    </div>
                }
                else
            {
                <button type="button" class="btn-modern btn-primary" @onclick="NextStep">
                    Suivant
                    <i class="bi bi-arrow-right"></i>
                </button>
                }
            }
            else
            {
                <button type="button" class="btn-modern btn-primary" @onclick="SubmitForm" disabled="@IsSubmitting">
                    <i class="bi bi-check"></i>
                    @if (IsSubmitting)
                    {
                        <span>@saveProgress (@saveStep/@totalSaveSteps)</span>
                    }
                    else
                    {
                        @(IsEdit ? "Modifier" : "Ajouter")
                    }
                </button>
            }
        </div>
    </div>
</div>

<!-- Modal de Capture Photo supprimé - Caméra intégrée directement dans l'étape 1 -->

@code {
    [Parameter]
    public string? Id { get; set; }

    private Policier Policier { get; set; } = new();
    private bool IsEdit => !string.IsNullOrEmpty(Id);
    private bool IsSubmitting = false;
    private string saveProgress = "";
    private int saveStep = 0;
    private int totalSaveSteps = 3; // Validation + Sauvegarde + Finalisation
    
    // Liste des commissariats pour le select
    private List<Commissariat>? commissariats;
    
    // Données géographiques RDC
    private List<ProvinceRdc> provinces = new();
    private List<string> territoiresCommunes = new();
    private List<string> territoiresCommunesCommissariat = new();
    private string selectedProvinceOrigine = "";
    
    // Propriétés calculées pour affichage readonly
    private string SelectedProvince { get; set; } = "";
    
    // Variables temporaires pour District et Territoire du commissariat (saisie manuelle)
    private string DistrictCommissariat { get; set; } = "";
    private string TerritoireCommissariat { get; set; } = "";
    
    // Variables pour la vérification du NUTP
    private bool isNutpVerifying = false;
    private bool isNutpVerified = false;
    private string nutpVerificationMessage = "";
    private bool nutpVerificationError = false;
    
    // Variables pour les collections
    private List<Conjoint> Conjoints = new();
    private List<Enfant> Enfants = new();
    private List<Formation> Formations = new();
    private List<Langue> Langues = new();
    private List<Sport> Sports = new();
    private List<DistinctionHonorifique> Distinctions = new();
    private List<PersonnePrevenir> PersonnesAPrevenir = new();
    private List<HistAffectation> HistAffectations = new();
    private List<HistFonction> HistFonctions = new();
    private List<HistGrade> HistGrades = new();
    
    // Variables pour les formulaires d'ajout
    private bool showAddConjointForm = false;
    private bool showAddEnfantForm = false;
    private bool showAddFormationForm = false;
    private bool showAddLangueForm = false;
    private bool showAddSportForm = false;
    private bool showAddDistinctionForm = false;
    private bool showAddHistAffectationForm = false;
    private bool showAddHistFonctionForm = false;
    private bool showAddHistGradeForm = false;
    private bool showAddPersonneAPrevenirForm = false;
    
    // Variables pour la gestion de la caméra intégrée
    private bool isCameraActive = false;
    private string cameraErrorMessage = string.Empty;
    private string selectedCameraId = string.Empty;
    private bool cameraInitialized = false;
    private string capturedPhotoDataUrl = string.Empty;
    
    // Objets temporaires pour les nouveaux items
    private Conjoint newConjoint = new();
    private Enfant newEnfant = new();
    private Formation newFormation = new();
    private Langue newLangue = new();
    private Sport newSport = new();
    private DistinctionHonorifique newDistinction = new();
    private HistAffectation newHistAffectation = new();
    private HistFonction newHistFonction = new();
    private HistGrade newHistGrade = new();
    private PersonnePrevenir newPersonneAPrevenir = new();
    
    // Messages d'erreur pour les formulaires d'ajout
    private string errorMessageEnfant = "";
    private string errorMessageConjoint = "";
    private string errorMessageFormation = "";
    private string errorMessageLangue = "";
    private string errorMessageSport = "";
    private string errorMessageDistinction = "";
    private string errorMessageHistAffectation = "";
    private string errorMessageHistFonction = "";
    private string errorMessageHistGrade = "";
    private string errorMessagePersonne = "";
    
    // Étape actuelle du formulaire
    private int currentStep = 1;
    private int totalSteps = 14; // Réorganisé selon les nouvelles spécifications avec historiques dans l'étape 11
    private Dictionary<int, bool> stepValidated = new Dictionary<int, bool>();

    // Gestion des erreurs de validation
    private Dictionary<string, string> validationErrors = new();

    // Méthode pour ajouter une erreur de validation
    private void AddValidationError(string field, string message)
    {
        validationErrors[field] = message;
    }

    // Méthode pour vérifier s'il y a une erreur pour un champ
    private bool HasValidationError(string field)
    {
        return validationErrors.ContainsKey(field);
    }

    // Méthode pour obtenir le message d'erreur d'un champ
    private string GetValidationError(string field)
    {
        return validationErrors.TryGetValue(field, out var message) ? message : "";
    }

    // Méthode pour effacer toutes les erreurs de validation
    private void ClearValidationErrors()
    {
        validationErrors.Clear();
    }

    // Méthode pour effacer l'erreur d'un champ spécifique
    private void ClearValidationError(string field)
    {
        validationErrors.Remove(field);
    }

    // Méthode appelée quand l'état civil change
    private void OnEtatCivilChanged()
    {
        // Si l'état civil devient célibataire, vider les collections de famille
        if (Policier.EtatCivil == "Célibataire")
        {
            Policier.Conjoints?.Clear();
            Policier.Enfants?.Clear();
        }
        
        // Effacer les erreurs de validation liées à la famille
        ClearValidationError("Conjoints");
        ClearValidationError("Enfants");
        
        StateHasChanged();
    }
    
    // Méthode appelée quand le commissariat change
    private void UpdateCommissariatInfo()
    {
        if (!string.IsNullOrEmpty(Policier.IdCommissariat) && commissariats?.Any() == true)
        {
            var selectedCommissariat = commissariats.FirstOrDefault(c => c.Id == Policier.IdCommissariat);
            if (selectedCommissariat != null)
            {
                // La province est remplie automatiquement
                SelectedProvince = selectedCommissariat.Province ?? "";
                
                // Charger les territoires et communes de cette province
                if (!string.IsNullOrEmpty(SelectedProvince))
                {
                    territoiresCommunesCommissariat = GeographieService.GetTerritoiresEtCommunes(SelectedProvince);
                }
                else
                {
                    territoiresCommunesCommissariat.Clear();
                }
                
                // Réinitialiser la sélection de territoire/commune
                TerritoireCommissariat = "";
            }
        }
        else
        {
            SelectedProvince = "";
            territoiresCommunesCommissariat.Clear();
            TerritoireCommissariat = "";
        }
        StateHasChanged();
    }
    
    // Méthode pour charger les provinces RDC
    private void LoadProvincesRdc()
    {
        try
        {
            provinces = GeographieService.GetProvinces();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Erreur lors du chargement des provinces: {ex.Message}");
        }
    }
    
    // Méthode appelée quand la province d'origine change
    private void OnProvinceOrigineChanged()
    {
        if (!string.IsNullOrEmpty(selectedProvinceOrigine))
        {
            // Mettre à jour la propriété du policier
            Policier.ProvinceOrigine = selectedProvinceOrigine;
            
            // Charger les territoires et communes de cette province
            territoiresCommunes = GeographieService.GetTerritoiresEtCommunes(selectedProvinceOrigine);
            
            // Réinitialiser la sélection de territoire
            Policier.TerritoireOrigine = "";
        }
        else
        {
            Policier.ProvinceOrigine = "";
            territoiresCommunes.Clear();
            Policier.TerritoireOrigine = "";
        }
        StateHasChanged();
    }

    protected override async Task OnInitializedAsync()
    {
        // Initialiser le dictionnaire stepValidated
        stepValidated.Clear();
        for (int i = 1; i <= totalSteps; i++)
        {
            stepValidated[i] = false;
        }
        
        // Initialiser l'état de vérification du NUTP
        isNutpVerified = IsEdit; // En mode édition, considérer comme vérifié
        isNutpVerifying = false;
        nutpVerificationMessage = "";
        nutpVerificationError = false;
        
        // Charger les données géographiques
        LoadProvincesRdc();
        
        // Charger les commissariats dans tous les cas
        await LoadCommissariats();
        
        if (IsEdit)
        {
            await LoadPolicier();
        }
        else
        {
            InitializePolicier();
        }
    }

    private async Task LoadPolicier()
    {
        try
        {
            using var context = await ContextFactory.CreateDbContextAsync();
            var policier = await context.Policiers.FindAsync(Id);
            if (policier != null)
            {
                Policier = policier;
                
                // Charger les informations géographiques du commissariat
                if (!string.IsNullOrEmpty(Policier.IdCommissariat))
                {
                    var selectedCommissariat = commissariats?.FirstOrDefault(c => c.Id == Policier.IdCommissariat);
                    if (selectedCommissariat != null)
                    {
                        SelectedProvince = selectedCommissariat.Province ?? "";
                        if (!string.IsNullOrEmpty(SelectedProvince))
                        {
                            territoiresCommunesCommissariat = GeographieService.GetTerritoiresEtCommunes(SelectedProvince);
                        }
                    }
                }
                
                // Charger les valeurs géographiques du policier
                // Note: Pour l'instant, nous utilisons Commune pour stocker le territoire/commune
                // Le district reste une saisie manuelle
                TerritoireCommissariat = Policier.Commune ?? "";
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Erreur lors du chargement: {ex.Message}");
        }
    }

    private async Task LoadCommissariats()
    {
        try
        {
            using var context = await ContextFactory.CreateDbContextAsync();
            commissariats = await context.Commissariats
                .OrderBy(c => c.Province)
                .ThenBy(c => c.Nom)
                .ToListAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Erreur lors du chargement des commissariats: {ex.Message}");
        }
    }

    private async Task HandleSubmit()
    {
        if (IsSubmitting) return;

        IsSubmitting = true;
        try
        {
            // Mettre à jour les composants de date avant l'enregistrement
            UpdateDateComponents(Policier.DateNaissance);

            // Validation des dates avant enregistrement
            if (!ValidateDates())
            {
                Console.WriteLine("Erreur: Dates invalides détectées");
                return;
            }

            using var context = await ContextFactory.CreateDbContextAsync();
            
            if (IsEdit)
            {
                context.Policiers.Update(Policier);
            }
            else
            {
                Policier.Id = GenerateShortId();
                context.Policiers.Add(Policier);
                
                // Créer automatiquement un Fri après l'ajout du Policier
                await CreateFriForPolicier(context, Policier.Id);
            }

            await context.SaveChangesAsync();
            
            // Rediriger vers la liste des policiers
            Navigation.NavigateTo("/policiers");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Erreur lors de l'enregistrement: {ex.Message}");
        }
        finally
        {
            IsSubmitting = false;
        }
    }

    private async Task CreateFriForPolicier(BdPolicePncContext context, string policierId)
    {
        try
        {
            var currentDate = DateTime.Now;
            
            var fri = new Fri
            {
                Id = GenerateShortId(),
                DateRemplissage = currentDate,
                Jour = currentDate.Day,
                Mois = currentDate.Month.ToString(),
                Annee = currentDate.Year,
                Numero = $"FRI{policierId.Substring(0, 1)}",
                IdEnqueteur = "1d1fc19iip",  // id de l'enqueteur
                IdPolicier = policierId,
                IdCommissariat = Policier.IdCommissariat,
               

            };
            
            context.Fris.Add(fri);
            context.SaveChanges();
            Console.WriteLine($"Fri créé automatiquement pour le policier {policierId}");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Erreur lors de la création du Fri: {ex.Message}");
        }
    }

    private bool ValidateDates()
    {
        try
        {
            // Vérifier que les dates obligatoires sont dans la plage valide pour SQL Server
            var minDate = new DateTime(1753, 1, 1);
            var maxDate = new DateTime(9999, 12, 31);

            if (Policier.DateNaissance < minDate || Policier.DateNaissance > DateTime.Today)
            {
                Console.WriteLine($"Date de naissance invalide: {Policier.DateNaissance}");
                return false;
            }

            if (Policier.DateEntreePolice < minDate || Policier.DateEntreePolice > DateTime.Today)
            {
                Console.WriteLine($"Date d'entrée police invalide: {Policier.DateEntreePolice}");
                return false;
            }

            // Validation métier : La date de naissance ne peut pas être dans le futur
            if (Policier.DateNaissance > DateTime.Today)
            {
                Console.WriteLine("Erreur: La date de naissance ne peut pas être dans le futur");
                return false;
            }

            // Validation métier : La date d'entrée à la police ne peut pas être avant la date de naissance
            if (Policier.DateEntreePolice < Policier.DateNaissance)
            {
                Console.WriteLine("Erreur: La date d'entrée à la police ne peut pas être avant la date de naissance");
                return false;
            }

            // Validation métier : L'âge minimum pour entrer à la police est de 18 ans
            var ageEntreePolice = Policier.DateEntreePolice.Year - Policier.DateNaissance.Year;
            if (Policier.DateEntreePolice < Policier.DateNaissance.AddYears(ageEntreePolice))
            {
                ageEntreePolice--; 
            }
            
            if (ageEntreePolice < 18)
            {
                Console.WriteLine($"Erreur: L'âge minimum pour entrer à la police est de 18 ans. Âge calculé: {ageEntreePolice} ans");
                return false;
            }

            // Validation métier : La date d'entrée à la police ne peut pas être dans le futur
            if (Policier.DateEntreePolice > DateTime.Today)
            {
                Console.WriteLine("Erreur: La date d'entrée à la police ne peut pas être dans le futur");
                return false;
            }

            // Vérifier les dates optionnelles si elles ont des valeurs
            if (Policier.DateNomination.HasValue)
            {
                if (Policier.DateNomination.Value < minDate || Policier.DateNomination.Value > DateTime.Today)
                {
                    Console.WriteLine($"Date de nomination invalide: {Policier.DateNomination.Value}");
                    return false;
                }
                
                // Validation métier : La date de nomination ne peut pas être avant la date d'entrée à la police
                if (Policier.DateNomination.Value < Policier.DateEntreePolice)
                {
                    Console.WriteLine("Erreur: La date de nomination ne peut pas être avant la date d'entrée à la police");
                    return false;
                }
                
                // Validation métier : La date de nomination ne peut pas être dans le futur
                if (Policier.DateNomination.Value > DateTime.Today)
                {
                    Console.WriteLine("Erreur: La date de nomination ne peut pas être dans le futur");
                    return false;
                }
            }

            if (Policier.DatePriseFonction.HasValue)
            {
                if (Policier.DatePriseFonction.Value < minDate || Policier.DatePriseFonction.Value > DateTime.Today)
                {
                    Console.WriteLine($"Date de prise de fonction invalide: {Policier.DatePriseFonction.Value}");
                    return false;
                }
                
                // Validation métier : La date de prise de fonction ne peut pas être avant la date d'entrée à la police
                if (Policier.DatePriseFonction.Value < Policier.DateEntreePolice)
                {
                    Console.WriteLine("Erreur: La date de prise de fonction ne peut pas être avant la date d'entrée à la police");
                    return false;
                }
                
                // Validation métier : La date de prise de fonction ne peut pas être dans le futur
                if (Policier.DatePriseFonction.Value > DateTime.Today)
                {
                    Console.WriteLine("Erreur: La date de prise de fonction ne peut pas être dans le futur");
                    return false;
                }

                // Validation métier : Si on a une date de nomination du grade, elle doit être avant ou égale à la date de prise de fonction
                if (Policier.DateNomination.HasValue && Policier.DateNomination.Value > Policier.DatePriseFonction.Value)
                {
                    Console.WriteLine("Erreur: La date de nomination du grade ne peut pas être après la date de prise de fonction");
                    return false;
                }
            }

            if (Policier.DateActe.HasValue)
            {
                if (Policier.DateActe.Value < minDate || Policier.DateActe.Value > DateTime.Today)
                {
                    Console.WriteLine($"Date d'acte invalide: {Policier.DateActe.Value}");
                    return false;
                }
                
                // Validation métier : La date d'acte ne peut pas être avant la date d'entrée à la police
                if (Policier.DateActe.Value < Policier.DateEntreePolice)
                {
                    Console.WriteLine("Erreur: La date d'acte ne peut pas être avant la date d'entrée à la police");
                    return false;
                }
                
                // Validation métier : La date d'acte ne peut pas être dans le futur
                if (Policier.DateActe.Value > DateTime.Today)
                {
                    Console.WriteLine("Erreur: La date d'acte ne peut pas être dans le futur");
                    return false;
                }
            }

            if (Policier.DateDelivrancePermis.HasValue)
            {
                if (Policier.DateDelivrancePermis.Value < minDate || Policier.DateDelivrancePermis.Value > DateTime.Today)
                {
                    Console.WriteLine($"Date de délivrance permis invalide: {Policier.DateDelivrancePermis.Value}");
                    return false;
                }
                
                // Validation métier : La date de délivrance du permis ne peut pas être avant la date de naissance
                if (Policier.DateDelivrancePermis.Value < Policier.DateNaissance)
                {
                    Console.WriteLine("Erreur: La date de délivrance du permis ne peut pas être avant la date de naissance");
                    return false;
                }
                
                // Validation métier : L'âge minimum pour obtenir un permis de conduire est de 16 ans
                var agePermis = Policier.DateDelivrancePermis.Value.Year - Policier.DateNaissance.Year;
                if (Policier.DateDelivrancePermis.Value < Policier.DateNaissance.AddYears(agePermis))
                {
                    agePermis--; // Ajuster si l'anniversaire n'est pas encore passé
                }
                
                if (agePermis < 16)
                {
                    Console.WriteLine($"Erreur: L'âge minimum pour obtenir un permis de conduire est de 16 ans. Âge calculé: {agePermis} ans");
                    return false;
                }
                
                // Validation métier : La date de délivrance du permis ne peut pas être dans le futur
                if (Policier.DateDelivrancePermis.Value > DateTime.Today)
                {
                    Console.WriteLine("Erreur: La date de délivrance du permis ne peut pas être dans le futur");
                    return false;
                }
            }

            return true;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Erreur lors de la validation des dates: {ex.Message}");
            return false;
        }
    }

    private void UpdateDateComponents(DateTime dateNaissance)
    {
        // Extraire et stocker jour, mois, année de la date de naissance
        Policier.Jour = dateNaissance.Day.ToString();
        Policier.Mois = dateNaissance.Month.ToString();
        Policier.Annee = dateNaissance.Year;
    }

    // Méthodes de validation des étapes
    private bool ValidateCurrentStep()
    {
        return currentStep switch
        {
            1 => ValidateStep1New(), // Identification de base
            2 => ValidateStep2New(), // Informations Professionnelles
            3 => ValidateStep3New(), // État Civil et Conjoints
            4 => ValidateStep4New(), // Enfants
            5 => ValidateStep5(), // Origine et Études
            6 => ValidateStep6(), // Contact
            7 => ValidateStep7(), // Langues
            8 => ValidateStep8(), // Sports
            9 => ValidateStep9(), // Distinctions et Historiques
            10 => ValidateStep10(), // Permis
            11 => ValidateStep11(), // Médical
            12 => ValidateStep12(), // Unités
            13 => ValidateStep13(), // Documents
            14 => ValidateStep14(), // Urgence
            _ => false
        };
    }

    // Méthode appelée quand le NUTP change
    private void OnNutpChanged()
    {
        // Réinitialiser l'état de vérification quand l'utilisateur change le NUTP
        isNutpVerified = false;
        nutpVerificationMessage = "";
        nutpVerificationError = false;
        StateHasChanged();
    }

    // Méthode de vérification du NUTP
    private async Task VerifyNutp()
    {
        if (string.IsNullOrEmpty(Policier.NumeroNutp))
        {
            nutpVerificationMessage = "Veuillez saisir un numéro NUTP";
            nutpVerificationError = true;
            return;
        }

        isNutpVerifying = true;
        nutpVerificationMessage = "";
        nutpVerificationError = false;
        StateHasChanged();

        try
        {
            // Vérifier le statut du NUTP dans la table NUTP
            var nutpRecord = await NutpService.GetNutpByNumeroAsync(Policier.NumeroNutp);
            
            if (nutpRecord == null)
            {
                // Le NUTP n'existe pas dans la table NUTP
                nutpVerificationMessage = $"Le numéro NUTP '{Policier.NumeroNutp}' n'est pas reconnu dans le système.";
                nutpVerificationError = true;
                isNutpVerified = false;
            }
            else if (nutpRecord.Status?.ToUpper() == "BUSY")
            {
                // Le NUTP est déjà utilisé
                nutpVerificationMessage = $"Le numéro NUTP '{Policier.NumeroNutp}' est déjà utilisé.";
                nutpVerificationError = true;
                isNutpVerified = false;
            }
            else if (nutpRecord.Status?.ToUpper() == "FREE" || string.IsNullOrEmpty(nutpRecord.Status))
            {
                // Le NUTP est disponible
                nutpVerificationMessage = $"Le numéro NUTP '{Policier.NumeroNutp}' est disponible.";
                nutpVerificationError = false;
                isNutpVerified = true;
            }
            else
            {
                // Statut inconnu ou autre
                nutpVerificationMessage = $"Le numéro NUTP '{Policier.NumeroNutp}' a un statut inattendu: {nutpRecord.Status}";
                nutpVerificationError = true;
                isNutpVerified = false;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Erreur lors de la vérification du NUTP: {ex.Message}");
            nutpVerificationMessage = "Erreur lors de la vérification du NUTP. Veuillez réessayer.";
            nutpVerificationError = true;
            isNutpVerified = false;
        }
        finally
        {
            isNutpVerifying = false;
            StateHasChanged();
        }
    }

    // Méthodes de navigation des étapes
    private void NextStep()
    {
        if (ValidateCurrentStep())
        {
            stepValidated[currentStep] = true;
            if (currentStep < totalSteps)
            {
                currentStep++;
                ClearValidationErrors();
            }
        }
    }

    private void PreviousStep()
    {
        if (currentStep > 1)
        {
            currentStep--;
            ClearValidationErrors();
        }
    }

    private void GoToStep(int step)
    {
        if (step >= 1 && step <= totalSteps && stepValidated.ContainsKey(step - 1) && stepValidated[step - 1])
        {
            currentStep = step;
            ClearValidationErrors();
        }
    }

    private void GoBack()
    {
        Navigation.NavigateTo("/policiers");
    }

    private bool ValidateStep1()
    {
        // Effacer les erreurs de validation précédentes
        ClearValidationErrors();
        
        Console.WriteLine("Validation étape 1 - Informations Personnelles");
        
        var isValid = true;
        
       
        
        if (string.IsNullOrEmpty(Policier.Nom))
        {
            Console.WriteLine("Erreur: Nom vide");
            AddValidationError("Nom", "Le nom est obligatoire");
            isValid = false;
        }
        
        if (string.IsNullOrEmpty(Policier.Prenom))
        {
            Console.WriteLine("Erreur: Prenom vide");
            AddValidationError("Prenom", "Le prénom est obligatoire");
            isValid = false;
        }
        
        if (string.IsNullOrEmpty(Policier.Sexe))
        {
            Console.WriteLine("Erreur: Sexe vide");
            AddValidationError("Sexe", "Le sexe est obligatoire");
            isValid = false;
        }
        
        if (string.IsNullOrEmpty(Policier.EtatCivil))
        {
            Console.WriteLine("Erreur: EtatCivil vide");
            AddValidationError("EtatCivil", "L'état civil est obligatoire");
            isValid = false;
        }
        
        if (Policier.DateNaissance == default)
        {
            Console.WriteLine("Erreur: DateNaissance par défaut");
            AddValidationError("DateNaissance", "La date de naissance est obligatoire");
            isValid = false;
        }
        else if (Policier.DateNaissance.AddYears(18) < DateTime.Today || Policier.DateNaissance > DateTime.Today)
        {
            Console.WriteLine("Erreur: DateNaissance dans le futur");
            AddValidationError("DateNaissance", "La date de naissance ne peut pas être dans le futur");
            isValid = false;
        } 
        else if (Policier.DateNaissance < new DateTime(1900, 1, 1))
        {
            Console.WriteLine("Erreur: DateNaissance trop ancienne");
            AddValidationError("DateNaissance", "La date de naissance ne peut pas être antérieure à 1900");
            isValid = false;
        }
        else
        {
            Console.WriteLine($"DateNaissance valide: {Policier.DateNaissance:dd/MM/yyyy}");
        }
        
        if (Policier.DateEntreePolice == default)
        {
            Console.WriteLine("Erreur: DateEntreePolice par défaut");
            AddValidationError("DateEntreePolice", "La date d'entrée à la police est obligatoire");
            isValid = false;
        }
        else if (Policier.DateEntreePolice > DateTime.Today)
        {
            Console.WriteLine("Erreur: DateEntreePolice dans le futur");
            AddValidationError("DateEntreePolice", "La date d'entrée à la police ne peut pas être dans le futur");
            isValid = false;
        }
        else if (Policier.DateEntreePolice < new DateTime(1950, 1, 1))
        {
            Console.WriteLine("Erreur: DateEntreePolice trop ancienne");
            AddValidationError("DateEntreePolice", "La date d'entrée à la police ne peut pas être antérieure à 1950");
            isValid = false;
        }
        else
        {
            Console.WriteLine($"DateEntreePolice valide: {Policier.DateEntreePolice:dd/MM/yyyy}");
        }
        
        // Validation de l'âge minimum (18 ans) pour l'entrée à la police
        if (Policier.DateNaissance != default && Policier.DateEntreePolice != default)
        {
            // Vérifier que la date d'entrée à la police n'est pas avant la date de naissance
            if (Policier.DateEntreePolice < Policier.DateNaissance)
            {
                Console.WriteLine("Erreur: DateEntreePolice avant DateNaissance");
                AddValidationError("DateEntreePolice", "La date d'entrée à la police ne peut pas être avant la date de naissance");
                isValid = false;
            }
            else
            {
                // Calcul correct de l'âge
                var ageEntreePolice = Policier.DateEntreePolice.Year - Policier.DateNaissance.Year;
                
                // Ajuster si l'anniversaire n'est pas encore passé à la date d'entrée à la police
                if (Policier.DateEntreePolice < Policier.DateNaissance.AddYears(ageEntreePolice))
                {
                    ageEntreePolice--;
                }
                
                Console.WriteLine($"Date de naissance: {Policier.DateNaissance:dd/MM/yyyy}");
                Console.WriteLine($"Date d'entrée police: {Policier.DateEntreePolice:dd/MM/yyyy}");
                Console.WriteLine($"Âge calculé: {ageEntreePolice} ans");
                
                
                if (ageEntreePolice < 18)
                {
                    Console.WriteLine("Erreur: Âge trop jeune");
                    AddValidationError("DateNaissance", $"L'âge minimum pour entrer à la police est de 18 ans. Âge calculé: {ageEntreePolice} ans");
                    isValid = false;
                }
                else if (ageEntreePolice > 70)
                {
                    Console.WriteLine("Erreur: Âge trop élevé");
                    AddValidationError("DateNaissance", $"L'âge maximum pour entrer à la police est de 70 ans. Âge calculé: {ageEntreePolice} ans");
                    isValid = false;
                }
            }
        }
        
        Console.WriteLine($"Étape 1 validation: {isValid}"); 
        return isValid;
    }

    private bool ValidateStep2()
    {
        // Effacer les erreurs de validation précédentes
        ClearValidationErrors();
        
        Console.WriteLine("Validation étape 2 - Informations Professionnelles");
        
        var isValidProf = true;
        
        if (string.IsNullOrEmpty(Policier.Matricule))
        {
            Console.WriteLine("Erreur: Matricule vide");
            AddValidationError("Matricule", "Le matricule est obligatoire");
            isValidProf = false;
        }
        
        if (string.IsNullOrEmpty(Policier.NatureGrade))
        {
            Console.WriteLine("Erreur: NatureGrade vide");
            AddValidationError("NatureGrade", "Le grade est obligatoire");
            isValidProf = false;
        }
        
        if (string.IsNullOrEmpty(Policier.IdCommissariat))
        {
            Console.WriteLine("Erreur: IdCommissariat vide");
            AddValidationError("IdCommissariat", "Le commissariat est obligatoire");
            isValidProf = false;
        }
        
        // Validation des dates professionnelles si elles sont renseignées
        if (Policier.DateNomination.HasValue)
        {
            if (Policier.DateNomination.Value > DateTime.Today)
            {
                Console.WriteLine("Erreur: DateNomination dans le futur");
                AddValidationError("DateNomination", "La date de nomination ne peut pas être dans le futur");
                isValidProf = false;
            }
            else if (Policier.DateNomination.Value < Policier.DateEntreePolice)
            {
                Console.WriteLine("Erreur: DateNomination avant entrée police");
                AddValidationError("DateNomination", "La date de nomination ne peut pas être avant l'entrée à la police");
                isValidProf = false;
            }
        }
        
        if (Policier.DatePriseFonction.HasValue)
        {
            if (Policier.DatePriseFonction.Value > DateTime.Today)
            {
                Console.WriteLine("Erreur: DatePriseFonction dans le futur");
                AddValidationError("DatePriseFonction", "La date de prise de fonction ne peut pas être dans le futur");
                isValidProf = false;
            }
            else if (Policier.DatePriseFonction.Value < Policier.DateEntreePolice)
            {
                Console.WriteLine("Erreur: DatePriseFonction avant entrée police");
                AddValidationError("DatePriseFonction", "La date de prise de fonction ne peut pas être avant l'entrée à la police");
                isValidProf = false;
            }
        }
        
        // Validation de la cohérence entre nomination et prise de fonction
        if (Policier.DateNomination.HasValue && Policier.DatePriseFonction.HasValue)
        {
            if (Policier.DatePriseFonction.Value < Policier.DateNomination.Value)
            {
                Console.WriteLine("Erreur: Prise de fonction avant nomination");
                AddValidationError("DatePriseFonction", "La date de prise de fonction ne peut pas être avant la date de nomination");
                isValidProf = false;
            }
        }
        
        Console.WriteLine($"Étape 2 validation: {isValidProf}");
        return isValidProf;
    }

    private bool ValidateStep3()
    {
        // Effacer les erreurs de validation précédentes
        ClearValidationErrors();
        
        Console.WriteLine("Validation étape 3 - Informations de Contact et Origine");
        
        var isValidContact = true;
        
        // Validation du téléphone (format basique)
        if (!string.IsNullOrEmpty(Policier.Telephone))
        {
            if (Policier.Telephone.Length < 8)
            {
                Console.WriteLine("Erreur: Téléphone trop court");
                AddValidationError("Telephone", "Le numéro de téléphone doit contenir au moins 8 chiffres");
                isValidContact = false;
            }
        }
        
        // Validation des dates optionnelles si elles sont renseignées
        if (Policier.DateDelivrancePermis.HasValue)
        {
            if (Policier.DateDelivrancePermis.Value > DateTime.Today)
            {
                Console.WriteLine("Erreur: DateDelivrancePermis dans le futur");
                AddValidationError("DateDelivrancePermis", "La date de délivrance du permis ne peut pas être dans le futur");
                isValidContact = false;
            }
            else if (Policier.DateDelivrancePermis.Value < Policier.DateNaissance)
            {
                Console.WriteLine("Erreur: DateDelivrancePermis avant naissance");
                AddValidationError("DateDelivrancePermis", "La date de délivrance du permis ne peut pas être avant la naissance");
                isValidContact = false;
            }
            else
            {
                // Validation de l'âge minimum pour le permis (16 ans)
                var agePermis = Policier.DateDelivrancePermis.Value.Year - Policier.DateNaissance.Year;
                if (Policier.DateDelivrancePermis.Value < Policier.DateNaissance.AddYears(agePermis))
                {
                    agePermis--;
                }
                
                if (agePermis < 16)
                {
                    Console.WriteLine("Erreur: Âge trop jeune pour le permis");
                    AddValidationError("DateDelivrancePermis", $"L'âge minimum pour obtenir un permis est de 16 ans. Âge calculé: {agePermis} ans");
                    isValidContact = false;
                }
            }
        }
        
        Console.WriteLine($"Étape 3 validation: {isValidContact}");
        return isValidContact;
    }

    private bool ValidateStep4()
    {
        // Effacer les erreurs de validation précédentes
        ClearValidationErrors();
        
        Console.WriteLine("Validation étape 4 - Informations Supplémentaires");
        
        var isValidSupp = true;
        
        // Validation des personnes à prévenir si elles existent
        if (Policier.PersonnePrevenirs?.Any() == true)
        {
            foreach (var personne in Policier.PersonnePrevenirs)
            {
                if (string.IsNullOrEmpty(personne.Nom))
                {
                    Console.WriteLine("Erreur: Nom de personne à prévenir vide");
                    AddValidationError("PersonnePrevenir", "Tous les noms des personnes à prévenir doivent être renseignés");
                    isValidSupp = false;
                    break;
                }
                
                if (string.IsNullOrEmpty(personne.Telephone))
                {
                    Console.WriteLine("Erreur: Téléphone de personne à prévenir vide");
                    AddValidationError("PersonnePrevenir", "Tous les téléphones des personnes à prévenir doivent être renseignés");
                    isValidSupp = false;
                    break;
                }
                
                if (personne.Telephone.Length < 8)
                {
                    Console.WriteLine("Erreur: Téléphone de personne à prévenir trop court");
                    AddValidationError("PersonnePrevenir", "Tous les téléphones doivent contenir au moins 8 chiffres");
                    isValidSupp = false;
                    break;
                }
            }
        }
        
        // Validation des empreintes si elles existent
        if (Policier.Empreintes?.Any() == true)
        {
            foreach (var empreinte in Policier.Empreintes)
            {
                if (string.IsNullOrEmpty(empreinte.TypeDoigt))
                {
                    Console.WriteLine("Erreur: Type de doigt vide");
                    AddValidationError("Empreintes", "Tous les types de doigts doivent être renseignés");
                    isValidSupp = false;
                    break;
                }
                
                if (string.IsNullOrEmpty(empreinte.Urlepreinte))
                {
                    Console.WriteLine("Erreur: URL d'empreinte vide");
                    AddValidationError("Empreintes", "Toutes les URLs d'empreintes doivent être renseignées");
                    isValidSupp = false;
                    break;
                }
            }
        }
        
        // Validation des observations (optionnel mais avec limite de longueur)
        if (!string.IsNullOrEmpty(Policier.Observation) && Policier.Observation.Length > 1000)
        {
            Console.WriteLine("Erreur: Observations trop longues");
            AddValidationError("Observation", "Les observations ne peuvent pas dépasser 1000 caractères");
            isValidSupp = false;
        }
        
        Console.WriteLine($"Étape 4 validation: {isValidSupp}");
        return isValidSupp;
    }

    private string GetStepLabel(int step)
    {
        return step switch
        {
            1 => "Identification",
            2 => "Professionnel",
            3 => "État Civil",
            4 => "Enfants",
            5 => "Origine",
            6 => "Contact",
            7 => "Langues",
            8 => "Sports",
            9 => "Distinctions",
            10 => "Permis",
            11 => "Médical",
            12 => "Unités",
            13 => "Documents",
            14 => "Urgence",
            _ => $"Étape {step}"
        };
    }

    // Nouvelles méthodes de validation pour les étapes réorganisées
    private bool ValidateStep1New()
    {
        // Effacer les erreurs de validation précédentes
        ClearValidationErrors();
        
        Console.WriteLine("Validation étape 1 - Identification de base");
        
        var isValid = true;
        
        // Validation du commissariat (obligatoire)
        if (string.IsNullOrEmpty(Policier.IdCommissariat))
        {
            Console.WriteLine("Erreur: IdCommissariat vide");
            AddValidationError("IdCommissariat", "Le commissariat est obligatoire");
            isValid = false;
        }
        
        // Validation de la province (obligatoire)
        if (string.IsNullOrEmpty(SelectedProvince))
        {
            Console.WriteLine("Erreur: Province vide");
            AddValidationError("Province", "La province est obligatoire");
            isValid = false;
        }
        
        // Validation du district (obligatoire, saisie manuelle)
        if (string.IsNullOrEmpty(DistrictCommissariat))
        {
            Console.WriteLine("Erreur: District vide");
            AddValidationError("District", "Le district est obligatoire");
            isValid = false;
        }
        
        // Validation du territoire (obligatoire, sélection dans la liste)
        if (string.IsNullOrEmpty(TerritoireCommissariat))
        {
            Console.WriteLine("Erreur: Territoire vide");
            AddValidationError("Territoire", "Le territoire/commune est obligatoire");
            isValid = false;
        }
        else if (territoiresCommunesCommissariat?.Any() == true && !territoiresCommunesCommissariat.Contains(TerritoireCommissariat))
        {
            Console.WriteLine("Erreur: Territoire invalide");
            AddValidationError("Territoire", "Le territoire/commune sélectionné n'est pas valide pour cette province");
            isValid = false;
        }

        if (string.IsNullOrEmpty(Policier.NumeroNutp))
        {
            Console.WriteLine("Erreur: NumeroNutp vide");
            AddValidationError("NumeroNutp", "Le numéro NUTP est obligatoire");
            isValid = false;
        }
        
        
        // Validation du nom (obligatoire)
        if (string.IsNullOrEmpty(Policier.Nom))
        {
            Console.WriteLine("Erreur: Nom vide");
            AddValidationError("Nom", "Le nom est obligatoire");
            isValid = false;
        }
        
        // Validation du prénom (obligatoire)
        if (string.IsNullOrEmpty(Policier.Prenom))
        {
            Console.WriteLine("Erreur: Prenom vide");
            AddValidationError("Prenom", "Le prénom est obligatoire");
            isValid = false;
        }
        
     
        
        // Validation du matricule (obligatoire)
        if (string.IsNullOrEmpty(Policier.Matricule))
        {
            Console.WriteLine("Erreur: Matricule vide");
            AddValidationError("Matricule", "Le matricule est obligatoire");
            isValid = false;
        }
        
        // Validation de la date de naissance (obligatoire)
        if (Policier.DateNaissance == default)
        {
            Console.WriteLine("Erreur: DateNaissance par défaut");
            AddValidationError("DateNaissance", "La date de naissance est obligatoire");
            isValid = false;
        }
        else if (Policier.DateNaissance > DateTime.Today)
        {
            Console.WriteLine("Erreur: DateNaissance dans le futur");
            AddValidationError("DateNaissance", "La date de naissance ne peut pas être dans le futur");
            isValid = false;
        }
        else if (Policier.DateNaissance < new DateTime(1900, 1, 1))
        {
            Console.WriteLine("Erreur: DateNaissance trop ancienne");
            AddValidationError("DateNaissance", "La date de naissance ne peut pas être antérieure à 1900");
            isValid = false;
        }
        else if ( (DateTime.Today.Year - Policier.DateNaissance.Year) < 18)
        {
            Console.WriteLine("Erreur: DateNaissance trop jeune");
            AddValidationError("DateNaissance", "Le Policier doit avoir au moins 18 ans");
            isValid = false;
        }
        
        Console.WriteLine($"Étape 1 validation: {isValid}");
        return isValid;
    }

    private bool ValidateStep2New()
    {
        // Effacer les erreurs de validation précédentes
        ClearValidationErrors();
        
        Console.WriteLine("Validation étape 2 - Informations Professionnelles");
        
        var isValid = true;
        
        // Validation du sexe (obligatoire)
        if (string.IsNullOrEmpty(Policier.Sexe))
        {
            Console.WriteLine("Erreur: Sexe vide");
            AddValidationError("Sexe", "Le sexe est obligatoire");
            isValid = false;
        }
        
        // Validation du grade (obligatoire)
        if (string.IsNullOrEmpty(Policier.NatureGrade))
        {
            Console.WriteLine("Erreur: NatureGrade vide");
            AddValidationError("NatureGrade", "Le grade est obligatoire");
            isValid = false;
        }
        
        // Validation de la fonction actuelle (obligatoire)
        if (string.IsNullOrEmpty(Policier.FonctionActuelle))
        {
            Console.WriteLine("Erreur: FonctionActuelle vide");
            AddValidationError("FonctionActuelle", "La fonction actuelle est obligatoire");
            isValid = false;
        }
        
        // Validation de la date d'entrée à la police (obligatoire)
        if (Policier.DateEntreePolice == default)
        {
            Console.WriteLine("Erreur: DateEntreePolice par défaut");
            AddValidationError("DateEntreePolice", "La date d'entrée à la police est obligatoire");
            isValid = false;
        }
        else if (Policier.DateEntreePolice > DateTime.Today)
        {
            Console.WriteLine("Erreur: DateEntreePolice dans le futur");
            AddValidationError("DateEntreePolice", "La date d'entrée à la police ne peut pas être dans le futur");
            isValid = false;
        }
        else if (Policier.DateEntreePolice < Policier.DateNaissance)
        {
            Console.WriteLine("Erreur: DateEntreePolice avant DateNaissance");
            AddValidationError("DateEntreePolice", "La date d'entrée à la police ne peut pas être avant la date de naissance");
            isValid = false;
        }
        else
        {
            // Validation de l'âge minimum (18 ans) pour l'entrée à la police
            var ageEntreePolice = Policier.DateEntreePolice.Year - Policier.DateNaissance.Year;
            if (Policier.DateEntreePolice < Policier.DateNaissance.AddYears(ageEntreePolice))
            {
                ageEntreePolice--;
            }
            
            if (ageEntreePolice < 18)
            {
                Console.WriteLine("Erreur: Âge trop jeune pour entrer à la police");
                AddValidationError("DateEntreePolice", $"L'âge minimum pour entrer à la police est de 18 ans. Âge calculé: {ageEntreePolice} ans");
            isValid = false;
        }
        }
        
        // Validation de la date de nomination (si renseignée)
        if (Policier.DateNomination.HasValue)
        {
            if (Policier.DateNomination.Value > DateTime.Today)
            {
                Console.WriteLine("Erreur: DateNomination dans le futur");
                AddValidationError("DateNomination", "La date de nomination ne peut pas être dans le futur");
            isValid = false;
            }
            else if (Policier.DateEntreePolice != default && Policier.DateNomination.Value < Policier.DateEntreePolice)
            {
                Console.WriteLine("Erreur: DateNomination avant DateEntreePolice");
                AddValidationError("DateNomination", "La date de nomination doit être supérieure ou égale à la date d'entrée à la police");
                isValid = false;
            }
            else
            {
                // Validation de l'âge minimum (18 ans) pour la nomination
                var ageNomination = Policier.DateNomination.Value.Year - Policier.DateNaissance.Year;
                if (Policier.DateNomination.Value < Policier.DateNaissance.AddYears(ageNomination))
                {
                    ageNomination--;
                }
                
                if (ageNomination < 18)
                {
                    Console.WriteLine("Erreur: Âge trop jeune pour la nomination");
                    AddValidationError("DateNomination", $"L'âge minimum pour la nomination est de 18 ans. Âge calculé: {ageNomination} ans");
                    isValid = false;
                }
            }
        }
        
        // Validation de la date de prise de fonction (si renseignée)
        if (Policier.DatePriseFonction.HasValue)
        {
            if (Policier.DatePriseFonction.Value > DateTime.Today)
            {
                Console.WriteLine("Erreur: DatePriseFonction dans le futur");
                AddValidationError("DatePriseFonction", "La date de prise de fonction ne peut pas être dans le futur");
                isValid = false;
            }
            else if (Policier.DateEntreePolice != default && Policier.DatePriseFonction.Value < Policier.DateEntreePolice)
            {
                Console.WriteLine("Erreur: DatePriseFonction avant DateEntreePolice");
                AddValidationError("DatePriseFonction", "La date de prise de fonction doit être supérieure ou égale à la date d'entrée à la police");
                isValid = false;
            }
            else
            {
                // Validation de l'âge minimum (18 ans) pour la prise de fonction
                var agePriseFonction = Policier.DatePriseFonction.Value.Year - Policier.DateNaissance.Year;
                if (Policier.DatePriseFonction.Value < Policier.DateNaissance.AddYears(agePriseFonction))
                {
                    agePriseFonction--;
                }
                
                if (agePriseFonction < 18)
                {
                    Console.WriteLine("Erreur: Âge trop jeune pour la prise de fonction");
                    AddValidationError("DatePriseFonction", $"L'âge minimum pour la prise de fonction est de 18 ans. Âge calculé: {agePriseFonction} ans");
                    isValid = false;
                }
            }
        }
        
        Console.WriteLine($"Étape 2 validation: {isValid}");
        return isValid;
    }

    private bool ValidateStep3New()
    {
        // Effacer les erreurs de validation précédentes
        ClearValidationErrors();
        
        Console.WriteLine("Validation étape 3 - État Civil et Conjoints");
        
        var isValid = true;
        
        // Validation de l'état civil (obligatoire)
        if (string.IsNullOrEmpty(Policier.EtatCivil))
        {
            Console.WriteLine("Erreur: EtatCivil vide");
            AddValidationError("EtatCivil", "L'état civil est obligatoire");
            isValid = false;
        }
        
        // Si marié(e), veuf(ve) ou divorcé(e), exactement un conjoint requis
        if (!string.IsNullOrEmpty(Policier.EtatCivil) && 
            Policier.EtatCivil != "Célibataire")
        {
            var conjointCount = Conjoints.Count + (Policier.Conjoints?.Count ?? 0);
            
            if (conjointCount == 0)
        {
            Console.WriteLine("Erreur: Aucun conjoint pour état civil non célibataire");
                AddValidationError("Conjoints", "Un conjoint est requis pour cet état civil");
            isValid = false;
            }
            else if (conjointCount > 1)
            {
                
                Console.WriteLine("Erreur: Trop de conjoints pour cet état civil");
                AddValidationError("Conjoints", "Un seul conjoint est autorisé pour cet état civil");
                isValid = false;
            }
        
        }
        
        Console.WriteLine($"Étape 3 validation: {isValid}");
        return isValid;
    }

    private bool ValidateStep4New()
    {
        // Effacer les erreurs de validation précédentes
        ClearValidationErrors();
        
        Console.WriteLine("Validation étape 4 - Enfants");
        
        // Cette étape est optionnelle, toujours valide
        var isValid = true;
        
        Console.WriteLine($"Étape 4 validation: {isValid}");
        return isValid;
    }

    private bool ValidateStep5()
    {
        // Effacer les erreurs de validation précédentes
        ClearValidationErrors();
        
        Console.WriteLine("Validation étape 5 - Origine et Études");
        
        var isValid = true;
        
        // Validation de la province d'origine (obligatoire)
        if (string.IsNullOrEmpty(Policier.ProvinceOrigine))
        {
            Console.WriteLine("Erreur: ProvinceOrigine vide");
            AddValidationError("ProvinceOrigine", "La province d'origine est obligatoire");
            isValid = false;
        }
        
        // Validation du territoire d'origine (obligatoire)
        if (string.IsNullOrEmpty(Policier.TerritoireOrigine))
        {
            Console.WriteLine("Erreur: TerritoireOrigine vide");
            AddValidationError("TerritoireOrigine", "Le territoire/commune d'origine est obligatoire");
            isValid = false;
        }
        
        // Validation des études : l'année doit être entre l'année de naissance et l'année actuelle
        if (Policier.DateNaissance != default && Formations?.Any() == true)
        {
            var anneeNaissance = Policier.DateNaissance.Year;
            var anneeActuelle = DateTime.Now.Year;
            Console.WriteLine($"Année de naissance: {anneeNaissance}, Année actuelle: {anneeActuelle}");
            
            foreach (var formation in Formations)
            {
                if (formation.Annee > 0)
                {
                    Console.WriteLine($"Vérification formation: {formation.Ecole} - Année: {formation.Annee}");
                    
                    if (formation.Annee <= anneeNaissance)
                    {
                        Console.WriteLine($"Erreur: Année d'études ({formation.Annee}) doit être supérieure à l'année de naissance ({anneeNaissance})");
                        AddValidationError("Formations", $"L'année d'études ({formation.Annee}) doit être supérieure à l'année de naissance ({anneeNaissance})");
                        isValid = false;
                    }
                    else if (formation.Annee > anneeActuelle)
                    {
                        Console.WriteLine($"Erreur: Année d'études ({formation.Annee}) ne peut pas être dans le futur");
                        AddValidationError("Formations", $"L'année d'études ({formation.Annee}) ne peut pas être dans le futur");
                        isValid = false;
                    }
                }
            }
        }
        
        Console.WriteLine($"Étape 5 validation: {isValid}");
        return isValid;
    }

    private bool ValidateStep6()
    {
        // Effacer les erreurs de validation précédentes
        ClearValidationErrors();
        
        Console.WriteLine("Validation étape 6 - Contact");
        
        var isValid = true;
        
        // Validation du téléphone si renseigné
        if (!string.IsNullOrEmpty(Policier.Telephone) && Policier.Telephone.Length < 10)
        {
            if(Policier.Telephone.Length > 10)
            {
                Console.WriteLine("Erreur: Téléphone trop long");
                AddValidationError("Telephone", "Le téléphone doit contenir au plus 10 chiffres");
                isValid = false;
            }
            else
        {
            Console.WriteLine("Erreur: Téléphone trop court");
                AddValidationError("Telephone", "Le téléphone doit contenir au moins 10 chiffres");
            isValid = false;
            }
        }
        
        Console.WriteLine($"Étape 6 validation: {isValid}");
        return isValid;
    }

    private bool ValidateStep7()
    {
        // Étape 7 - Langues (optionnelle)
        return true;
    }

    private bool ValidateStep8()
    {
        // Étape 8 - Sports (optionnelle)
        return true;
    }

    private bool ValidateStep9()
    {
        // Étape 9 - Distinctions (optionnelle)
        return true;
    }

    private bool ValidateStep10()
    {
        // Effacer les erreurs de validation précédentes
        ClearValidationErrors();
        
        Console.WriteLine("Validation étape 10 - Permis de conduire");
        
        var isValid = true;
        
        // Validation de la date de délivrance du permis si elle est renseignée
        if (Policier.DateDelivrancePermis != default)
        {
            // La date de délivrance ne peut pas être dans le futur
            if (Policier.DateDelivrancePermis > DateTime.Today)
            {
                Console.WriteLine("Erreur: DateDelivrancePermis dans le futur");
                AddValidationError("DateDelivrancePermis", "La date de délivrance ne peut pas être dans le futur");
                isValid = false;
            }
            
            // La date de délivrance doit être au moins 18 ans après la date de naissance
            if (Policier.DateNaissance != default)
            {
                var ageMinimum = Policier.DateNaissance.AddYears(18);
                if (Policier.DateDelivrancePermis < ageMinimum)
                {
                    Console.WriteLine("Erreur: DateDelivrancePermis avant 18 ans");
                    AddValidationError("DateDelivrancePermis", "La date de délivrance doit être au moins 18 ans après la date de naissance");
                    isValid = false;
                }
            }
        }
        
        Console.WriteLine($"Étape 10 validation: {isValid}");
        return isValid;
    }

    private bool ValidateStep11()
    {
        // Effacer les erreurs de validation précédentes
        ClearValidationErrors();
        
        Console.WriteLine("Validation étape 11 - Informations médicales");
        
        var isValid = true;
        
        // Validation du groupe sanguin (obligatoire)
        if (string.IsNullOrEmpty(Policier.GroupeSanguin))
        {
            Console.WriteLine("Erreur: GroupeSanguin vide");
            AddValidationError("GroupeSanguin", "Le groupe sanguin est obligatoire");
            isValid = false;
        }
        
        // Validation du rhésus (obligatoire)
        if (string.IsNullOrEmpty(Policier.Rhesus))
        {
            Console.WriteLine("Erreur: Rhesus vide");
            AddValidationError("Rhesus", "Le rhésus est obligatoire");
            isValid = false;
        }
        
        Console.WriteLine($"Étape 11 validation: {isValid}");
        return isValid;
    }

    private bool ValidateStep12()
    {
        // Effacer les erreurs de validation précédentes
        ClearValidationErrors();
        
        Console.WriteLine("Validation étape 12 - Unités et affectations");
        
        var isValid = true;
        
        // Validation des champs obligatoires
        if (string.IsNullOrEmpty(Policier.UniteMere))
        {
            Console.WriteLine("Erreur: UniteMere vide");
            AddValidationError("UniteMere", "L'unité mère est obligatoire");
            isValid = false;
        }
        
        if (string.IsNullOrEmpty(Policier.UniteAffectation))
        {
            Console.WriteLine("Erreur: UniteAffectation vide");
            AddValidationError("UniteAffectation", "L'unité d'affectation est obligatoire");
            isValid = false;
        }
        
        if (string.IsNullOrEmpty(Policier.NomUnite))
        {
            Console.WriteLine("Erreur: NomUnite vide");
            AddValidationError("NomUnite", "Le nom de l'unité est obligatoire");
            isValid = false;
        }
        
        if (string.IsNullOrEmpty(Policier.LieuAffectation))
        {
            Console.WriteLine("Erreur: LieuAffectation vide");
            AddValidationError("LieuAffectation", "Le lieu d'affectation est obligatoire");
            isValid = false;
        }
        
        Console.WriteLine($"Étape 12 validation: {isValid}");
        return isValid;
    }

    private bool ValidateStep13()
    {
        // Effacer les erreurs de validation précédentes
        ClearValidationErrors();
        
        Console.WriteLine("Validation étape 13 - Documents et signatures");
        
        var isValid = true;
        
        // Validation de l'acte de nomination (obligatoire)
        if (string.IsNullOrEmpty(Policier.ActeNominationFonction))
        {
            Console.WriteLine("Erreur: ActeNominationFonction vide");
            AddValidationError("ActeNominationFonction", "L'acte de nomination (fonction) est obligatoire");
            isValid = false;
        }
        
        // Validation de la date de l'acte si elle est renseignée
        if (Policier.DateActe != default)
        {
            // La date de l'acte ne peut pas être dans le futur
            if (Policier.DateActe > DateTime.Today)
            {
                Console.WriteLine("Erreur: DateActe dans le futur");
                AddValidationError("DateActe", "La date de l'acte ne peut pas être dans le futur");
                isValid = false;
            }
            
            // La date de l'acte doit être après la date d'entrée à la police
            if (Policier.DateEntreePolice != default)
            {
                if (Policier.DateActe < Policier.DateEntreePolice)
                {
                    Console.WriteLine("Erreur: DateActe avant DateEntreePolice");
                    AddValidationError("DateActe", "La date de l'acte doit être après la date d'entrée à la police");
                    isValid = false;
                }
            }
        }
        
        Console.WriteLine($"Étape 13 validation: {isValid}");
        return isValid;
    }

    private bool ValidateStep14()
    {
        // Étape 14 - Urgence (optionnelle)
        return true;
    }
    


    // Méthodes pour gérer les langues
    private void AddLangueForm() 
    { 
        newLangue = new Langue(); 
        showAddLangueForm = true; 
    }
    
    private void CancelAddLangue() 
    { 
        showAddLangueForm = false; 
        newLangue = new(); 
        errorMessageLangue = "";
    }
    
    private void SaveLangue() 
    {
        // Réinitialiser le message d'erreur
        errorMessageLangue = "";
        
        // Validation des champs obligatoires
        if (string.IsNullOrEmpty(newLangue.Libelle))
        {
            errorMessageLangue = "Le nom de la langue est obligatoire.";
            return;
        }
        
        if (newLangue.NiveauEcriture <= 0)
        {
            errorMessageLangue = "Le niveau d'écriture doit être sélectionné.";
            return;
        }
        
        if (newLangue.NiveauLecture <= 0)
        {
            errorMessageLangue = "Le niveau de lecture doit être sélectionné.";
            return;
        }
        
        newLangue.Id = PolicierService.GenerateUniqueId();
        Langues.Add(newLangue);
        CancelAddLangue();
    }
    
    private void RemoveLangue(int index) 
    { 
        if (index >= 0 && index < Langues.Count) 
            Langues.RemoveAt(index); 
    }

    // Méthodes pour gérer les sports
    private void AddSportForm() 
    { 
        showAddSportForm = true; 
    }
    
    private void CancelAddSport() 
    { 
        showAddSportForm = false; 
        newSport = new(); 
    }
    
    private void SaveSport() 
    {
        if (!string.IsNullOrEmpty(newSport.Libelle))
        {
            newSport.Id = PolicierService.GenerateUniqueId();
            Sports.Add(newSport);
            CancelAddSport();
        }
    }
    
    private void RemoveSport(int index) 
    { 
        if (index >= 0 && index < Sports.Count) 
            Sports.RemoveAt(index); 
    }

    // Méthodes pour gérer les distinctions
    private void AddDistinctionForm() 
    { 
        newDistinction = new DistinctionHonorifique 
        {
            DateDecision = DateTime.Today.AddDays(-30) // 30 jours par défaut
        }; 
        showAddDistinctionForm = true; 
    }
    
    private void CancelAddDistinction() 
    { 
        showAddDistinctionForm = false; 
        newDistinction = new DistinctionHonorifique 
        {
            DateDecision = DateTime.Today.AddDays(-30) // 30 jours par défaut
        }; 
        errorMessageDistinction = "";
    }
    
    private void SaveDistinction() 
    {
        // Réinitialiser le message d'erreur
        errorMessageDistinction = "";
        
        // Validation des champs obligatoires
        if (string.IsNullOrEmpty(newDistinction.Motif) || 
            string.IsNullOrEmpty(newDistinction.NumeroDecision) || 
            newDistinction.DateDecision == default)
        {
            errorMessageDistinction = "Tous les champs obligatoires doivent être remplis.";
            return;
        }

        // Validation de la date de décision
        if (newDistinction.DateDecision > DateTime.Today)
        {
            errorMessageDistinction = "La date de décision ne peut pas être dans le futur.";
            return;
        }

        // Validation métier : La date de décision ne peut pas être avant l'entrée à la police
        if (Policier.DateEntreePolice != default && newDistinction.DateDecision < Policier.DateEntreePolice)
        {
            errorMessageDistinction = "La date de décision ne peut pas être avant l'entrée à la police.";
            return;
        }

            newDistinction.Id = PolicierService.GenerateUniqueId();
            Distinctions.Add(newDistinction);
            CancelAddDistinction();
    }
    
    private void RemoveDistinction(int index) 
    { 
        if (index >= 0 && index < Distinctions.Count) 
            Distinctions.RemoveAt(index); 
    }

    // Méthodes pour gérer les personnes à prévenir
    private void AddPersonneAPrevenirForm() 
    { 
        showAddPersonneAPrevenirForm = true; 
    }
    
    private void CancelAddPersonneAPrevenir() 
    { 
        showAddPersonneAPrevenirForm = false; 
        newPersonneAPrevenir = new(); 
    }
    
    private void SavePersonneAPrevenir() 
    {
        if (!string.IsNullOrEmpty(newPersonneAPrevenir.Nom) && !string.IsNullOrEmpty(newPersonneAPrevenir.Telephone) && !string.IsNullOrEmpty(newPersonneAPrevenir.NumeroRue) && !string.IsNullOrEmpty(newPersonneAPrevenir.Rue) && !string.IsNullOrEmpty(newPersonneAPrevenir.Commune))
        {
            newPersonneAPrevenir.Id = PolicierService.GenerateUniqueId();
            PersonnesAPrevenir.Add(newPersonneAPrevenir);
            CancelAddPersonneAPrevenir();
        }
    }
    
    private void RemovePersonneAPrevenir(int index) 
    { 
        if (index >= 0 && index < PersonnesAPrevenir.Count) 
            PersonnesAPrevenir.RemoveAt(index); 
    }

    // Méthodes pour gérer l'historique des affectations
    private void AddHistAffectationForm()
    {
        newHistAffectation = new HistAffectation 
        {
            DateActe = DateTime.Today.AddDays(-30) // 30 jours par défaut
        };
        showAddHistAffectationForm = true;
    }

    private void CancelAddHistAffectation()
    {
        showAddHistAffectationForm = false;
        newHistAffectation = new HistAffectation 
        {
            DateActe = DateTime.Today.AddDays(-30) // 30 jours par défaut
        };
        errorMessageHistAffectation = "";
    }

    private void SaveHistAffectation()
    {
        // Réinitialiser le message d'erreur
        errorMessageHistAffectation = "";
        
        // Validation des champs obligatoires
        if (string.IsNullOrEmpty(newHistAffectation.Lieu) || string.IsNullOrEmpty(newHistAffectation.Denomination) || 
            string.IsNullOrEmpty(newHistAffectation.ActeDenomination) || newHistAffectation.DateActe == default)
        {
            errorMessageHistAffectation = "Tous les champs obligatoires doivent être remplis.";
            return;
        }

        // Validation de la date
        if (newHistAffectation.DateActe > DateTime.Now)
        {
            errorMessageHistAffectation = "La date de l'acte ne peut pas être dans le futur.";
            return;
        }

        // Validation métier : La date de l'acte ne peut pas être avant l'entrée à la police
        if (Policier.DateEntreePolice != default && newHistAffectation.DateActe < Policier.DateEntreePolice)
        {
            errorMessageHistAffectation = "La date de l'acte ne peut pas être avant l'entrée à la police.";
            return;
        }

        newHistAffectation.Id = PolicierService.GenerateUniqueId();
        HistAffectations.Add(newHistAffectation);
        CancelAddHistAffectation();
    }

    private void RemoveHistAffectation(int index)
    {
        if (index >= 0 && index < HistAffectations.Count)
            HistAffectations.RemoveAt(index);
    }

    // Méthodes pour gérer l'historique des fonctions
    private void AddHistFonctionForm()
    {
        newHistFonction = new HistFonction 
        {
            DatePriseFonction = DateTime.Today.AddDays(-30), // 30 jours par défaut
            DateFin = DateTime.Today
        };
        showAddHistFonctionForm = true;
    }

    private void CancelAddHistFonction()
    {
        showAddHistFonctionForm = false;
        newHistFonction = new HistFonction 
        {
            DatePriseFonction = DateTime.Today.AddDays(-30), // 30 jours par défaut
            DateFin = DateTime.Today
        };
        errorMessageHistFonction = "";
    }

    private void SaveHistFonction()
    {
        // Réinitialiser le message d'erreur
        errorMessageHistFonction = "";
        
        // Validation des champs obligatoires
        if (string.IsNullOrEmpty(newHistFonction.IntituleFonction) || 
            newHistFonction.DatePriseFonction == default || newHistFonction.DateFin == default)
        {
            errorMessageHistFonction = "Tous les champs obligatoires doivent être remplis.";
            return;
        }

        // Validation des dates
        if (newHistFonction.DatePriseFonction >= newHistFonction.DateFin)
        {
            errorMessageHistFonction = "La date de prise de fonction doit être antérieure à la date de fin.";
            return;
        }

        if (newHistFonction.DateFin > DateTime.Now)
        {
            errorMessageHistFonction = "La date de fin ne peut pas être dans le futur.";
            return;
        }

        // Validation métier : La date de prise de fonction ne peut pas être avant l'entrée à la police
        if (Policier.DateEntreePolice != default && newHistFonction.DatePriseFonction < Policier.DateEntreePolice)
        {
            errorMessageHistFonction = "La date de prise de fonction ne peut pas être avant l'entrée à la police.";
            return;
        }

        // Validation métier : La date de fin ne peut pas être avant l'entrée à la police
        if (Policier.DateEntreePolice != default && newHistFonction.DateFin < Policier.DateEntreePolice)
        {
            errorMessageHistFonction = "La date de fin ne peut pas être avant l'entrée à la police.";
            return;
        }

        newHistFonction.Id = PolicierService.GenerateUniqueId();
        HistFonctions.Add(newHistFonction);
        CancelAddHistFonction();
    }

    private void RemoveHistFonction(int index)
    {
        if (index >= 0 && index < HistFonctions.Count)
            HistFonctions.RemoveAt(index);
    }

    // Méthodes pour gérer l'historique des grades
    private void AddHistGradeForm()
    {
        newHistGrade = new HistGrade 
        {
            DateNomination = DateTime.Today.AddDays(-30), // 30 jours par défaut
            DateActe = DateTime.Today.AddDays(-30)
        };
        showAddHistGradeForm = true;
    }

    private void CancelAddHistGrade()
    {
        showAddHistGradeForm = false;
        newHistGrade = new HistGrade 
        {
            DateNomination = DateTime.Today.AddDays(-30), // 30 jours par défaut
            DateActe = DateTime.Today.AddDays(-30)
        };
        errorMessageHistGrade = "";
    }

    private void SaveHistGrade()
    {
        // Réinitialiser le message d'erreur
        errorMessageHistGrade = "";
        
        // Validation des champs obligatoires
        if (string.IsNullOrEmpty(newHistGrade.Intitule) || string.IsNullOrEmpty(newHistGrade.ActeNomination) || 
            newHistGrade.DateNomination == default || newHistGrade.DateActe == default)
        {
            errorMessageHistGrade = "Tous les champs obligatoires doivent être remplis.";
            return;
        }

        // Validation des dates
        if (newHistGrade.DateNomination > DateTime.Now || newHistGrade.DateActe > DateTime.Now)
        {
            errorMessageHistGrade = "Les dates ne peuvent pas être dans le futur.";
            return;
        }

        // Validation métier : La date de nomination ne peut pas être avant l'entrée à la police
        if (Policier.DateEntreePolice != default && newHistGrade.DateNomination < Policier.DateEntreePolice)
        {
            errorMessageHistGrade = "La date de nomination ne peut pas être avant l'entrée à la police.";
            return;
        }

        // Validation métier : La date de l'acte ne peut pas être avant l'entrée à la police
        if (Policier.DateEntreePolice != default && newHistGrade.DateActe < Policier.DateEntreePolice)
        {
            errorMessageHistGrade = "La date de l'acte ne peut pas être avant l'entrée à la police.";
            return;
        }

        newHistGrade.Id = PolicierService.GenerateUniqueId();
        HistGrades.Add(newHistGrade);
        CancelAddHistGrade();
    }

    private void RemoveHistGrade(int index)
    {
        if (index >= 0 && index < HistGrades.Count)
            HistGrades.RemoveAt(index);
    }

    private string GenerateShortId()
    {
        // Générer un ID unique de exactement 10 caractères
        var guid = Guid.NewGuid().ToString("N"); // Format sans tirets
        return guid.Substring(0, 10);
    }

    private void InitializePolicier()
    {
        Policier = new Policier
        {
            Id = GenerateShortId(),
            NumeroNutp = "",
            Nom = "",
            PostNom = "",
            Prenom = "",
            Sexe = "",
            EtatCivil = "",
            DateNaissance = DateTime.Today.AddYears(-25), // 25 ans par défaut
            DateEntreePolice = DateTime.Today.AddYears(-7), // Entrée à la police il y a 7 ans
            DateNomination = null,
            DatePriseFonction = null,
            DateDelivrancePermis = null,
            DateActe = null,
            Matricule = "",
            NatureGrade = "",
            FonctionActuelle = "",
            NomUnite = "",
            UniteMere = "",
            UniteAffectation = "",
            LieuEntreePolice = "",
            LieuAffectation = "",
            DeptBnDistGpt = "",
            BuCielCiatEscDet = "",
            SecPiSciatSousDet = "",
            ActeNominationGrade = "",
            ActeNominationFonction = "",
            Telephone = "",
            NumeroRue = "",
            Rue = "",
            Commune = "",
            VilleNaissance = "",
            PaysNaissance = "",
            VillageOrigine = "",
            ProvinceOrigine = "",
            DistrictOrigine = "",
            TerritoireOrigine = "",
            SecteurOrigine = "",
            GroupeSanguin = "",
            Rhesus = "",
            CategoriePermis = "",
            NumeroPermis = "",
            Photo = "",
            Signature = "",
            Observation = "",
            Jour = "",
            Mois = "",
            Annee = 0,
            IdCommissariat = "",
            Status = "PENDING",
        };
        
        // Initialiser la validation des étapes
        stepValidated.Clear();
        for (int i = 1; i <= totalSteps; i++)
        {
            stepValidated[i] = false;
        }
        
        // Réinitialiser la validation
        ClearValidationErrors();
        
        // Réinitialiser les collections
        Conjoints.Clear();
        Enfants.Clear();
        Formations.Clear();
        Langues.Clear();
        Sports.Clear();
        Distinctions.Clear();
        HistAffectations.Clear();
    }
    
    // Méthodes de gestion des conjoints
    private bool CanAddConjoint()
    {
        var conjointCount = Conjoints.Count + (Policier.Conjoints?.Count ?? 0);
        
        // Si célibataire, on peut ajouter autant de conjoints qu'on veut (pour les tests)
        if (string.IsNullOrEmpty(Policier.EtatCivil) || Policier.EtatCivil == "Célibataire")
        {
            return true;
        }
        
        // Pour les autres états civils, un seul conjoint maximum
        return conjointCount < 1;
    }
    
    private void AddConjointForm() 
    { 
        // Vérifier si on peut ajouter un conjoint
        if (!CanAddConjoint())
        {
            Console.WriteLine("Impossible d'ajouter un autre conjoint : un seul conjoint autorisé pour cet état civil");
            return;
        }
        
        newConjoint = new(); 
        showAddConjointForm = true; 
    }
    
    private void CancelAddConjoint() 
    { 
        showAddConjointForm = false; 
        newConjoint = new(); 
        errorMessageConjoint = "";
    }
    
    private void SaveConjoint() 
    {
        // Réinitialiser le message d'erreur
        errorMessageConjoint = "";
        
        // Validation des champs obligatoires
        if (string.IsNullOrEmpty(newConjoint.Nom) || string.IsNullOrEmpty(newConjoint.Nationalite) || string.IsNullOrEmpty(newConjoint.Profession))
        {
            errorMessageConjoint = "Tous les champs obligatoires doivent être remplis.";
            return;
        }
        
        // Validation de la date de mariage si elle est renseignée
        if (newConjoint.DateMariage.HasValue)
        {
            // Vérifier que la date de mariage n'est pas dans le futur
            if (newConjoint.DateMariage.Value > DateTime.Today)
            {
                errorMessageConjoint = "La date de mariage ne peut pas être dans le futur.";
                return;
            }
            
            // Vérifier que la date de mariage est au moins 14 ans après la naissance du policier
            if (Policier.DateNaissance != default)
            {
                var ageAuMariage = newConjoint.DateMariage.Value.Year - Policier.DateNaissance.Year;
                if (newConjoint.DateMariage.Value < Policier.DateNaissance.AddYears(ageAuMariage))
                {
                    ageAuMariage--;
                }
                
                if (ageAuMariage < 14)
                {
                    errorMessageConjoint = $"Le policier doit avoir au moins 14 ans au moment du mariage. Âge calculé: {ageAuMariage} ans.";
                    return;
                }
            }
        }
        
            newConjoint.Id = PolicierService.GenerateUniqueId();
            Conjoints.Add(newConjoint);
            CancelAddConjoint();
    }
    
    private void RemoveConjoint(int index) 
    { 
        if (index >= 0 && index < Conjoints.Count) 
            Conjoints.RemoveAt(index); 
    }
    
    // Méthodes de gestion des enfants
    private void AddEnfantForm() 
    { 
        newEnfant = new Enfant 
        {
            DateNaissance = DateTime.Today.AddYears(-10) // 10 ans par défaut
        }; 
        showAddEnfantForm = true; 
    }
    
    private void CancelAddEnfant() 
    { 
        showAddEnfantForm = false; 
        newEnfant = new Enfant 
        {
            DateNaissance = DateTime.Today.AddYears(-10) // 10 ans par défaut
        }; 
        errorMessageEnfant = "";
    }
    
    private void SaveEnfant() 
    {
        // Réinitialiser le message d'erreur
        errorMessageEnfant = "";
        
        // Validation des champs obligatoires
        if (string.IsNullOrEmpty(newEnfant.Nom) || string.IsNullOrEmpty(newEnfant.PaysNaissance) || string.IsNullOrEmpty(newEnfant.VilleNaissance))
        {
            errorMessageEnfant = "Tous les champs obligatoires doivent être remplis.";
            return;
        }
        
        // Validation de l'âge (moins de 18 ans)
        if (newEnfant.DateNaissance != default)
        {
            // Vérifier que la date de naissance n'est pas dans le futur
            if (newEnfant.DateNaissance > DateTime.Today)
            {
                errorMessageEnfant = "La date de naissance ne peut pas être dans le futur.";
                return;
            }
            
            // Calculer l'âge actuel de l'enfant
            var age = DateTime.Today.Year - newEnfant.DateNaissance.Year;
            if (newEnfant.DateNaissance.Date > DateTime.Today.AddYears(-age))
                age--;
                
            if (age >= 18)
            {
                errorMessageEnfant = $"L'enfant doit avoir moins de 18 ans. Âge calculé: {age} ans.";
                return;
            }
            
            // Vérifier que l'enfant est né au moins 14 ans après la naissance du policier
            if (Policier.DateNaissance != default)
            {
                var agePolicierALaNaissanceEnfant = newEnfant.DateNaissance.Year - Policier.DateNaissance.Year;
                if (newEnfant.DateNaissance < Policier.DateNaissance.AddYears(agePolicierALaNaissanceEnfant))
                {
                    agePolicierALaNaissanceEnfant--;
                }
                
                if (agePolicierALaNaissanceEnfant < 14)
                {
                    errorMessageEnfant = $"Le policier doit avoir au moins 14 ans à la naissance de l'enfant. Âge du policier à la naissance: {agePolicierALaNaissanceEnfant} ans.";
                    return;
                }
            }
        }
        
        newEnfant.Id = PolicierService.GenerateUniqueId();
        Enfants.Add(newEnfant);
        CancelAddEnfant();
    }
    
    private void RemoveEnfant(int index) 
    { 
        if (index >= 0 && index < Enfants.Count) 
            Enfants.RemoveAt(index); 
    }
    
    // Méthodes de gestion des formations
    private void AddFormationForm() 
    { 
        newFormation = new(); 
        showAddFormationForm = true; 
    }
    
    private void CancelAddFormation() 
    { 
        showAddFormationForm = false; 
        newFormation = new(); 
        errorMessageFormation = "";
    }
    
    private void ValidateFormationYear()
    {
        // Effacer l'erreur précédente
        ClearValidationError("FormationYear");
        
        // Vérifier si l'année est valide
        if (newFormation.Annee > 0 && Policier.DateNaissance != default)
        {
            var anneeNaissance = Policier.DateNaissance.Year;
            var anneeActuelle = DateTime.Now.Year;
            
            if (newFormation.Annee <= anneeNaissance)
            {
                AddValidationError("FormationYear", $"L'année d'études ({newFormation.Annee}) doit être supérieure à l'année de naissance ({anneeNaissance})");
            }
            else if (newFormation.Annee > anneeActuelle)
            {
                AddValidationError("FormationYear", $"L'année d'études ({newFormation.Annee}) ne peut pas être dans le futur");
            }
        }
    }
    
    private void SaveFormation() 
    {
        // Réinitialiser le message d'erreur
        errorMessageFormation = "";
        
        // Validation des champs obligatoires
        if (string.IsNullOrEmpty(newFormation.TypeFormation))
        {
            errorMessageFormation = "Le type de formation est obligatoire.";
            return;
        }
        
        if (string.IsNullOrEmpty(newFormation.Ecole) || string.IsNullOrEmpty(newFormation.Pays) || 
            string.IsNullOrEmpty(newFormation.Ville) || string.IsNullOrEmpty(newFormation.Diplome) ||
            string.IsNullOrEmpty(newFormation.NomDiplome) || string.IsNullOrEmpty(newFormation.Duree) ||
            string.IsNullOrEmpty(newFormation.Nature))
        {
            errorMessageFormation = "Tous les champs obligatoires doivent être remplis.";
            return;
        }
        
        // Validation de l'année (vérification de base)
        if (newFormation.Annee < 1900 || newFormation.Annee > DateTime.Now.Year)
        {
            errorMessageFormation = "L'année d'études n'est pas valide.";
            return;
        }
        
        // Validation de l'année par rapport à la date de naissance et l'année actuelle
        if (Policier.DateNaissance != default)
        {
            var anneeNaissance = Policier.DateNaissance.Year;
            var anneeActuelle = DateTime.Now.Year;
            
            if (newFormation.Annee <= anneeNaissance)
            {
                errorMessageFormation = $"L'année d'études ({newFormation.Annee}) doit être supérieure à l'année de naissance ({anneeNaissance}).";
                return;
            }
            else if (newFormation.Annee > anneeActuelle)
            {
                errorMessageFormation = $"L'année d'études ({newFormation.Annee}) ne peut pas être dans le futur.";
                return;
            }
        }
        
        // Validation des longueurs de champs
        if (newFormation.Duree.Length > 20)
        {
            errorMessageFormation = "La durée ne peut pas dépasser 20 caractères.";
            return;
        }
        
        if (newFormation.Nature.Length > 20)
        {
            errorMessageFormation = "La nature ne peut pas dépasser 20 caractères.";
            return;
        }
        
        newFormation.Id = PolicierService.GenerateUniqueId();
        Formations.Add(newFormation);
        CancelAddFormation();
    }
    
    private void RemoveFormation(int index) 
    { 
        if (index >= 0 && index < Formations.Count) 
            Formations.RemoveAt(index); 
    }

    // Méthode de sauvegarde complète avec indicateur de progression
    private async Task SubmitForm()
    {
        try
        {
            IsSubmitting = true;
            saveStep = 0;
            
            // Étape 1: Validation finale
            saveProgress = "Validation des données...";
            saveStep = 1;
            StateHasChanged();
            await Task.Delay(100); // Permet à l'UI de se mettre à jour
            
            if (!ValidateAllSteps())
            {
                IsSubmitting = false;
                saveProgress = "";
                return;
            }
            
            // Étape 2: Sauvegarde du policier
            saveProgress = "Enregistrement du policier...";
            saveStep = 2;
            StateHasChanged();
            await Task.Delay(100);
            
            // Générer les IDs pour toutes les collections avant sauvegarde
            foreach (var conjoint in Conjoints)
            {
                if (string.IsNullOrEmpty(conjoint.Id))
                    conjoint.Id = PolicierService.GenerateUniqueId();
            }
            
            foreach (var enfant in Enfants)
            {
                if (string.IsNullOrEmpty(enfant.Id))
                    enfant.Id = PolicierService.GenerateUniqueId();
            }
            
            foreach (var formation in Formations)
            {
                if (string.IsNullOrEmpty(formation.Id))
                    formation.Id = PolicierService.GenerateUniqueId();
            }
            
            foreach (var langue in Langues)
            {
                if (string.IsNullOrEmpty(langue.Id))
                    langue.Id = PolicierService.GenerateUniqueId();
            }
            
            foreach (var sport in Sports)
            {
                if (string.IsNullOrEmpty(sport.Id))
                    sport.Id = PolicierService.GenerateUniqueId();
            }
            
            foreach (var distinction in Distinctions)
            {
                if (string.IsNullOrEmpty(distinction.Id))
                    distinction.Id = PolicierService.GenerateUniqueId();
            }
            
            foreach (var histAffectation in HistAffectations)
            {
                if (string.IsNullOrEmpty(histAffectation.Id))
                    histAffectation.Id = PolicierService.GenerateUniqueId();
            }
            
            foreach (var histFonction in HistFonctions)
            {
                if (string.IsNullOrEmpty(histFonction.Id))
                    histFonction.Id = PolicierService.GenerateUniqueId();
            }
            
            foreach (var histGrade in HistGrades)
            {
                if (string.IsNullOrEmpty(histGrade.Id))
                    histGrade.Id = PolicierService.GenerateUniqueId();
            }
            
            foreach (var personne in PersonnesAPrevenir)
            {
                if (string.IsNullOrEmpty(personne.Id))
                    personne.Id = PolicierService.GenerateUniqueId();
            }

            // Assigner les collections au policier après génération des IDs
            Policier.Conjoints = Conjoints;
            Policier.Enfants = Enfants;
            Policier.Formations = Formations;
            Policier.Langues = Langues;
            Policier.Sports = Sports;
            Policier.DistinctionHonorifiques = Distinctions;
            Policier.HistAffectations = HistAffectations;
            Policier.HistFonctions = HistFonctions;
            Policier.HistGrades = HistGrades;
            Policier.PersonnePrevenirs = PersonnesAPrevenir;
            
            // Assigner le territoire/commune sélectionné à la propriété Commune du policier
            Policier.Commune = TerritoireCommissariat;
            
            // Sauvegarde du policier principal
            var savedPolicier = IsEdit 
                ? await PolicierService.UpdatePolicierAsync(Policier)
                : await PolicierService.CreatePolicierAsync(Policier);
            
            if (savedPolicier == null)
            {
                throw new Exception("Erreur lors de la sauvegarde du policier");
            }
            
            var policierId = savedPolicier.Id;
            
            // Gestion des images : déplacer vers le bon dossier si c'est un nouveau policier
            if (!IsEdit && !string.IsNullOrEmpty(Policier.Photo))
            {
                try
                {
                    // L'image est actuellement dans un dossier temporaire (Nouveau_0)
                    // On doit la déplacer vers le bon dossier avec l'ID définitif
                    string oldPath = Policier.Photo;
                    string newPath = await ImageStorageService.SavePolicierImageAsync(
                        await GetImageDataUrlFromPath(oldPath), 
                        
                        policierId, 
                        savedPolicier.Nom ?? "Policier"
                    );
                    
                    // Mettre à jour le chemin dans la base de données
                    savedPolicier.Photo = newPath;
                    await PolicierService.UpdatePolicierAsync(savedPolicier);
                    
                    // Supprimer l'ancienne image temporaire
                    await ImageStorageService.DeletePolicierImageAsync(oldPath);
                    
                    Console.WriteLine($"Image déplacée de {oldPath} vers {newPath}");
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Erreur lors du déplacement de l'image: {ex.Message}");
                    // Ne pas bloquer la sauvegarde si le déplacement de l'image échoue
                }
            }
            
            // Étape 3: Finalisation de la sauvegarde
            saveProgress = "Finalisation de l'enregistrement...";
            saveStep = 3;
            StateHasChanged();
            await Task.Delay(100);
            
            // Finalisation
            saveProgress = "Enregistrement terminé !";
            StateHasChanged();
            await Task.Delay(500);
            
            // Redirection pour capturer la photo
          
             Navigation.NavigateTo($"/policiers/capture-photo/{policierId}");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Erreur lors de l'enregistrement: {ex.Message}");
            saveProgress = $"Erreur: {ex.Message}";
            await Task.Delay(2000);
        }
        finally
        {
            IsSubmitting = false;
            saveProgress = "";
            saveStep = 0;
            StateHasChanged();
        }
    }

    
    // Validation de toutes les étapes
    private bool ValidateAllSteps()
    {
        for (int step = 1; step <= totalSteps; step++)
        {
            if (!ValidateCurrentStep(step))
            {
                currentStep = step; // Revenir à l'étape invalide
                StateHasChanged();
                return false;
            }
        }
        return true;
    }
    
    // Surcharge de ValidateCurrentStep pour accepter un paramètre
    private bool ValidateCurrentStep(int step)
    {
        return step switch
        {
            1 => ValidateStep1New(),
            2 => ValidateStep2New(),
            3 => ValidateStep3(),
            4 => ValidateStep4(),
            5 => ValidateStep5(),
            6 => ValidateStep6(),
            7 => ValidateStep7(),
            8 => ValidateStep8(),
            9 => ValidateStep9(),
            10 => ValidateStep10(),
            11 => ValidateStep11(),
            12 => ValidateStep12(),
            13 => ValidateStep13(),
            14 => ValidateStep14(),
            _ => false
        };
    }

    // Méthodes de gestion de la caméra intégrée
    private async Task StartCamera()
    {
        try
        {
            cameraErrorMessage = string.Empty;
            StateHasChanged();

            // Attendre que l'élément vidéo soit rendu
            await Task.Delay(100);

            Console.WriteLine("Initialisation/Réinitialisation des caméras...");

            // Tester d'abord la caméra
            try
            {
                var testResult = await JSRuntime.InvokeAsync<bool>("testCamera");
                Console.WriteLine($"Test de la caméra: {(testResult ? "Succès" : "Échec")}");
            }
            catch (Exception testEx)
            {
                Console.WriteLine($"Erreur lors du test de la caméra: {testEx.Message}");
            }

            // Arrêter la caméra si elle est active
            if (isCameraActive)
            {
                await JSRuntime.InvokeVoidAsync("stopCamera");
                isCameraActive = false;
                Console.WriteLine("Caméra précédente arrêtée");
            }

            // Créer le sélecteur de caméra
            await JSRuntime.InvokeVoidAsync("createCameraSelector", "camera-selector-container");
            Console.WriteLine("Sélecteur de caméra initialisé/réinitialisé");
            
            cameraInitialized = true;
            StateHasChanged(); // Mettre à jour l'interface immédiatement
            
            // Vérifier l'état de la caméra après un délai
            await Task.Delay(500);
            await CheckCameraState();
            
            // Ne pas démarrer la caméra automatiquement, laisser l'utilisateur choisir
            Console.WriteLine("Veuillez sélectionner une caméra dans la liste");
            
            // Si on est à l'étape 13 (Documents), afficher un message spécifique
            if (currentStep == 13)
            {
                Console.WriteLine("Capture d'image dans l'étape Documents - Prêt pour la sélection de caméra");
            }
        }
        catch (Exception ex)
        {
            cameraErrorMessage = $"Erreur lors de l'initialisation de la caméra : {ex.Message}";
            Console.WriteLine($"Exception lors de l'initialisation: {ex.Message}");
            StateHasChanged();
        }
    }

    private async Task CapturePhoto()
    {
        try
        {
            Console.WriteLine("Début de la capture de photo...");
            
            // Vérifier si la caméra est active
            if (!isCameraActive)
            {
                cameraErrorMessage = "Veuillez d'abord sélectionner et activer une caméra";
                Console.WriteLine("Tentative de capture sans caméra active");
                return;
            }
            
            // Utiliser la nouvelle fonction simplifiée
            await JSRuntime.InvokeVoidAsync("capturePhoto", "policierVideo", "policierPhoto");
            
            // Récupérer la photo depuis l'élément img
            var photoDataUrl = await JSRuntime.InvokeAsync<string>("getElementSrc", "policierPhoto");
            Console.WriteLine($"Photo récupérée, longueur: {photoDataUrl?.Length ?? 0}");
            
            if (!string.IsNullOrEmpty(photoDataUrl) && photoDataUrl.Length > 100)
            {
                try
                {
                    // Sauvegarder la photo capturée pour la persistance
                    capturedPhotoDataUrl = photoDataUrl;
                    
                    string tempId = IsEdit ? Policier.Id : "";
                    string tempName = !string.IsNullOrEmpty(Policier.Nom) ? Policier.Nom : "Nouveau";
                    
                    string imagePath = await ImageStorageService.SavePolicierImageAsync(photoDataUrl, tempId, tempName);
                    
                    Policier.Photo = imagePath;
                    
                    Console.WriteLine($"Image sauvegardée dans: {imagePath}");
                    Console.WriteLine($"Chemin stocké dans Policier.Photo: {Policier.Photo}");
                    
                    await InvokeAsync(StateHasChanged);
                    Console.WriteLine("Interface mise à jour avec la photo");
                    
                    // Arrêter la caméra après la capture
                        await StopCamera();
                    
                    Console.WriteLine("Photo capturée et sauvegardée avec succès");
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Erreur lors de la sauvegarde de l'image: {ex.Message}");
                    cameraErrorMessage = $"Erreur lors de la sauvegarde de l'image : {ex.Message}";
                }
            }
            else
            {
                Console.WriteLine("Photo invalide ou trop courte");
                cameraErrorMessage = "Erreur lors de la capture de la photo";
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Exception lors de la capture: {ex.Message}");
            cameraErrorMessage = $"Erreur lors de la capture de la photo : {ex.Message}";
        }
        finally
        {
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task StopCamera()
    {
        try
        {
            Console.WriteLine("Début de l'arrêt de la caméra...");
            
            // Vérifier si la caméra est active
            if (!isCameraActive)
            {
                cameraErrorMessage = "Aucune caméra active à arrêter";
                Console.WriteLine("Tentative d'arrêt sans caméra active");
                return;
            }
            
            // Arrêter la caméra avec la nouvelle fonction simplifiée
            await JSRuntime.InvokeVoidAsync("stopCamera");
            Console.WriteLine("Caméra arrêtée avec succès");
            
            // Cacher l'espace de vue de la caméra
            isCameraActive = false;
            cameraErrorMessage = string.Empty;
            
            // Mettre à jour l'interface pour cacher la vidéo
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Exception lors de l'arrêt de la caméra: {ex.Message}");
            cameraErrorMessage = $"Erreur lors de l'arrêt de la caméra : {ex.Message}";
        }
        finally
        {
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task RetakePhoto()
    {
        try
        {
            // Supprimer l'ancienne image si elle existe
            if (!string.IsNullOrEmpty(Policier.Photo))
            {
                await ImageStorageService.DeletePolicierImageAsync(Policier.Photo);
                Console.WriteLine($"Ancienne image supprimée: {Policier.Photo}");
            }
            
            // Vider le champ Photo
            Policier.Photo = string.Empty;
            
            // Redémarrer la caméra
            await StartCamera();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Erreur lors de la suppression de l'ancienne image: {ex.Message}");
            // Continuer même si la suppression échoue
            Policier.Photo = string.Empty;
            await StartCamera();
        }
    }

    private async Task RemovePhoto()
    {
        try
        {
            // Supprimer le fichier physique s'il existe
            if (!string.IsNullOrEmpty(Policier.Photo))
            {
                await ImageStorageService.DeletePolicierImageAsync(Policier.Photo);
                Console.WriteLine($"Fichier image supprimé: {Policier.Photo}");
            }
            
            // Vider le champ Photo
            Policier.Photo = string.Empty;
            await InvokeAsync(StateHasChanged);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Erreur lors de la suppression de l'image: {ex.Message}");
            // Continuer même si la suppression du fichier échoue
            Policier.Photo = string.Empty;
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task<string> GetImageDataUrlFromPath(string imagePath)
    {
        try
        {
            if (string.IsNullOrEmpty(imagePath))
                return string.Empty;

            string fullPath = Path.Combine(_environment.WebRootPath, imagePath);
            if (!File.Exists(fullPath))
                return string.Empty;

            byte[] imageBytes = await File.ReadAllBytesAsync(fullPath);
            string base64 = Convert.ToBase64String(imageBytes);
            
            // Déterminer le type MIME basé sur l'extension
            string extension = Path.GetExtension(imagePath).ToLowerInvariant();
            string mimeType = extension switch
            {
                ".jpg" or ".jpeg" => "image/jpeg",
                ".png" => "image/png",
                ".gif" => "image/gif",
                _ => "image/jpeg"
            };
            
            return $"data:{mimeType};base64,{base64}";
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Erreur lors de la lecture de l'image: {ex.Message}");
            return string.Empty;
        }
    }

    private async Task RognerPhoto()
    {
        try
        {
            Console.WriteLine("Début du rognage de la photo...");
            
            // Utiliser la fonction de rognage JavaScript
            var photoRognee = await JSRuntime.InvokeAsync<string>("cropPhoto", "policierPhoto", "policierPhoto");
            
            if (!string.IsNullOrEmpty(photoRognee))
            {
                try
                {
                    string tempId = IsEdit ? Policier.Id : "";
                    string tempName = !string.IsNullOrEmpty(Policier.Nom) ? Policier.Nom : "Nouveau";
                    
                    // Sauvegarder la photo rognée
                    string imagePath = await ImageStorageService.SavePolicierImageAsync(photoRognee, tempId, tempName);
                    
                    Policier.Photo = imagePath;
                    
                    Console.WriteLine($"Photo rognée sauvegardée dans: {imagePath}");
                    
                    await InvokeAsync(StateHasChanged);
                    Console.WriteLine("Photo rognée et sauvegardée avec succès");
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Erreur lors de la sauvegarde de la photo rognée: {ex.Message}");
                    cameraErrorMessage = $"Erreur lors de la sauvegarde de la photo rognée : {ex.Message}";
                }
            }
            else
            {
                Console.WriteLine("Erreur lors du rognage de la photo");
                cameraErrorMessage = "Erreur lors du rognage de la photo";
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Exception lors du rognage: {ex.Message}");
            cameraErrorMessage = $"Erreur lors du rognage de la photo : {ex.Message}";
        }
        finally
        {
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task RecapturerPhoto()
    {
        try
        {
            Console.WriteLine("Début de la reprise de photo...");
            
            // Effacer la photo actuelle
            Policier.Photo = string.Empty;
            capturedPhotoDataUrl = string.Empty;
            
            // Réinitialiser l'état de la caméra
            isCameraActive = false;
            cameraInitialized = false;
            
            // Utiliser StartCamera pour réinitialiser complètement
            await StartCamera();
            
            Console.WriteLine("Prêt pour une nouvelle capture de photo");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Exception lors de la reprise de photo: {ex.Message}");
            cameraErrorMessage = $"Erreur lors de la reprise de photo : {ex.Message}";
        }
    }

    [JSInvokable]
    public async Task OnCameraActive()
    {
        try
        {
            Console.WriteLine("Caméra activée depuis JavaScript");
            isCameraActive = true;
            // Utiliser StateHasChanged directement au lieu de InvokeAsync
            StateHasChanged();
            Console.WriteLine("État de la caméra mis à jour: isCameraActive = true");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Erreur lors de la mise à jour de l'état de la caméra: {ex.Message}");
            Console.WriteLine($"Stack trace: {ex.StackTrace}");
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Afficher le nom de l'assembly pour le débogage
            var assemblyName = System.Reflection.Assembly.GetExecutingAssembly().GetName().Name;
            Console.WriteLine($"🔍 Nom de l'assembly: {assemblyName}");
            
            // Configurer un événement DOM pour la communication JavaScript-Blazor
            await JSRuntime.InvokeVoidAsync("eval", @"
                // Créer un événement personnalisé pour la communication
                window.cameraStateManager = {
                    setCameraActive: function() {
                        console.log('Événement cameraActive déclenché');
                        const event = new CustomEvent('cameraActive', { detail: { active: true } });
                        document.dispatchEvent(event);
                    }
                };
                
                // Écouter l'événement cameraActive
                document.addEventListener('cameraActive', function(event) {
                    console.log('🔄 Événement cameraActive reçu:', event.detail);
                    // Marquer la caméra comme active
                    window.cameraActive = true;
                });
            ");
            
            // Démarrer la vérification périodique de l'état de la caméra
            _ = StartCameraStateCheck();
        }
        
        // Restaurer l'état de la caméra si nécessaire (seulement à l'étape 13)
        if (!firstRender && cameraInitialized && !isCameraActive && currentStep == 13)
        {
            await RestoreCameraState();
        }
    }

    private async Task RestoreCameraState()
    {
        try
        {
            Console.WriteLine("Restauration de l'état de la caméra...");
            
            // Restaurer le sélecteur de caméra seulement si pas de photo et qu'on est à l'étape 13
            if (cameraInitialized && string.IsNullOrEmpty(Policier.Photo) && currentStep == 13)
            {
                await JSRuntime.InvokeVoidAsync("createCameraSelector", "camera-selector-container");
                Console.WriteLine("Sélecteur de caméra restauré pour l'étape Documents");
            }
            
            // Restaurer la photo capturée si elle existe
            if (!string.IsNullOrEmpty(capturedPhotoDataUrl))
            {
                await JSRuntime.InvokeVoidAsync("restoreCapturedPhoto", "policierPhoto", capturedPhotoDataUrl);
                Console.WriteLine("Photo capturée restaurée");
            }
            
            // Restaurer la photo dans le modèle si elle existe
            if (!string.IsNullOrEmpty(Policier.Photo))
            {
                Console.WriteLine($"Photo du modèle restaurée: {Policier.Photo}");
                // La photo sera affichée automatiquement par le HTML
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Erreur lors de la restauration de l'état de la caméra: {ex.Message}");
        }
    }

    private async Task CheckCameraState()
    {
        try
        {
            var isActive = await JSRuntime.InvokeAsync<bool>("eval", "window.cameraActive || false");
            if (isActive != isCameraActive)
            {
                isCameraActive = isActive;
                Console.WriteLine($"État de la caméra mis à jour: {isCameraActive}");
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Erreur lors de la vérification de l'état de la caméra: {ex.Message}");
        }
    }

    private async Task StartCameraStateCheck()
    {
        // Vérifier l'état de la caméra toutes les 500ms
        while (true)
        {
            await CheckCameraState();
            await Task.Delay(500);
        }
    }
}
