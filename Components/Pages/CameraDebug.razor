@page "/camera-debug"
@using Microsoft.JSInterop
@inject IJSRuntime JSRuntime

<PageTitle>D√©bogage Cam√©ra - PNC</PageTitle>

<div class="camera-debug-page">
    <div class="container">
        <h1>üîç D√©bogage de la Cam√©ra</h1>
        <p class="description">Page de diagnostic pour r√©soudre les probl√®mes de cam√©ra</p>
        
        <div class="debug-sections">
            <!-- Section 1: V√©rification de l'environnement -->
            <div class="debug-section">
                <h3>üåê V√©rification de l'Environnement</h3>
                <div class="debug-info">
                    <p><strong>Navigateur:</strong> <span id="browserInfo">V√©rification...</span></p>
                    <p><strong>HTTPS:</strong> <span id="httpsStatus">V√©rification...</span></p>
                    <p><strong>API MediaDevices:</strong> <span id="mediaDevicesStatus">V√©rification...</span></p>
                    <p><strong>Permissions API:</strong> <span id="permissionsStatus">V√©rification...</span></p>
                </div>
            </div>
            <!-- Section 2: Test de la cam√©ra -->
            <div class="debug-section">
                <h3>üìπ Test de la Cam√©ra</h3>
                <div class="camera-test">
                    <video id="debugVideo" autoplay playsinline style="width: 100%; max-width: 400px; border: 2px solid #ddd; background-color: #000;"></video>
                    <br>
                    <button class="btn-modern btn-primary" @onclick="TestCamera">
                        <i class="bi bi-camera"></i>Tester la Cam√©ra
                    </button>
                    <button class="btn-modern btn-secondary" @onclick="ListCameras">
                        <i class="bi bi-list"></i>Lister les Cam√©ras
                    </button>
                </div>
            </div>

            <!-- Section 3: Logs de d√©bogage -->
            <div class="debug-section">
                <h3>üìã Logs de D√©bogage</h3>
                <div class="debug-logs" id="debugLogs">
                    <p class="log-entry">üöÄ Page de d√©bogage charg√©e</p>
                </div>
                <button class="btn-modern btn-outline" @onclick="ClearLogs">
                    <i class="bi bi-trash"></i> Effacer les Logs
                </button>
            </div>

            <!-- Section 4: Informations syst√®me -->
            <div class="debug-section">
                <h3>üíª Informations Syst√®me</h3>
                <div class="system-info" id="systemInfo">
                    <p>Chargement des informations...</p>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await CheckEnvironment();
            await GetSystemInfo();
        }
    }

    private async Task CheckEnvironment()
    {
        try
        {
            // V√©rifier l'environnement
            var browserInfo = await JSRuntime.InvokeAsync<string>("getBrowserInfo");
            var httpsStatus = await JSRuntime.InvokeAsync<bool>("isHttps");
            var mediaDevicesStatus = await JSRuntime.InvokeAsync<bool>("isMediaDevicesAvailable");
            var permissionsStatus = await JSRuntime.InvokeAsync<bool>("isPermissionsAvailable");

            // Mettre √† jour l'interface
            await JSRuntime.InvokeVoidAsync("updateDebugInfo", "browserInfo", browserInfo);
            await JSRuntime.InvokeVoidAsync("updateDebugInfo", "httpsStatus", httpsStatus ? "‚úÖ Oui" : "‚ùå Non");
            await JSRuntime.InvokeVoidAsync("updateDebugInfo", "mediaDevicesStatus", mediaDevicesStatus ? "‚úÖ Disponible" : "‚ùå Non disponible");
            await JSRuntime.InvokeVoidAsync("updateDebugInfo", "permissionsStatus", permissionsStatus ? "‚úÖ Disponible" : "‚ùå Non disponible");

            await AddLog($"üåê Environnement v√©rifi√© - Navigateur: {browserInfo}");
        }
        catch (Exception ex)
        {
            await AddLog($"‚ùå Erreur lors de la v√©rification: {ex.Message}");
        }
    }

    private async Task TestCamera()
    {
        try
        {
            await AddLog("üìπ Test de la cam√©ra d√©marr√©...");
            
            var success = await JSRuntime.InvokeAsync<bool>("testCameraDebug");
            
            if (success)
            {
                await AddLog("‚úÖ Test de la cam√©ra r√©ussi");
            }
            else
            {
                await AddLog("‚ùå Test de la cam√©ra √©chou√©");
            }
        }
        catch (Exception ex)
        {
            await AddLog($"‚ùå Erreur lors du test: {ex.Message}");
        }
    }

    private async Task ListCameras()
    {
        try
        {
            await AddLog("üìã R√©cup√©ration de la liste des cam√©ras...");
            
            var cameras = await JSRuntime.InvokeAsync<string>("listCamerasDebug");
            
            if (!string.IsNullOrEmpty(cameras))
            {
                await AddLog($"üìπ Cam√©ras trouv√©es: {cameras}");
            }
            else
            {
                await AddLog("‚ùå Aucune cam√©ra trouv√©e");
            }
        }
        catch (Exception ex)
        {
            await AddLog($"‚ùå Erreur lors de la liste: {ex.Message}");
        }
    }

    private async Task GetSystemInfo()
    {
        try
        {
            var systemInfo = await JSRuntime.InvokeAsync<string>("getSystemInfo");
            await JSRuntime.InvokeVoidAsync("updateSystemInfo", systemInfo);
            await AddLog("üíª Informations syst√®me r√©cup√©r√©es");
        }
        catch (Exception ex)
        {
            await AddLog($"‚ùå Erreur informations syst√®me: {ex.Message}");
        }
    }

    private async Task AddLog(string message)
    {
        await JSRuntime.InvokeVoidAsync("addDebugLog", message);
    }

    private async Task ClearLogs()
    {
        await JSRuntime.InvokeVoidAsync("clearDebugLogs");
        await AddLog("üóëÔ∏è Logs effac√©s");
    }
}
